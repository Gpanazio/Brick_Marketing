<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- Build: 2026-02-07T11:17:00-03:00 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRICK AI // WAR ROOM</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23000'/><text x='50' y='75' font-size='70' text-anchor='middle' fill='%23DC2626' font-family='monospace' font-weight='bold'>B</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --brick-red: #DC2626; --brick-black: #000; --brick-white: #FFF; --brick-gray: #111; }
        body { background-color: var(--brick-black); color: var(--brick-white); font-family: 'Inter', sans-serif; overflow: hidden; margin: 0; height: 100vh; }
        .font-brick { font-family: 'Inter', sans-serif; font-weight: 900; letter-spacing: -0.05em; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* THE FAVORITE BACKGROUND */
        .grid-bg {
            position: fixed; inset: 0;
            background-image:
                radial-gradient(circle at 50% 50%, rgba(220, 38, 38, 0.12) 0%, transparent 60%),
                linear-gradient(rgba(255, 255, 255, 0.015) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.015) 1px, transparent 1px);
            background-size: 100% 100%, 50px 50px, 50px 50px;
            pointer-events: none; z-index: -1;
        }
        .vignette {
            position: fixed; inset: 0;
            background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.85) 100%);
            pointer-events: none; z-index: -1;
        }

        /* NODE STYLING (MATCHING IMAGE) */
        .node {
            position: absolute !important; width: 320px;
            background: rgba(5, 5, 5, 0.9); border: 1px solid #222;
            padding: 24px; cursor: move; z-index: 10;
            transition: border-color 0.3s;
        }
        .node:hover { border-color: #444; }
        .node.node-douglas { border: 1px solid var(--brick-red); box-shadow: 0 0 20px rgba(220, 38, 38, 0.2); }
        .node.disabled { opacity: 0.3; filter: grayscale(1); }

        .node-led { position: absolute; top: 10px; right: 10px; width: 4px; height: 4px; background: var(--brick-red); border-radius: 50%; box-shadow: 0 0 8px var(--brick-red); }
        .disabled .node-led { background: #333; box-shadow: none; }
        .node[data-provider="openai"] { border-left: 2px solid #10a37f; }
        .node[data-provider="openai"] .node-led { background: #10a37f; box-shadow: 0 0 8px #10a37f; }
        .node[data-provider="openai"] .node-subtext { color: #10a37f; }
        .node[data-provider="gemini-flash"] { border-left: 2px solid #4285f4; }
        .node[data-provider="gemini-flash"] .node-led { background: #4285f4; box-shadow: 0 0 8px #4285f4; }
        .node[data-provider="gemini-flash"] .node-subtext { color: #4285f4; }
        .node[data-provider="gemini-pro"] { border-left: 2px solid #00bcd4; }
        .node[data-provider="gemini-pro"] .node-led { background: #00bcd4; box-shadow: 0 0 8px #00bcd4; }
        .node[data-provider="gemini-pro"] .node-subtext { color: #00bcd4; }
        .node[data-provider="sonnet"] { border-left: 2px solid #d97706; }
        .node[data-provider="sonnet"] .node-led { background: #d97706; box-shadow: 0 0 8px #d97706; }
        .node[data-provider="sonnet"] .node-subtext { color: #d97706; }
        .node[data-provider="opus"] { border-left: 2px solid #9333ea; }
        .node[data-provider="opus"] .node-led { background: #9333ea; box-shadow: 0 0 8px #9333ea; }
        .node[data-provider="opus"] .node-subtext { color: #9333ea; }
        .node[data-provider="human"] { border-left: 2px solid #fff; }
        .node[data-provider="human"] .node-led { background: #fff; box-shadow: 0 0 8px #fff; }
        .node[data-provider="human"] .node-subtext { color: #fff; }
        .node[data-provider="revision"] { border-left: 2px solid #f97316; border: 2px solid #f97316; background: rgba(249, 115, 22, 0.05); }
        .node[data-provider="revision"] .node-led { background: #f97316; box-shadow: 0 0 12px #f97316; animation: pulse-revision 2s ease-in-out infinite; }
        .node[data-provider="revision"] .node-subtext { color: #f97316; }
        .node[data-provider="revision"] .node-title { color: #f97316; }
        @keyframes pulse-revision { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        /* Rerun & Loop nodes (Dynamic nodes styling) */
        .node[data-provider="rerun"] { border: 2px solid #3b82f6; background: rgba(59, 130, 246, 0.05); }
        .node[data-provider="rerun"] .node-led { background: #3b82f6; box-shadow: 0 0 12px #3b82f6; }
        .node[data-provider="rerun"] .node-subtext { color: #3b82f6; }
        .node[data-provider="rerun"] .node-title { color: #3b82f6; }

        .node[data-provider="loop-wall"], .node[data-provider="loop-copy"], .node[data-provider="loop-exec"], .node[data-provider="loop-dir"], .node[data-provider="loop-prop"] { 
            border: 1px solid #f97316; 
            background: rgba(249, 115, 22, 0.02);
        }
        .node[data-provider*="loop"] .node-led { background: #f97316; box-shadow: 0 0 8px #f97316; }
        .node[data-provider*="loop"] .node-subtext { color: #f97316; }
        .node[data-provider*="loop"] .node-title { color: #f97316; }
        .disabled[data-provider] { border-left-color: #222 !important; }
        .disabled[data-provider] .node-subtext { color: #333 !important; }

        .node-id { font-family: 'JetBrains Mono'; font-size: 8px; color: #444; margin-bottom: 8px; letter-spacing: 0.1em; }
        .node-title { font-family: 'Inter'; font-weight: 900; font-size: 18px; color: #fff; text-transform: uppercase; letter-spacing: -0.02em; line-height: 1.2; }
        .node-subtext { font-family: 'JetBrains Mono'; font-size: 8px; color: #444; margin-top: 12px; text-transform: uppercase; letter-spacing: 0.1em; border-top: 1px solid #111; padding-top: 12px; }

        /* ANGULAR CONNECTIONS */
        .conn-line { fill: none; stroke: var(--brick-red); stroke-width: 1; opacity: 0.2; }
        .conn-line.active { opacity: 0.6; stroke-width: 1.5; }

        .pulse-dot { fill: var(--brick-red); filter: drop-shadow(0 0 3px var(--brick-red)); }

        /* SIDE PANEL */
        .side-panel { position: fixed; top: 0; right: -500px; width: 450px; height: 100vh; background: #050505; border-left: 1px solid #222; z-index: 250; transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .side-panel.open { right: 0; }

        /* INTERFACE ELEMENTS */
        .btn-brick { background: var(--brick-red); color: #fff; font-family: 'Inter'; font-weight: 900; font-size: 11px; padding: 8px 16px; text-transform: uppercase; letter-spacing: 0.1em; transition: all 0.2s; }
        .btn-brick:hover { background: #fff; color: #000; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #222; }

        #view-nodegraphic { display: none; }
        #view-nodegraphic.active { display: block; }

        /* REVISION SYSTEM */
        .revision-badge {
            display: inline-flex; align-items: center; gap: 6px;
            font-family: 'JetBrains Mono'; font-size: 9px;
            text-transform: uppercase; letter-spacing: 0.1em; padding: 4px 10px;
        }
        .revision-badge.pending { color: #f97316; border: 1px solid #f97316; animation: pulse-badge 2s ease-in-out infinite; }
        .revision-badge.approved { color: #3b82f6; border: 1px solid #3b82f6; }
        .revision-badge.feedback-pending { color: #eab308; border: 1px solid #eab308; animation: pulse-badge 2s ease-in-out infinite; }
        @keyframes pulse-badge { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .card-revision-pending {
            border-color: #f97316 !important;
            animation: pulse-border 2s ease-in-out infinite;
        }
        .card-feedback-pending {
            border-color: #eab308 !important;
            animation: pulse-border-yellow 2s ease-in-out infinite;
        }
        @keyframes pulse-border {
            0%, 100% { border-color: #f97316; box-shadow: 0 0 0 rgba(249, 115, 22, 0); }
            50% { border-color: #fb923c; box-shadow: 0 0 15px rgba(249, 115, 22, 0.3); }
        }
        @keyframes pulse-border-yellow {
            0%, 100% { border-color: #eab308; box-shadow: 0 0 0 rgba(234, 179, 8, 0); }
            50% { border-color: #facc15; box-shadow: 0 0 15px rgba(234, 179, 8, 0.2); }
        }
        .diff-added { background: rgba(34, 197, 94, 0.1); border-left: 3px solid #22c55e; padding: 8px 12px; margin: 4px 0; }
        .diff-removed { background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; padding: 8px 12px; margin: 4px 0; text-decoration: line-through; opacity: 0.7; }
        .diff-edit { background: rgba(249, 115, 22, 0.1); border-left: 3px solid #f97316; padding: 8px 12px; margin: 4px 0; }
        .comparison-col { flex: 1; overflow-y: auto; max-height: 50vh; padding: 16px; }
        .comparison-col h4 { font-size: 11px; font-family: 'JetBrains Mono'; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #222; }
        .rev-tab-btn { padding: 8px 16px; font-family: 'JetBrains Mono'; font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; border: 1px solid #222; color: #666; cursor: pointer; transition: all 0.2s; background: transparent; }
        .rev-tab-btn:hover { color: #fff; border-color: #444; }
        .rev-tab-btn.active { color: #DC2626; border-color: #DC2626; background: rgba(220, 38, 38, 0.1); }

        /* MARKDOWN STYLING IN PANEL */
        #panel-body h1 { font-size: 20px; font-weight: 900; color: #fff; margin: 24px 0 12px; text-transform: uppercase; line-height: 1.3; }
        #panel-body h2 { font-size: 16px; font-weight: 700; color: #DC2626; margin: 20px 0 12px; text-transform: uppercase; line-height: 1.3; }
        #panel-body h3 { font-size: 14px; font-weight: 600; color: #888; margin: 16px 0 10px; line-height: 1.4; }
        #panel-body p { margin: 12px 0; line-height: 1.7; color: #aaa; font-size: 14px; }
        #panel-body ul, #panel-body ol { margin: 12px 0; padding-left: 24px; color: #aaa; }
        #panel-body li { margin: 8px 0; font-size: 14px; line-height: 1.6; }
        #panel-body code { background: #0a0a0a; padding: 2px 6px; border-radius: 3px; color: #DC2626; font-size: 12px; }
        #panel-body pre { background: #0a0a0a; border: 1px solid #222; padding: 12px; border-radius: 4px; overflow-x: auto; margin: 12px 0; font-size: 13px; line-height: 1.5; }
        #panel-body pre code { background: transparent; padding: 0; }
        #panel-body strong { color: #fff; font-weight: 700; }
        #panel-body em { color: #DC2626; font-style: italic; }
        #panel-body blockquote { border-left: 2px solid #DC2626; padding-left: 16px; margin: 12px 0; color: #666; font-style: italic; font-size: 14px; line-height: 1.6; }
    </style>
</head>
<body>
    <div class="grid-bg"></div>
    <div class="vignette"></div>

    <!-- MAIN INTERFACE -->
    <div id="main-ui" class="h-screen flex flex-col p-8">
        <header class="flex justify-between items-start mb-12 border-b border-white/5 pb-8 relative z-50">
            <div>
                <h1 class="text-3xl font-brick text-white uppercase tracking-tighter">
                    BRICK AI <span id="header-sector" class="text-[#DC2626] text-sm font-mono tracking-[0.5em] ml-4">COMMAND_CENTER</span>
                </h1>
                <div id="connection-status" class="text-[9px] font-mono text-green-500 mt-2 uppercase tracking-widest">System_Active</div>
            </div>
            <div class="flex gap-4 items-center">
                <button id="btn-back-lobby" onclick="goHome()" class="hidden text-[#444] hover:text-white font-mono text-[10px] uppercase tracking-widest border border-[#222] px-4 py-2">‚Üê Sectors</button>
                <button id="btn-scheme" onclick="openScheme()" class="hidden text-[#666] hover:text-white font-mono text-[10px] uppercase tracking-widest border border-[#222] px-4 py-2 hover:border-[#444]">‚óà Scheme</button>
                <button id="btn-delete-project" onclick="confirmDeleteProject()" class="hidden text-[#666] hover:text-[#DC2626] font-mono text-[10px] uppercase tracking-widest border border-[#222] px-4 py-2 hover:border-[#DC2626]">‚úï Delete</button>
                <div id="layout-indicator" class="hidden text-[10px] font-mono text-green-500/60 tracking-widest">
                    <span id="saved-positions-count">0</span> POSI√á√ïES SALVAS
                </div>
                <button id="btn-clear-layout" onclick="clearLayoutQuick()" class="hidden text-[#666] hover:text-[#DC2626] font-mono text-[9px] uppercase tracking-widest px-3 py-2 hover:underline" title="Limpar TODAS as posi√ß√µes salvas e resetar layout">‚úï Limpar</button>
                <button id="btn-reset-layout" onclick="resetLayout()" class="hidden text-[#DC2626] hover:text-white font-mono text-[10px] uppercase tracking-widest border border-[#DC2626] px-4 py-2 hover:bg-[#DC2626] hover:text-black">‚ü≤ RESET POSI√á√ïES</button>
                <button onclick="openNewBriefing()" class="btn-brick">+ New_Briefing</button>
            </div>
        </header>

        <!-- WELCOME -->
        <div id="welcome-screen" class="flex-1 flex items-center justify-center">
            <div class="w-full max-w-6xl">
                <div class="text-center mb-10 -mt-6">
                    <h1 class="text-6xl font-brick text-white uppercase tracking-tighter">Brick <span class="text-[#DC2626]">War</span> Room</h1>
                    <p class="text-sm font-mono text-[#666] uppercase tracking-[0.3em] mt-3">Creation Center</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full">
                <div onclick="enterMode('marketing')" class="group cursor-pointer border border-[#111] bg-[#050505] p-12 hover:border-[#DC2626] transition-all">
                    <div class="text-[9px] font-mono text-[#444] mb-8">SEC // 01</div>
                    <h3 class="text-3xl font-brick text-white mb-4 uppercase group-hover:text-[#DC2626]">Marketing</h3>
                    <p class="text-[#444] font-mono text-xs uppercase">Content & Flow</p>
                </div>
                <div onclick="enterMode('projetos')" class="group cursor-pointer border border-[#111] bg-[#050505] p-12 hover:border-[#DC2626] transition-all">
                    <div class="text-[9px] font-mono text-[#444] mb-8">SEC // 02</div>
                    <h3 class="text-3xl font-brick text-white mb-4 uppercase group-hover:text-[#DC2626]">Projetos ‚Äî Clientes</h3>
                    <p class="text-[#444] font-mono text-xs uppercase">Strategy & Craft</p>
                </div>
                <div onclick="enterMode('ideias')" class="group cursor-pointer border border-[#111] bg-[#050505] p-12 hover:border-[#DC2626] transition-all">
                    <div class="text-[9px] font-mono text-[#444] mb-8">SEC // 03</div>
                    <h3 class="text-3xl font-brick text-white mb-4 uppercase group-hover:text-[#DC2626]">Ideias</h3>
                    <p class="text-[#444] font-mono text-xs uppercase">Validation</p>
                </div>
            </div>
            </div>
        </div>

        <!-- LOBBY -->
        <div id="project-lobby" class="hidden flex-1 overflow-y-auto pr-4">
            <div id="lobby-approved" class="mb-16">
                <h2 class="text-lg font-brick text-green-500 uppercase mb-6 tracking-wider flex items-center gap-3">
                    <span class="text-2xl">‚úì</span> APROVADOS
                </h2>
                <div id="lobby-approved-list" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
            </div>
            <div id="lobby-active">
                <h2 class="text-lg font-brick text-[#DC2626] uppercase mb-6 tracking-wider flex items-center gap-3">
                    <span class="text-2xl">‚óè</span> EM ANDAMENTO
                </h2>
                <div id="lobby-active-list" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
            </div>
        </div>
    </div>

    <!-- THE FAVORITE WAR ROOM (NODE GRAPHIC) -->
    <div id="view-nodegraphic" class="fixed inset-0 z-[100]">
        <header class="fixed top-0 left-0 w-full flex justify-between items-start p-8 border-b border-white/5 bg-black/80 backdrop-blur-md z-[110]">
            <div>
                <h1 class="text-3xl font-brick text-white uppercase tracking-tighter">
                    BRICK AI <span id="ng-sector-title" class="text-[#DC2626] text-sm font-mono tracking-[0.5em] ml-4">MARKETING</span>
                </h1>
                <div class="text-[9px] font-mono text-[#DC2626] mt-2 tracking-widest uppercase">
                    Mason Protocol v5.0 // <span id="ng-title" class="text-white">PROJECT_TITLE</span>
                </div>
            </div>
            <div class="flex gap-4">
                <button onclick="closeNodeGraphic()" class="text-[#444] hover:text-white font-mono text-[10px] border border-[#222] px-4 py-2 uppercase tracking-widest">‚Üê Back_To_Lobby</button>
                <button onclick="rerunJob()" class="text-[#666] hover:text-[#DC2626] font-mono text-[10px] uppercase tracking-widest border border-[#222] px-4 py-2 hover:border-[#DC2626]">‚Üª Re-run</button>
                <button onclick="confirmDeleteProject()" class="text-[#666] hover:text-[#DC2626] font-mono text-[10px] uppercase tracking-widest border border-[#222] px-4 py-2 hover:border-[#DC2626]">‚úï Delete</button>
                <button onclick="openScheme()" class="text-[#666] hover:text-white font-mono text-[10px] uppercase tracking-widest border border-[#222] px-4 py-2 hover:border-[#444]">‚óà Scheme</button>
                <button onclick="openNewBriefing()" class="btn-brick">+ New_Briefing</button>
            </div>
        </header>

        <div id="canvas-container" class="relative w-full h-full overflow-auto cursor-grab active:cursor-grabbing">
            <svg id="conn-svg" class="absolute inset-0 w-full h-[3000px] pointer-events-none"></svg>
            <div id="node-container" class="relative w-full h-[3000px]"></div>
        </div>

        <!-- TELEMETRY -->
        <div class="fixed bottom-10 left-10 w-80 bg-black/90 border border-[#111] p-4 z-[120] font-mono text-[9px]">
            <div class="flex justify-between text-[#444] mb-3 border-b border-[#111] pb-2">
                <span class="uppercase tracking-wider">TELEMETRY</span>
                <span id="telemetry-status" class="text-green-500">ACTIVE</span>
            </div>
            <div id="telemetry-data" class="space-y-2 text-[10px]">
                <div class="flex justify-between">
                    <span class="text-[#666]">AGENTS:</span>
                    <span id="tel-agents" class="text-[#DC2626]">--</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-[#666]">DURATION:</span>
                    <span id="tel-duration" class="text-[#DC2626]">--</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-[#666]">FILES:</span>
                    <span id="tel-files" class="text-[#DC2626]">--</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-[#666]">STATUS:</span>
                    <span id="tel-stage" class="text-[#DC2626]">--</span>
                </div>
            </div>
        </div>
    </div>

    <!-- AGENT PANEL -->
    <div id="agent-panel" class="side-panel">
        <div class="p-10 border-b border-[#111] flex justify-between items-center">
            <h2 id="panel-title" class="text-2xl font-brick text-white uppercase">AGENTE</h2>
            <button onclick="closePanel()" class="text-[#444] hover:text-white font-mono text-[10px]">CLOSE_</button>
        </div>
        <div id="panel-body" class="p-10 overflow-y-auto h-[calc(100vh-150px)] font-mono text-[11px] text-[#888]"></div>
    </div>

    <!-- SCHEME MODAL -->
    <div id="scheme-modal" class="fixed inset-0 z-[300] bg-black/90 hidden backdrop-blur-sm flex items-center justify-center p-4" onclick="if(event.target.id === 'scheme-modal') closeScheme()">
        <div class="bg-[#050505] border border-[#222] w-full max-w-3xl max-h-[90vh] flex flex-col relative shadow-2xl shadow-red-900/10" onclick="event.stopPropagation()">
            <div class="p-8 border-b border-[#222] flex-shrink-0">
                <button onclick="closeScheme()" class="absolute top-4 right-4 text-[#444] hover:text-white font-mono text-xl z-10">√ó</button>
                <h2 class="text-2xl font-brick text-white uppercase">PIPELINE_SCHEME // <span id="scheme-mode-title" class="text-[#DC2626]">MARKETING</span></h2>
            </div>

            <div class="flex-1 overflow-y-auto p-8">
                <div class="bg-[#0a0a0a] border border-[#222] p-6 font-mono text-xs text-[#888] overflow-x-auto mb-6">
                    <pre id="scheme-diagram" class="leading-relaxed"></pre>
                </div>

                <div class="text-[10px] font-mono text-[#444] border-t border-[#222] pt-4 mt-4">
                    <div class="mb-2 text-[#666]">PROTOCOL_INFO:</div>
                    <div id="scheme-info"></div>
                </div>
            </div>

            <div class="p-4 border-t border-[#222] flex justify-end flex-shrink-0">
                <button onclick="closeScheme()" class="text-[#666] hover:text-white font-mono text-xs uppercase tracking-widest px-4 py-2 border border-[#222] hover:border-[#444]">CLOSE</button>
            </div>
        </div>
    </div>

    <!-- FEEDBACK MODAL -->
    <div id="feedback-modal" class="fixed inset-0 z-[300] bg-black/90 hidden backdrop-blur-sm flex items-center justify-center p-4" onclick="if(event.target.id === 'feedback-modal') closeFeedbackModal()">
        <div class="bg-[#050505] border border-[#222] w-full max-w-2xl flex flex-col relative shadow-2xl shadow-red-900/10" onclick="event.stopPropagation()">
            <div class="p-8 border-b border-[#222]">
                <button onclick="closeFeedbackModal()" class="absolute top-4 right-4 text-[#444] hover:text-white font-mono text-xl z-10">√ó</button>
                <h2 class="text-2xl font-brick text-white uppercase">FEEDBACK DE REVIS√ÉO</h2>
                <div class="text-[10px] font-mono text-[#666] mt-2 uppercase tracking-wider">Explique o que precisa ser ajustado</div>
            </div>

            <div class="p-8">
                <textarea
                    id="feedback-text"
                    class="w-full bg-[#0a0a0a] border border-[#222] text-white p-4 font-mono text-sm h-48 focus:border-[#DC2626] outline-none resize-none"
                    placeholder="Exemplo: O tom est√° muito t√©cnico. Precisa ser mais acess√≠vel para o p√∫blico-alvo..."
                ></textarea>
            </div>

            <div class="p-6 border-t border-[#222] flex justify-end gap-4">
                <button onclick="closeFeedbackModal()" class="text-[#666] hover:text-white font-mono text-xs uppercase tracking-widest px-6 py-3 border border-[#222] hover:border-[#444]">CANCELAR</button>
                <button onclick="submitFeedback()" class="btn-brick px-6 py-3">ENVIAR FEEDBACK</button>
            </div>
        </div>
    </div>

    <!-- BRIEFING MODAL -->
    <div id="briefing-modal" class="fixed inset-0 z-[300] bg-black/90 hidden backdrop-blur-sm flex items-center justify-center p-4" onclick="if(event.target.id === 'briefing-modal') closeBriefingModal()">
        <div class="bg-[#050505] border border-[#DC2626] w-full max-w-2xl flex flex-col relative shadow-2xl shadow-red-900/30" onclick="event.stopPropagation()">
            <div class="p-8 border-b border-[#222]">
                <button onclick="closeBriefingModal()" class="absolute top-4 right-4 text-[#444] hover:text-white font-mono text-xl z-10">√ó</button>
                <h2 class="text-2xl font-brick text-white uppercase">NOVO BRIEFING</h2>
                <div class="text-[10px] font-mono text-[#DC2626] mt-2 uppercase tracking-wider">Crie um novo projeto para o pipeline</div>
            </div>

            <div class="p-8 space-y-6">
                <div>
                    <label class="block text-[10px] font-mono text-[#666] uppercase tracking-wider mb-2">MODO</label>
                    <select id="briefing-mode" onchange="updateCostEstimate()" class="w-full bg-[#0a0a0a] border border-[#222] text-white p-3 font-mono text-sm focus:border-[#DC2626] outline-none">
                        <option value="marketing">Marketing (Conte√∫do & Flow)</option>
                        <option value="projetos">Projetos ‚Äî Clientes (Strategy & Craft)</option>
                        <option value="ideias">Ideias (Validation)</option>
                    </select>
                    <div id="cost-estimate" class="mt-2 text-[10px] font-mono text-[#666] flex items-center gap-2">
                        <span class="text-[#DC2626]">üí∞</span>
                        <span>Custo estimado: <span id="cost-value" class="text-green-500">$--</span></span>
                        <span class="text-[#444]">|</span>
                        <span>Etapas: <span id="steps-value" class="text-white">--</span></span>
                    </div>
                </div>
                
                <div>
                    <label class="block text-[10px] font-mono text-[#666] uppercase tracking-wider mb-2">T√çTULO *</label>
                    <input 
                        type="text"
                        id="briefing-title"
                        oninput="saveBriefingDraft()"
                        class="w-full bg-[#0a0a0a] border border-[#222] text-white p-3 font-mono text-sm focus:border-[#DC2626] outline-none"
                        placeholder="Ex: Lan√ßamento Brick AI 2026"
                    >
                </div>
                
                <div>
                    <label class="block text-[10px] font-mono text-[#666] uppercase tracking-wider mb-2">DESCRI√á√ÉO *</label>
                    <textarea
                        id="briefing-content"
                        oninput="saveBriefingDraft()"
                        class="w-full bg-[#0a0a0a] border border-[#222] text-white p-4 font-mono text-sm h-40 focus:border-[#DC2626] outline-none resize-none"
                        placeholder="Descreva o projeto, objetivo, p√∫blico-alvo, restri√ß√µes..."></textarea>
                </div>
            </div>

            <div class="p-6 border-t border-[#222] flex justify-end gap-4">
                <button onclick="clearBriefingDraft(); closeBriefingModal()" class="text-[#666] hover:text-white font-mono text-[10px] uppercase tracking-widest px-6 py-3 border border-[#222] hover:border-[#444]">LIMPAR & CANCELAR</button>
                <button onclick="submitBriefing()" class="btn-brick px-6 py-3">CRIAR BRIEFING</button>
            </div>
        </div>
    </div>

    <!-- APPROVAL MODAL -->
    <div id="approval-modal" class="fixed inset-0 z-[300] bg-black/90 hidden backdrop-blur-sm flex items-center justify-center p-4" onclick="if(event.target.id === 'approval-modal') closeApprovalModal()">
        <div class="bg-[#050505] border border-[#DC2626] w-full max-xl flex flex-col relative shadow-2xl shadow-red-900/30" onclick="event.stopPropagation()">
            <div class="p-8 border-b border-[#222]">
                <button onclick="closeApprovalModal()" class="absolute top-4 right-4 text-[#444] hover:text-white font-mono text-xl z-10">√ó</button>
                <h2 class="text-2xl font-brick text-white uppercase">APROVAR CAMPANHA</h2>
                <div class="text-[10px] font-mono text-[#DC2626] mt-2 uppercase tracking-wider">Confirme para liberar para execu√ß√£o</div>
            </div>

            <div class="p-8">
                <div class="bg-[#0a0a0a] border border-[#222] p-6 space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-[#666] font-mono">PROJETO:</span>
                        <span id="approval-project" class="text-white font-semibold">--</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-[#666] font-mono">SCORE FINAL:</span>
                        <span id="approval-score" class="text-green-500 font-mono font-bold">--/100</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-[#666] font-mono">APROVADO POR:</span>
                        <span id="approval-model" class="text-[#DC2626] font-mono">--</span>
                    </div>
                </div>

                <div class="mt-6 text-xs text-[#666] font-mono leading-relaxed">
                    Ao aprovar, voc√™ confirma que revisou o conte√∫do e autoriza a execu√ß√£o da campanha conforme planejado.
                </div>
            </div>

            <div class="p-6 border-t border-[#222] flex justify-end gap-4">
                <button onclick="closeApprovalModal()" class="text-[#666] hover:text-white font-mono text-xs uppercase tracking-widest px-6 py-3 border border-[#222] hover:border-[#444]">CANCELAR</button>
                <button onclick="confirmApproval()" class="bg-green-600 hover:bg-green-500 text-white font-mono text-xs uppercase tracking-widest px-6 py-3 font-bold">‚úì APROVAR</button>
            </div>
        </div>
    </div>

    <!-- REVISION COMPARISON MODAL -->
    <div id="revision-modal" class="fixed inset-0 z-[300] bg-black/90 hidden backdrop-blur-sm flex items-center justify-center p-4" onclick="if(event.target.id === 'revision-modal') closeRevisionModal()">
        <div class="bg-[#050505] border border-[#f97316] w-full max-w-5xl max-h-[90vh] flex flex-col relative shadow-2xl" onclick="event.stopPropagation()">
            <div class="p-8 border-b border-[#222] flex-shrink-0">
                <button onclick="closeRevisionModal()" class="absolute top-4 right-4 text-[#444] hover:text-white font-mono text-xl z-10">&times;</button>
                <h2 class="text-2xl font-brick text-white uppercase">COMPARA√á√ÉO DE REVIS√ÉO</h2>
                <div class="text-[10px] font-mono text-[#f97316] mt-2 uppercase tracking-wider">
                    <span id="revision-job-title">--</span>
                </div>
            </div>
            <!-- Tabs -->
            <div class="flex gap-2 px-8 pt-4 flex-shrink-0">
                <button class="rev-tab-btn active" onclick="switchRevisionTab('overview', this)">Overview</button>
                <button class="rev-tab-btn" onclick="switchRevisionTab('sidebyside', this)">Lado a Lado</button>
                <button class="rev-tab-btn" onclick="switchRevisionTab('diff', this)">Diff Completo</button>
            </div>
            <!-- Feedback original -->
            <div id="revision-feedback-bar" class="mx-8 mt-4 p-4 bg-[#0a0a0a] border border-[#333] text-sm font-mono text-[#aaa] flex-shrink-0">
                <span class="text-[#f97316] font-bold uppercase text-[10px] tracking-wider">Feedback:</span>
                <span id="revision-feedback-text" class="ml-2">--</span>
            </div>
            <!-- Tab content -->
            <div class="flex-1 overflow-y-auto p-8" id="revision-tab-content">
                <div class="text-center text-[#666] py-12 font-mono">Carregando...</div>
            </div>
            <!-- Actions -->
            <div id="revision-actions-bar" class="p-6 border-t border-[#222] flex justify-between items-center flex-shrink-0">
                <div class="text-[10px] font-mono text-[#444] uppercase tracking-wider">
                    Status: <span id="revision-status-label" class="text-[#f97316]">Pendente</span>
                </div>
                <div class="flex gap-4">
                    <button onclick="revisionAction('reject')" class="text-[#666] hover:text-white font-mono text-xs uppercase tracking-widest px-6 py-3 border border-[#222] hover:border-[#444]">Manter Original</button>
                    <button onclick="revisionAction('rerun')" class="text-[#f97316] hover:text-white font-mono text-xs uppercase tracking-widest px-6 py-3 border border-[#f97316] hover:bg-[#f97316]">Rodar Novamente</button>
                    <button onclick="revisionAction('approve')" class="bg-green-600 hover:bg-green-500 text-white font-mono text-xs uppercase tracking-widest px-6 py-3 font-bold">Aprovar Revis√£o</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let currentState = null;
        let currentMode = null;
        let selectedJobId = null;
        let currentJobId = null;
        let refreshInterval = null;
        let activeRevisionLinks = [];
        
        // SECURITY: XSS Protection - Sanitize markdown output
        function safeMarkdown(text) {
            if (!text) return '';
            const rawHtml = marked.parse(text);
            return DOMPurify.sanitize(rawHtml);
        }

        const nodeDefMarketing = [
            { id: 'n0', x: 0, y: 150, title: 'BRIEFING_INPUT', label: 'Ingestion', model: 'RAW INPUT' },
            { id: 'nd', x: 0, y: 350, title: 'DOUGLAS', label: 'Pre-Pipeline (Manual)', model: 'OPUS 4.6', douglas: true },
            { id: 'n1', x: 0, y: 550, title: 'VALIDATOR', label: 'Brief_Validator', model: 'GEMINI FLASH' },
            { id: 'n2', x: -260, y: 750, title: 'AUDIENCE', label: 'Audience_Analyst', model: 'GEMINI FLASH' },
            { id: 'n3', x: 260, y: 750, title: 'RESEARCH', label: 'Topic_Researcher', model: 'GEMINI FLASH' },
            { id: 'n4', x: 0, y: 950, title: 'FACT_CHECK', label: 'Claims_Checker', model: 'GEMINI FLASH' },
            { id: 'n5a', x: -350, y: 1150, title: 'COPY_A', label: 'Creative_Alpha', model: 'GPT-5.1' },
            { id: 'n5b', x: 0, y: 1150, title: 'COPY_B', label: 'Creative_Beta', model: 'GEMINI FLASH' },
            { id: 'n5c', x: 350, y: 1150, title: 'COPY_C', label: 'Creative_Gamma', model: 'CLAUDE SONNET' },
            { id: 'n7', x: 0, y: 1350, title: 'COPY SENIOR', label: 'Final_Pen', model: 'GPT-5.1' },
            { id: 'n8', x: 0, y: 1550, title: 'WALL', label: 'Final_Filter', model: 'CLAUDE OPUS' },
            { id: 'n9', x: 0, y: 1750, title: 'HUMAN', label: 'User_Control', model: 'APPROVAL', human: true },
            { id: 'n10', x: 0, y: 1950, title: 'OUTPUT', label: 'Final_Ready', model: 'READY' }
        ];
        const linksMarketing = [['n0','nd'],['nd','n1'],['n1','n2'],['n1','n3'],['n2','n4'],['n3','n4'],['n4','n5a'],['n4','n5b'],['n4','n5c'],['n5a','n7'],['n5b','n7'],['n5c','n7'],['n7','n8'],['n8','n9'],['n9','n10']];

        const nodeDefProjetos = [
            { id: 'p0', x: 0, y: 150, title: 'BRIEFING_INPUT', label: 'Ingestion', model: 'RAW INPUT' },
            { id: 'pd', x: 0, y: 350, title: 'DOUGLAS', label: 'Orchestrator', model: 'CORE', douglas: true },
            { id: 'p1', x: 0, y: 550, title: 'BRAND_DIGEST', label: 'Brand_Extractor', model: 'GEMINI FLASH' },
            { id: 'p2a', x: -550, y: 750, title: 'IDEATION_GPT', label: 'Concept_A', model: 'GPT' },
            { id: 'p2b', x: 0, y: 750, title: 'IDEATION_FLASH', label: 'Concept_B', model: 'GEMINI FLASH' },
            { id: 'p2c', x: 550, y: 750, title: 'IDEATION_SONNET', label: 'Concept_C', model: 'CLAUDE SONNET' },
            { id: 'p3', x: 0, y: 950, title: 'CONCEPT_CRITIC', label: 'Concept_Judge', model: 'GEMINI PRO' },
            { id: 'p4', x: 0, y: 1150, title: 'EXECUTION_DESIGN', label: 'Visual_Director', model: 'GEMINI PRO' },
            { id: 'p5', x: 0, y: 1350, title: 'PROPOSAL', label: 'Script_Writer', model: 'GPT-5.1' },
            { id: 'p6', x: 0, y: 1550, title: 'DIRECTOR', label: 'Execution_Judge', model: 'GEMINI PRO' },
            { id: 'p9', x: 0, y: 1750, title: 'HUMAN', label: 'User_Control', model: 'APPROVAL', human: true },
            { id: 'p10', x: 0, y: 1950, title: 'OUTPUT', label: 'Final_Ready', model: 'READY' }
        ];
        const linksProjetos = [['p0','pd'],['pd','p1'],['p1','p2a'],['p1','p2b'],['p1','p2c'],['p2a','p3'],['p2b','p3'],['p2c','p3'],['p3','p4'],['p4','p5'],['p5','p6'],['p6','p9'],['p9','p10']];

        const nodeDefIdeias = [
            { id: 'i0', x: 0, y: 150, title: 'RAW_IDEA', label: 'Ingestion', model: 'INPUT' },
            { id: 'id', x: 0, y: 350, title: 'DOUGLAS', label: 'Orchestrator', model: 'CORE', douglas: true },
            { id: 'i1', x: 0, y: 550, title: 'PAIN_CHECK', label: 'Validation', model: 'GEMINI FLASH' },
            { id: 'i2', x: 0, y: 750, title: 'MARKET_SCAN', label: 'Research', model: 'GEMINI FLASH' },
            { id: 'i3a', x: -250, y: 950, title: 'ANGEL_GEN', label: 'Angel', model: 'CLAUDE SONNET' },
            { id: 'i3b', x: 250, y: 950, title: 'DEVIL_GEN', label: 'Devil', model: 'CLAUDE SONNET' },
            { id: 'i4', x: 0, y: 1150, title: 'VIABILITY', label: 'Supreme_Judge', model: 'CLAUDE OPUS' },
            { id: 'i5', x: 0, y: 1350, title: 'DECISION', label: 'User_Control', model: 'APPROVAL', human: true }
        ];
        const linksIdeias = [['i0','id'],['id','i1'],['i1','i2'],['i2','i3a'],['i2','i3b'],['i3a','i4'],['i3b','i4'],['i4','i5']];

        // File mapping loaded dynamically from config/file-mapping.json
        let fileMapping = {};
        
        async function loadFileMapping() {
            try {
                const response = await fetch('/config/file-mapping.json');
                if (!response.ok) throw new Error('Failed to load file mapping');
                fileMapping = await response.json();
                console.log('‚úÖ File mapping loaded:', Object.keys(fileMapping).length, 'entries');
            } catch (error) {
                console.error('‚ùå Failed to load file mapping:', error);
                // Fallback to minimal mapping if fetch fails
                fileMapping = {
                    'VALIDATOR': ['VALIDATOR'],
                    'AUDIENCE': ['AUDIENCE'],
                    'WALL': ['WALL'],
                    'HUMAN': ['FINAL']
                };
            }
        }

        async function fetchState() {
            try {
                const res = await fetch(`${API_URL}/state${currentMode ? '?mode='+currentMode : ''}`);
                currentState = await res.json();
                renderLobby();
                if(selectedJobId) renderNodeGraphic();
            } catch(e) {}
        }

        function enterMode(mode) {
            currentMode = mode;
            localStorage.setItem('last_mode', mode);
            if (mode) window.location.hash = mode;
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('project-lobby').classList.remove('hidden');
            document.getElementById('btn-back-lobby').classList.remove('hidden');
            document.getElementById('btn-scheme').classList.remove('hidden');
            document.getElementById('btn-delete-project').classList.add('hidden'); // Hide until viewing a project
            const modeLabels = { marketing: 'MARKETING', projetos: 'PROJETOS ‚Äî CLIENTES', ideias: 'IDEIAS' };
            document.getElementById('header-sector').textContent = modeLabels[mode] || mode.toUpperCase();
            
            if (socket && socket.connected) {
                socket.emit('subscribe', mode);
            }
            
            fetchState();
            // Auto-refresh a cada 10 segundos
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(fetchState, 10000);
        }

        function goHome() {
            currentMode = null;
            currentJobId = null;
            localStorage.removeItem('last_mode');
            history.replaceState(null, '', window.location.pathname);
            if (refreshInterval) { clearInterval(refreshInterval); refreshInterval = null; }
            document.getElementById('welcome-screen').classList.remove('hidden');
            document.getElementById('project-lobby').classList.add('hidden');
            document.getElementById('btn-back-lobby').classList.add('hidden');
            document.getElementById('btn-scheme').classList.add('hidden');
            document.getElementById('btn-delete-project').classList.add('hidden');
            document.getElementById('header-sector').textContent = 'COMMAND_CENTER';
        }

        function openScheme() {
            const modal = document.getElementById('scheme-modal');
            const title = document.getElementById('scheme-mode-title');
            const diagram = document.getElementById('scheme-diagram');
            const info = document.getElementById('scheme-info');

            title.textContent = (currentMode || 'MARKETING').toUpperCase();

            if (currentMode === 'ideias') {
                diagram.textContent = `RAW IDEA (input do usu√°rio)
‚îÇ
‚ñº
[DOUGLAS] ‚îÄ‚îÄ‚îÄ Processamento MANUAL via OpenClaw
‚îÇ             (interpreta, enriquece com contexto t√©cnico)
‚ñº
01. PAIN CHECK (Flash) ‚îÄ‚îÄ Valida problema/dor real do mercado
‚îÇ
‚ñº
02. MARKET SCAN (Flash) ‚îÄ Pesquisa concorr√™ncia, precedentes, viabilidade de mercado
‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚ñº              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ANGEL      ‚îÇ ‚îÇ DEVIL      ‚îÇ
‚îÇ (Sonnet)   ‚îÇ ‚îÇ (Sonnet)   ‚îÇ
‚îÇ Otimista   ‚îÇ ‚îÇ Cr√≠tico    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚ñº
04. VIABILITY (Opus) ‚îÄ‚îÄ‚îÄ Score 0-100 (rubrica 4 crit√©rios: problema, contexto, op√ß√µes, execu√ß√£o)
‚îÇ
‚ñº
05. DECISION (Human) ‚îÄ‚îÄ‚îÄ Go / No-Go
‚îÇ
‚îú‚îÄ‚ñ∫ [APROVAR] ‚Üí Projeto vi√°vel, executar
‚îÇ
‚îî‚îÄ‚ñ∫ [REJEITAR] ‚Üí Arquivar ideia`;

                info.innerHTML = `
                    <h3 style="color:#DC2626;font-size:13px;font-weight:900;margin:16px 0 12px;text-transform:uppercase;letter-spacing:0.1em;">O QUE CADA NODE FAZ</h3>

                    <div style="margin-bottom:16px;background:#1e293b;padding:10px;border-left:3px solid #f59e0b;">
                        <div style="color:#f59e0b;font-weight:700;">00. DOUGLAS <span style="font-size:9px;background:#f59e0b;color:#000;padding:2px 4px;border-radius:3px;margin-left:4px;">MANUAL</span></div>
                        <div style="color:#888;font-size:10px;margin-top:4px;"><strong>Pr√©-Pipeline:</strong> Douglas processa ideia bruta manualmente via OpenClaw session. Interpreta, expande contexto t√©cnico, salva <code>{JOB_ID}_RAW_IDEA.md</code> e executa <code>run-ideias.sh</code>.</div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="color:#fff;font-weight:700;">01. PAIN CHECK <span style="color:#4285f4;">(Gemini 3 Flash)</span></div>
                        <div style="color:#888;font-size:10px;margin-top:2px;">Valida se a ideia resolve um problema real e mensur√°vel. Rejeita ideias sem dor clara ou sem p√∫blico. Output: JSON com status VALID/INVALID. Role: <code>PAIN_CHECK.md</code>
                        <br><strong>Modelo:</strong> Gemini 3 Flash (Preview) ‚Äî <code>google/gemini-3-flash-preview</code></div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="color:#fff;font-weight:700;">02. MARKET SCAN <span style="color:#4285f4;">(Gemini 3 Flash)</span></div>
                        <div style="color:#888;font-size:10px;margin-top:2px;">Pesquisa concorrentes, produtos similares, precedentes de mercado. Identifica barreiras t√©cnicas, regulat√≥rias e financeiras. Role: <code>MARKET_SCAN.md</code>
                        <br><strong>Modelo:</strong> Gemini 3 Flash (Preview) ‚Äî <code>google/gemini-3-flash-preview</code></div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="color:#fff;font-weight:700;">03. ANGEL + DEVIL <span style="color:#d97706;">(Claude Sonnet 4.5)</span> <span style="color:#888;">// Paralelo</span></div>
                        <div style="color:#888;font-size:10px;margin-top:2px;">2 perspectivas opostas em paralelo:
                        <br>‚Ä¢ <span style="color:#22c55e;">ANGEL</span>: Vis√£o otimista, caminhos de execu√ß√£o, oportunidades
                        <br>‚Ä¢ <span style="color:#ef4444;">DEVIL</span>: Vis√£o cr√≠tica, red flags, riscos, por que N√ÉO funciona
                        <br>Output: 2 arquivos Markdown. Roles: <code>ANGEL_GEN.md</code>, <code>DEVIL_GEN.md</code>
                        <br><strong>Modelo:</strong> Claude Sonnet 4.5 ‚Äî <code>anthropic/claude-sonnet-4-5</code></div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="color:#fff;font-weight:700;">04. VIABILITY <span style="color:#a855f7;">(Claude Opus 4-6)</span></div>
                        <div style="color:#888;font-size:10px;margin-top:2px;">Juiz imparcial. Avalia ideia com rubrica de 100 pontos (4 crit√©rios: problema 30pts, contexto 25pts, op√ß√µes 25pts, execu√ß√£o 20pts). Penalidades por riscos sist√™micos. Veredito: APROVAR (70+), REFINAR (40-69), REJEITAR (0-39). Role: <code>VIABILITY.md</code>
                        <br><strong>Modelo:</strong> Claude Opus 4-6 ‚Äî <code>anthropic/claude-opus-4-6</code></div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="color:#fff;font-weight:700;">05. DECISION <span style="color:#888;">(Human)</span></div>
                        <div style="color:#888;font-size:10px;margin-top:2px;">Decis√£o final humana. Card mostra score e status (APROVAR/REFINAR/REJEITAR). Bot√µes: Aprovar (move pra done/) ou Rejeitar (arquiva). Output: <code>FINAL.md</code> (relat√≥rio completo de viabilidade).</div>
                    </div>

                    <div style="margin-top:24px;padding:12px;background:#0a0a0a;border-left:3px solid #DC2626;">
                        <div style="color:#DC2626;font-weight:700;margin-bottom:8px;">üí° FILOSOFIA DO PIPELINE</div>
                        <div style="color:#888;font-size:10px;line-height:1.6;">
                            Valida√ß√£o ultra-r√°pida de conceitos (2-3 min). Problem Scoping pra evitar ideias sem demanda real. Angel vs Devil for√ßa exposi√ß√£o de trade-offs. Opus julga com crit√©rios objetivos. Economiza semanas de trabalho em ideias invi√°veis.
                        </div>
                    </div>

                    <div style="margin-top:16px;padding:10px;background:#1a1a1a;border:1px solid #333;">
                        üìä <strong>Custo estimado:</strong> ~$0.08/ideia (inclui input+output tokens)<br>
                        ‚è±Ô∏è <strong>Tempo m√©dio:</strong> 2-3 minutos<br>
                        üéØ <strong>Taxa de rejei√ß√£o esperada:</strong> 60-70% (filtro agressivo √© feature, n√£o bug)
                    </div>
                `;
            } else if (currentMode === 'projetos') {
                diagram.textContent = `BRIEFING DO CLIENTE
‚îÇ
‚ñº
[DOUGLAS] - Processamento MANUAL via OpenClaw
‚îÇ
‚ñº
01. BRAND DIGEST (Flash) - Extrai DNA/tom/valores da marca DO CLIENTE
‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚ñº                ‚ñº                ‚ñº
02a. IDEATION    02b. IDEATION    02c. IDEATION
(GPT - Ousado)   (Flash - Pragm)  (Sonnet - Emoc)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚ñº
03. CONCEPT CRITIC (Pro) - Escolhe vencedor + fundamenta
‚îÇ
‚ñº
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  LOOP EXECUTION ‚Üî DIRECTOR (Max 3x)   ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë  04. EXECUTION DESIGN (Pro)           ‚ïë
‚ïë      ‚îî‚îÄ Visual system + specs         ‚ïë
‚ïë  ‚ñº                                    ‚ïë
‚ïë  05. PROPOSAL (GPT)                   ‚ïë
‚ïë      ‚îî‚îÄ Roteiro/copy final            ‚ïë
‚ïë  ‚ñº                                    ‚ïë
‚ïë  06. DIRECTOR (Pro)                   ‚ïë
‚ïë      ‚îî‚îÄ Veredito: APROVAR/REFINAR     ‚ïë
‚ïë                                       ‚ïë
‚ïë  Se REFINAR ‚Üí volta pro step 04       ‚ïë
‚ïë  com feedback detalhado               ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
‚îÇ
‚ñº
HUMAN - Aprova√ß√£o final (s√≥ se Director aprovou)
‚îÇ
‚ñº
OUTPUT (Proposta completa)`;

                info.innerHTML = `
                    <div style="margin-bottom:16px;padding:10px;background:#1e293b;border-left:3px solid #f59e0b;">
                        <div style="color:#f59e0b;font-weight:700;">‚ö†Ô∏è PROJETOS DE CLIENTES</div>
                        <div style="color:#888;font-size:10px;margin-top:4px;">Este pipeline processa projetos de clientes da Brick (produtora). Cada projeto usa a <strong>marca do cliente</strong>, n√£o da Brick. O Brand Digest extrai o DNA da marca do briefing recebido.</div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="color:#fff;font-weight:700;">00. DOUGLAS (Orchestrator)</div>
                        <div style="color:#888;font-size:10px;margin-top:2px;">Ingestion do briefing do cliente. Role: <code>N/A</code></div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="color:#fff;font-weight:700;">01. BRAND DIGEST <span style="color:#4285f4;">(Gemini 3 Flash)</span></div>
                        <div style="color:#888;font-size:10px;margin-top:2px;">Extrai identidade visual, tom, valores e posicionamento da <strong>marca do cliente</strong> a partir do briefing. Output: JSON. Role: <code>BRAND_DIGEST.md</code>
                        <br><strong>Modelo:</strong> Gemini 3 Flash (Preview) ‚Äî <code>google/gemini-3-flash-preview</code></div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="color:#fff;font-weight:700;">02. CREATIVE IDEATION (GPT + Flash + Sonnet) <span style="color:#888;">// Paralelo</span></div>
                        <div style="color:#888;font-size:10px;margin-top:2px;">3 modelos geram conceitos criativos simultaneamente:
                        <br>‚Ä¢ <span style="color:#10a37f;">GPT-5.1</span>: Conceito A (Ousado, surpreendente)
                        <br>‚Ä¢ <span style="color:#4285f4;">Gemini 3 Flash</span>: Conceito B (Pragm√°tico, execut√°vel)
                        <br>‚Ä¢ <span style="color:#d97706;">Claude Sonnet 4.5</span>: Conceito C (Emocional, storytelling)
                        <br>Output: 3 arquivos Markdown. Role: <code>CREATIVE_IDEATION.md</code>
                        <br><strong>Modelos:</strong> GPT-5.1 (<code>openai-codex/gpt-5.1</code>), Gemini 3 Flash (<code>google/gemini-3-flash-preview</code>), Claude Sonnet 4.5 (<code>anthropic/claude-sonnet-4-5</code>)</div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="color:#fff;font-weight:700;">03. CONCEPT CRITIC <span style="color:#00bcd4;">(Gemini 3 Pro)</span></div>
                        <div style="color:#888;font-size:10px;margin-top:2px;">Avalia os 3 conceitos e escolhe o vencedor com fundamenta√ß√£o. Output: JSON. Role: <code>CONCEPT_CRITIC.md</code>
                        <br><strong>Modelo:</strong> Gemini 3 Pro (Preview) ‚Äî <code>google/gemini-3-pro-preview</code></div>
                    </div>

                    <div style="margin-bottom:16px;padding:12px;background:#0a0a0a;border-left:3px solid #f97316;">
                        <div style="color:#f97316;font-weight:700;margin-bottom:8px;">üîÑ LOOP AUTOM√ÅTICO (Max 3 rodadas)</div>
                        
                        <div style="margin-bottom:12px;">
                            <div style="color:#fff;font-weight:700;">04. EXECUTION DESIGN <span style="color:#00bcd4;">(Gemini 3 Pro)</span></div>
                            <div style="color:#888;font-size:10px;margin-top:2px;">Transforma conceito em plano execut√°vel: visual system, copy framework, UX, specs t√©cnicas. Se receber feedback do Director (loop), aplica corre√ß√µes e documenta no campo <code>director_feedback_response</code>. Output: JSON. Role: <code>EXECUTION_DESIGN.md</code>
                            <br><strong>Modelo:</strong> Gemini 3 Pro (Preview) ‚Äî <code>google/gemini-3-pro-preview</code></div>
                        </div>

                        <div style="margin-bottom:12px;">
                            <div style="color:#fff;font-weight:700;">05. PROPOSAL <span style="color:#10a37f;">(GPT-5.1)</span></div>
                            <div style="color:#888;font-size:10px;margin-top:2px;">Roteiro/copy final baseado na execu√ß√£o. Output: Markdown. Role: <code>PROPOSAL_WRITER.md</code>
                            <br><strong>Modelo:</strong> GPT-5.1 ‚Äî <code>openai-codex/gpt-5.1</code></div>
                        </div>

                        <div style="margin-bottom:12px;">
                            <div style="color:#fff;font-weight:700;">06. DIRECTOR <span style="color:#00bcd4;">(Gemini 3 Pro)</span></div>
                            <div style="color:#888;font-size:10px;margin-top:2px;">Avalia execu√ß√£o com olhar de diretor de fotografia (20 anos de set). Verifica clich√™s visuais, estrutura narrativa, frame ic√¥nico. Score 0-100 + veredito:
                            <br>‚Ä¢ <span style="color:#22c55e;">APROVAR</span> (85-100): Execu√ß√£o tem craft, segue pro HUMAN
                            <br>‚Ä¢ <span style="color:#f59e0b;">REFINAR</span> (60-84): Volta pro step 04 com feedback
                            <br>‚Ä¢ <span style="color:#ef4444;">REPENSAR</span> (0-59): Execu√ß√£o cafona, volta pro IDEATION
                            <br>Output: JSON. Role: <code>PROJECT_DIRECTOR.md</code>
                            <br><strong>Modelo:</strong> Gemini 3 Pro (Preview) ‚Äî <code>google/gemini-3-pro-preview</code></div>
                        </div>

                        <div style="color:#f97316;font-size:10px;margin-top:8px;">
                            ‚ö†Ô∏è Se Director reprovar (REFINAR/REPENSAR), o loop reinicia no step 04 com feedback detalhado. Arquivos versionados: <code>_v2</code>, <code>_v3</code>. Loop para quando aprovado OU atinge 3 rodadas.
                        </div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="color:#fff;font-weight:700;">HUMAN - Aprova√ß√£o Final</div>
                        <div style="color:#888;font-size:10px;margin-top:2px;">S√≥ recebe projetos de clientes aprovados pelo Director. Bot√µes: Aprovar (move pra done/) ou Rejeitar. Output: <code>FINAL.md</code> (proposta completa para o cliente).</div>
                    </div>

                    <div style="color:#666;font-size:10px;margin-top:16px;padding-top:16px;border-top:1px solid #222;">
                        üìä <strong>Custo estimado:</strong> ~$0.16/projeto (inclui input+output tokens)<br>
                        ‚è±Ô∏è <strong>Tempo m√©dio:</strong> 2-3 minutos (sem loop) | 4-6 minutos (com loop)<br>
                        üîÑ <strong>Taxa de loop:</strong> ~30% dos projetos precisam de 1+ revis√µes
                    </div>
                `;
            } else {
                diagram.textContent = `BRIEFING (input do usu√°rio)
‚îÇ
‚ñº
[DOUGLAS] ‚îÄ‚îÄ‚îÄ Processamento MANUAL via OpenClaw
‚îÇ             (interpreta, enriquece, decide executar)
‚ñº
PROCESSED.md ‚îÄ‚îÄ‚îÄ Briefing enriquecido
‚îÇ
‚ñº
01. BRIEF VALIDATOR (Flash) ‚îÄ‚îÄ Valida completude, identifica lacunas
‚îÇ
‚ñº
02. AUDIENCE ANALYST (Flash) ‚îÄ Analisa persona + alinhamento com Brand Guide
‚îÇ
‚ñº
03. TOPIC RESEARCHER (Flash) ‚îÄ Pesquisa dados, tend√™ncias, refer√™ncias
‚îÇ
‚ñº
04. CLAIMS CHECKER (Flash) ‚îÄ‚îÄ Filtra hype, valida claims verific√°veis
‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚ñº              ‚ñº              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ COPY A     ‚îÇ ‚îÇ COPY B     ‚îÇ ‚îÇ COPY C     ‚îÇ
‚îÇ GPT-5.1    ‚îÇ ‚îÇ FLASH      ‚îÇ ‚îÇ SONNET     ‚îÇ
‚îÇ (Direto)   ‚îÇ ‚îÇ (Data)     ‚îÇ ‚îÇ (Narrativo)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚ñº
06. COPY SENIOR (GPT 5.2) ‚îÄ‚îÄ‚îÄ Escolhe melhor, aplica ajustes, entrega copy_revisada
‚îÇ
‚ñº
07. WALL (Opus + Brand Guardian) ‚îÄ‚îÄ‚îÄ Score 0-100 (rubrica 5 crit√©rios)
‚îÇ
‚îú‚îÄ‚ñ∫ (score < 80) ‚Üí LOOP: volta pro COPY SENIOR com feedback do Wall
‚îÇ                   Copy Senior revisa ‚Üí Wall reavalia (max 3 loops)
‚îÇ
‚ñº (score ‚â• 80)
08. HUMAN ‚îÄ‚îÄ‚îÄ Aprova√ß√£o final
‚îÇ
‚îú‚îÄ‚ñ∫ [APROVAR] ‚Üí OUTPUT (copy public√°vel)
‚îÇ
‚îî‚îÄ‚ñ∫ [REVISAR] ‚Üí REVIS√ÉO N (Modelo Campe√£o + Feedback Humano)
                ‚îÇ
                ‚îî‚îÄ‚ñ∫ Aprovar / Rejeitar ‚Üí loop de revis√µes`;

                info.innerHTML = `
                    <h3 style="color:#DC2626;font-size:13px;font-weight:900;margin:16px 0 12px;text-transform:uppercase;letter-spacing:0.1em;">O QUE CADA NODE FAZ</h3>

                    <div style="margin-bottom:16px;background:#1e293b;padding:10px;border-left:3px solid #f59e0b;">
                        <div style="color:#f59e0b;font-weight:700;">00. DOUGLAS <span style="font-size:9px;background:#f59e0b;color:#000;padding:2px 4px;border-radius:3px;margin-left:4px;">MANUAL</span></div>
                        <div style="color:#888;font-size:10px;margin-top:4px;"><strong>Pr√©-Pipeline:</strong> Douglas processa briefing manualmente via OpenClaw session. Interpreta, enriquece com contexto da Brick AI, baixa anexos se necess√°rio. Decide se vale executar pipeline. Salva <code>{JOB_ID}_PROCESSED.md</code> e executa <code>run-marketing.sh</code>.</div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="color:#fff;font-weight:700;">01. BRIEF VALIDATOR <span style="color:#4285f4;">(Gemini 3 Flash)</span></div>
                        <div style="color:#888;font-size:10px;margin-top:2px;">Valida se o briefing tem todas as informa√ß√µes necess√°rias: p√∫blico, objetivo, canal, formato. Gera JSON com status PASS/FAIL e lista de campos faltantes. Role: <code>BRIEF_VALIDATOR.md</code>
                        <br><strong>Modelo:</strong> Gemini 3 Flash (Preview) ‚Äî <code>google/gemini-3-flash-preview</code></div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="color:#fff;font-weight:700;">02. AUDIENCE ANALYST <span style="color:#4285f4;">(Gemini 3 Flash)</span></div>
                        <div style="color:#888;font-size:10px;margin-top:2px;">Avalia alinhamento do briefing com a persona oficial da Brick AI e o Brand Guide completo. Persona hardcoded no role file. Recebe BRAND_GUIDE.md inteiro. Role: <code>AUDIENCE_ANALYST.md</code>
                        <br><strong>Modelo:</strong> Gemini 3 Flash (Preview) ‚Äî <code>google/gemini-3-flash-preview</code></div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="color:#fff;font-weight:700;">03. TOPIC RESEARCHER <span style="color:#4285f4;">(Gemini 3 Flash)</span></div>
                        <div style="color:#888;font-size:10px;margin-top:2px;">Pesquisa dados de mercado, tend√™ncias e refer√™ncias relevantes pro tema do briefing. Alimenta os copywriters com muni√ß√£o factual. Role: <code>TOPIC_RESEARCHER.md</code>
                        <br><strong>Modelo:</strong> Gemini 3 Flash (Preview) ‚Äî <code>google/gemini-3-flash-preview</code></div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="color:#fff;font-weight:700;">04. CLAIMS CHECKER <span style="color:#4285f4;">(Gemini 3 Flash)</span></div>
                        <div style="color:#888;font-size:10px;margin-top:2px;">Filtro anti-hype. Valida se claims s√£o verific√°veis e sustentados por dados. Pro√≠be termos como "revolucion√°rio", "disruptivo", "game-changer". Garante autoridade segura. Role: <code>CLAIMS_CHECKER.md</code>
                        <br><strong>Modelo:</strong> Gemini 3 Flash (Preview) ‚Äî <code>google/gemini-3-flash-preview</code></div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="color:#fff;font-weight:700;">05. COPYWRITERS x3 <span style="color:#10a37f;">(GPT)</span> <span style="color:#4285f4;">(Flash)</span> <span style="color:#d97706;">(Sonnet)</span></div>
                        <div style="color:#888;font-size:10px;margin-top:2px;">Tr√™s modelos escrevem em paralelo com estilos diferentes: A (direto/persuasivo), B (eficiente/data-driven), C (narrativo/emocional). Todos recebem BRAND_GUIDE.md completo e respeitam tom, terminologia e red flags. Role: <code>COPYWRITER.md</code>
                        <br><strong>Modelos:</strong> GPT-5.1 (<code>openai-codex/gpt-5.1</code>), Gemini 3 Flash (<code>google/gemini-3-flash-preview</code>), Claude Sonnet 4.5 (<code>anthropic/claude-sonnet-4-5</code>)</div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="color:#fff;font-weight:700;">06. COPY SENIOR <span style="color:#10a37f;">(GPT-5.1)</span></div>
                        <div style="color:#888;font-size:10px;margin-top:2px;">Diretor de Cria√ß√£o S√™nior. Avalia as 3 copies, escolhe a melhor (vencedor A/B/C), aplica TODOS os ajustes necess√°rios diretamente no texto e entrega <code>copy_revisada</code> final. N√£o s√≥ sugere ‚Äî executa. Role: <code>COPY_SENIOR.md</code>
                        <br><strong>Modelo:</strong> GPT-5.1 ‚Äî <code>openai-codex/gpt-5.1</code> (fallback: Claude Sonnet 4.5)</div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="color:#fff;font-weight:700;">07. WALL <span style="color:#9333ea;">(Claude Opus 4.6)</span> + Brand Guardian</div>
                        <div style="color:#888;font-size:10px;margin-top:2px;">√öltimo port√£o. Score de 0-100 com rubrica de 5 crit√©rios: Clareza da Oferta (25pts), Dor Real (20pts), Credibilidade (20pts), On-Brand (20pts, usando BRAND_GUARDIAN.md completo), CTA Espec√≠fico (15pts). Score ‚â•80 aprova, &lt;80 rejeita e volta pro Copy Senior com feedback detalhado (max 3 loops). Role: <code>FILTRO_FINAL.md</code> + <code>BRAND_GUARDIAN.md</code>
                        <br><strong>Modelo:</strong> Claude Opus 4.6 ‚Äî <code>anthropic/claude-opus-4-6</code></div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div style="color:#fff;font-weight:700;">08. HUMAN</div>
                        <div style="color:#888;font-size:10px;margin-top:2px;">Aprova√ß√£o humana obrigat√≥ria. Pode aprovar (‚Üí OUTPUT) ou pedir revis√£o com feedback livre. Revis√µes s√£o processadas pelo modelo que ganhou a rodada original (campo modelo_vencedor), gerando REVIS√ÉO_N.md ao lado do node.</div>
                    </div>

                    <h3 style="color:#DC2626;font-size:13px;font-weight:900;margin:20px 0 12px;text-transform:uppercase;letter-spacing:0.1em;">REFER√äNCIAS DE MARCA</h3>
                    <div>‚Ä¢ <strong>BRAND_GUIDE.md</strong> ‚Äî "Vision over Prompt". Tom: The Cold Director. Injetado nos Copywriters + Audience Analyst.</div>
                    <div>‚Ä¢ <strong>BRAND_GUARDIAN.md</strong> ‚Äî Checklist de tom, terminologia, red flags, consist√™ncia. Injetado no Wall + Copy Senior (fallback).</div>

                    <h3 style="color:#DC2626;font-size:13px;font-weight:900;margin:20px 0 12px;text-transform:uppercase;letter-spacing:0.1em;">LOOP AUTOM√ÅTICO</h3>
                    <div>‚Ä¢ Se Wall rejeita (score &lt; 80), Copy Senior recebe feedback detalhado do Wall e revisa a copy.</div>
                    <div>‚Ä¢ Wall reavalia. M√°ximo 3 itera√ß√µes. Arquivos versionados: _v2.json, _v3.json.</div>
                    <div>‚Ä¢ Modelo usado no loop = modelo vencedor da rodada original (campo modelo_vencedor).</div>
                `;
            }

            modal.classList.remove('hidden');
        }

        function closeScheme() {
            document.getElementById('scheme-modal').classList.add('hidden');
        }

        function extractTitle(files) {
            // Procura por BRIEFING_INPUT, PROCESSED ou RAW_IDEA (Ideias)
            const briefingFile = files.find(f => 
                f.name.includes('BRIEFING_INPUT') || 
                f.name.includes('PROCESSED') || 
                f.name.includes('RAW_IDEA')
            );
            
            // Fallback: qualquer arquivo com conte√∫do que comece com # BRIEFING:
            const fallbackFile = !briefingFile ? files.find(f => 
                f.content && /^#\s*BRIEFING:/m.test(f.content)
            ) : null;
            
            const targetFile = briefingFile || fallbackFile;
            if (!targetFile || !targetFile.content) return null;

            // Se for PROCESSED, tenta pegar o t√≠tulo, se for BRIEFING_INPUT, tenta pegar o conte√∫do original
            let content = targetFile.content;
            
            // Extrai t√≠tulo da primeira linha markdown
            const match = content.match(/^#\s*(?:BRIEFING:|BRIEFING PROCESSADO:|RAW IDEA:)?\s*(.+)$/m);
            return match ? match[1].trim() : null;
        }

        function getBriefingContent(files) {
            // Prioridade total para o arquivo original de INPUT
            const inputFile = files.find(f => f.name.includes('BRIEFING_INPUT'));
            if (inputFile && inputFile.content) {
                // Se for JSON (do server.js), extrai o campo content
                try {
                    const json = JSON.parse(inputFile.content);
                    if (json.content) return json.content;
                } catch(e) {}
                
                // Se for Markdown, tenta remover o cabe√ßalho # BRIEFING: se existir
                let c = inputFile.content;
                const match = c.match(/^#\s*(?:BRIEFING:|RAW IDEA:).*\n([\s\S]*)$/m);
                return match ? match[1].trim() : c;
            }
            return null;
        }

        function renderLobby() {
            const activeList = document.getElementById('lobby-active-list');
            const approvedList = document.getElementById('lobby-approved-list');
            activeList.innerHTML = '';
            approvedList.innerHTML = '';
            
            // Separar projetos em andamento (briefing + wip) vs aprovados (done)
            const wipFiles = [...currentState.briefing, ...currentState.wip];
            const doneFiles = [...currentState.done];
            
            const wipGroups = {};
            const doneGroups = {};
            
            function getProjectId(name) {
                // Marketing: ids num√©ricos
                const m = name.match(/^(\d{13,})/);
                if (m) return m[1];

                // Projetos/Ideias: usar prefixo antes do √∫ltimo "_ROLE"
                const roleSuffixes = [
                    'BRAND_DIGEST','CREATIVE_IDEATION','IDEATION_GPT','IDEATION_FLASH','IDEATION_SONNET','CONCEPT_CRITIC','EXECUTION_DESIGN',
                    'COPYWRITER','DIRECTOR','FINAL','PROCESSED','BRIEFING_INPUT',
                    'PAIN_CHECK','MARKET_SCAN','ANGEL_GEN','DEVIL_GEN','VIABILITY','DECISION','RAW_IDEA'
                ];
                for (const role of roleSuffixes) {
                    const idx = name.indexOf(`_${role}`);
                    if (idx > 0) return name.slice(0, idx);
                }

                if (name.includes('__')) return name.split('__')[0];
                return name.replace(/\.[^.]+$/, '');
            }

            wipFiles.forEach(f => {
                const id = getProjectId(f.name);
                if(!wipGroups[id]) wipGroups[id] = []; wipGroups[id].push(f);
            });
            
            doneFiles.forEach(f => {
                const id = getProjectId(f.name);
                if(!doneGroups[id]) doneGroups[id] = []; doneGroups[id].push(f);
            });

            // Renderizar projetos aprovados (verde)
            Object.keys(doneGroups).sort().reverse().forEach(id => {
                const files = doneGroups[id];
                const extractedTitle = extractTitle(files);
                const title = extractedTitle || id.replace(/_/g, ' ');

                const card = document.createElement('div');
                card.className = 'border border-green-600 bg-[#050505] p-8 cursor-pointer hover:border-green-400 transition-all';
                card.onclick = () => openNodeGraphic(id, title);
                card.innerHTML = `
                    <div class="text-[9px] font-mono text-[#444] mb-6">PROJ // ${id.substring(0,8)}</div>
                    <h3 class="text-2xl font-brick text-white uppercase mb-4">${title}</h3>
                    <div class="text-[9px] font-mono text-green-500 tracking-widest flex items-center gap-2">
                        <span>‚úì</span> APROVADO
                    </div>
                `;
                approvedList.appendChild(card);
            });
            
            // Renderizar projetos em andamento (vermelho) - excluir os que j√° est√£o em done/aprovados
            Object.keys(wipGroups).filter(id => !doneGroups[id]).sort().reverse().forEach(id => {
                const files = wipGroups[id];
                const extractedTitle = extractTitle(files);
                const title = extractedTitle || id.replace(/_/g, ' ');
                const revInfo = getJobRevisionInfo(id);

                const card = document.createElement('div');

                if (revInfo.status === 'pending') {
                    // V2 pronta pra review
                    card.className = 'border bg-[#050505] p-8 cursor-pointer card-revision-pending transition-all';
                    card.onclick = () => openNodeGraphic(id, title);
                    card.innerHTML = `
                        <div class="text-[9px] font-mono text-[#444] mb-6">PROJ // ${id.substring(0,8)}</div>
                        <h3 class="text-2xl font-brick text-white uppercase mb-4">${title}</h3>
                        <div class="revision-badge pending mb-4">REVIS√ÉO DISPON√çVEL</div>
                        <div class="flex gap-2 pt-4 border-t border-[#222]">
                            <button onclick="openRevisionModal('${id}', '${title.replace(/'/g, "\\'")}'); event.stopPropagation();" class="flex-1 text-[#f97316] font-mono text-[9px] border border-[#f97316] py-2 hover:bg-[#f97316] hover:text-white uppercase tracking-wider">Ver Compara√ß√£o</button>
                            <button onclick="quickRevisionApprove('${id}'); event.stopPropagation();" class="flex-1 text-green-500 font-mono text-[9px] border border-green-600 py-2 hover:bg-green-600 hover:text-white uppercase tracking-wider">Aprovar</button>
                            <button onclick="quickRevisionReject('${id}'); event.stopPropagation();" class="flex-1 text-[#666] font-mono text-[9px] border border-[#333] py-2 hover:border-white hover:text-white uppercase tracking-wider">Recusar</button>
                        </div>
                    `;
                } else if (revInfo.status === 'feedback_pending') {
                    // Feedback enviado, Douglas ainda processando
                    card.className = 'border bg-[#050505] p-8 cursor-pointer card-feedback-pending transition-all';
                    card.onclick = () => openNodeGraphic(id, title);
                    card.innerHTML = `
                        <div class="text-[9px] font-mono text-[#444] mb-6">PROJ // ${id.substring(0,8)}</div>
                        <h3 class="text-2xl font-brick text-white uppercase mb-4">${title}</h3>
                        <div class="revision-badge feedback-pending">REVIS√ÉO SOLICITADA</div>
                        <div class="text-[9px] font-mono text-[#666] mt-3 tracking-widest">Aguardando processamento...</div>
                    `;
                } else if (revInfo.status === 'approved') {
                    card.className = 'border border-blue-600 bg-[#050505] p-8 cursor-pointer hover:border-blue-400 transition-all';
                    card.onclick = () => openNodeGraphic(id, title);
                    card.innerHTML = `
                        <div class="text-[9px] font-mono text-[#444] mb-6">PROJ // ${id.substring(0,8)}</div>
                        <h3 class="text-2xl font-brick text-white uppercase mb-4">${title}</h3>
                        <div class="revision-badge approved">REVIS√ÉO APROVADA</div>
                    `;
                } else {
                    // Normal card (sem revis√£o)
                    card.className = 'border border-[#111] bg-[#050505] p-8 cursor-pointer hover:border-[#DC2626] transition-all';
                    card.onclick = () => openNodeGraphic(id, title);
                    card.innerHTML = `
                        <div class="text-[9px] font-mono text-[#444] mb-6">PROJ // ${id.substring(0,8)}</div>
                        <h3 class="text-2xl font-brick text-white uppercase mb-4">${title}</h3>
                        <div class="text-[9px] font-mono text-[#DC2626] tracking-widest">ACTIVE_NETWORK</div>
                    `;
                }

                activeList.appendChild(card);
            });
            
            // Esconder se√ß√µes vazias
            document.getElementById('lobby-approved').style.display = Object.keys(doneGroups).length > 0 ? 'block' : 'none';
            document.getElementById('lobby-active').style.display = Object.keys(wipGroups).length > 0 ? 'block' : 'none';
        }

        function updateTelemetry(projectFiles) {
            const agentsCount = projectFiles.filter(f => !f.name.includes('BRIEFING') && !f.name.includes('PROCESSED') && !f.name.includes('FINAL')).length;
            const filesCount = projectFiles.length;

            const timestamps = projectFiles.map(f => new Date(f.mtime).getTime()).filter(t => !isNaN(t));
            let duration = '--';
            if (timestamps.length > 1) {
                const start = Math.min(...timestamps);
                const end = Math.max(...timestamps);
                const diffMs = end - start;
                const diffSec = Math.floor(diffMs / 1000);
                const diffMin = Math.floor(diffSec / 60);
                duration = diffMin > 0 ? `${diffMin}m ${diffSec % 60}s` : `${diffSec}s`;
            }

            const hasFinal = projectFiles.some(f => f.name.includes('FINAL'));
            const stage = hasFinal ? 'READY FOR APPROVAL' : 'PROCESSING';

            document.getElementById('tel-agents').textContent = agentsCount;
            document.getElementById('tel-duration').textContent = duration;
            document.getElementById('tel-files').textContent = filesCount;
            document.getElementById('tel-stage').textContent = stage;
            document.getElementById('telemetry-status').textContent = hasFinal ? 'COMPLETE' : 'ACTIVE';
            document.getElementById('telemetry-status').className = hasFinal ? 'text-green-500' : 'text-yellow-500 animate-pulse';
        }

        function openNodeGraphic(id, title) {
            selectedJobId = id;
            currentJobId = id; // Track for delete
            document.getElementById('ng-title').textContent = title;
            const ngModeLabels = { marketing: 'MARKETING', projetos: 'PROJETOS ‚Äî CLIENTES', ideias: 'IDEIAS' };
            document.getElementById('ng-sector-title').textContent = ngModeLabels[currentMode] || currentMode.toUpperCase();
            document.getElementById('view-nodegraphic').classList.add('active');
            document.getElementById('main-ui').style.display = 'none';
            document.getElementById('btn-reset-layout').classList.remove('hidden');
            document.getElementById('btn-clear-layout').classList.remove('hidden');
            document.getElementById('btn-delete-project').classList.remove('hidden'); // Show delete button
            document.getElementById('layout-indicator').classList.remove('hidden');
            updateLayoutIndicator();
            renderNodeGraphic();
        }

        function updateLayoutIndicator() {
            const savedPositions = JSON.parse(localStorage.getItem(`node_positions_${currentMode}`) || '{}');
            const count = Object.keys(savedPositions).length;
            document.getElementById('saved-positions-count').textContent = count;
            
            const clearBtn = document.getElementById('btn-clear-layout');
            if (clearBtn) {
                if (count > 0) {
                    clearBtn.classList.remove('hidden');
                } else {
                    clearBtn.classList.add('hidden');
                }
            }
        }

        function closeNodeGraphic() {
            document.getElementById('view-nodegraphic').classList.remove('active');
            document.getElementById('main-ui').style.display = 'flex';
            document.getElementById('btn-reset-layout').classList.add('hidden');
            document.getElementById('btn-clear-layout').classList.add('hidden');
            document.getElementById('btn-delete-project').classList.add('hidden');
            document.getElementById('layout-indicator').classList.add('hidden');
            selectedJobId = null;
            currentJobId = null;
        }

        function resetLayout() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[300]';
            modal.innerHTML = `
                <div class="bg-[#050505] border border-[#DC2626] p-8 max-w-md">
                    <h3 class="font-brick text-xl text-white uppercase mb-4">‚ö†Ô∏è RESETAR LAYOUT</h3>
                    <p class="text-sm text-[#aaa] mb-6 leading-relaxed">
                        Isso vai <strong class="text-[#DC2626]">apagar todas as posi√ß√µes salvas</strong> dos n√≥s do modo <strong class="text-white">${currentMode.toUpperCase()}</strong> e restaurar o layout padr√£o.
                    </p>
                    <div class="flex gap-3">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 border border-[#333] text-[#aaa] font-mono text-xs py-2 px-4 hover:border-white hover:text-white transition-colors">
                            CANCELAR
                        </button>
                        <button onclick="confirmResetLayout(); this.closest('.fixed').remove();" class="flex-1 bg-[#DC2626] text-white font-mono text-xs py-2 px-4 hover:bg-white hover:text-black transition-colors">
                            CONFIRMAR RESET
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function confirmResetLayout() {
            localStorage.removeItem(`node_positions_${currentMode}`);
            updateLayoutIndicator();
            renderNodeGraphic();
        }

        function clearLayoutQuick() {
            localStorage.removeItem(`node_positions_${currentMode}`);
            updateLayoutIndicator();
            renderNodeGraphic();
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-8 right-8 bg-[#DC2626] text-white px-6 py-3 font-mono text-xs uppercase tracking-wider z-[300]';
            toast.textContent = `‚úì Layout ${currentMode} resetado`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        function renderNodeGraphic() {
            const container = document.getElementById('node-container');
            const svg = document.getElementById('conn-svg');
            const allFiles = [...currentState.briefing, ...currentState.wip, ...currentState.done];
            const projectFiles = allFiles.filter(f => f.name.toLowerCase().includes(selectedJobId.toLowerCase()));

            container.innerHTML = '';
            svg.innerHTML = '';

            let nodes = nodeDefMarketing;
            if (currentMode === 'projetos') nodes = nodeDefProjetos;
            if (currentMode === 'ideias') nodes = nodeDefIdeias;

            let savedPositions = JSON.parse(localStorage.getItem(`node_positions_${currentMode}`) || '{}');
            const centerX = container.offsetWidth / 2;
            
            nodes.forEach(n => {
                // OUTPUT s√≥ aparece se o projeto foi aprovado (existe na pasta done)
                if (n.title === 'OUTPUT') {
                    const isApproved = currentState.done.some(f => f.name.toLowerCase().includes(selectedJobId.toLowerCase()));
                    if (!isApproved) return; // Pula a renderiza√ß√£o do OUTPUT
                }
                
                const el = document.createElement('div');
                const providerMap = {
                    'GPT': 'openai', 'GPT 5.2': 'openai', 'GPT-5.1': 'openai', 'GPT-4O': 'openai',
                    'GEMINI FLASH': 'gemini-flash', 'FLASH': 'gemini-flash',
                    'GEMINI PRO': 'gemini-pro', 'GEMINI 3 PRO': 'gemini-pro',
                    'CLAUDE SONNET': 'sonnet', 'SONNET': 'sonnet',
                    'CLAUDE OPUS': 'opus', 'OPUS': 'opus',
                    'APPROVAL': 'human'
                };
                const provider = providerMap[n.model] || '';
                el.className = `node ${n.douglas?'node-douglas':''}`;
                if (provider) el.setAttribute('data-provider', provider);
                el.id = n.id;
                el.style.position = 'absolute';
                
                if (savedPositions[n.id] && savedPositions[n.id].left && savedPositions[n.id].top) {
                    el.style.left = savedPositions[n.id].left;
                    el.style.top = savedPositions[n.id].top;
                } else {
                    const defaultLeft = centerX + n.x - 160;
                    el.style.left = `${defaultLeft}px`;
                    el.style.top = `${n.y}px`;
                }
                el.style.transform = 'none';

                const searchTerms = fileMapping[n.title] || [n.title];
                // Filtrar arquivos versionados (_v2, _v3) criados pelo loop Copy Senior ‚Üî Wall
                const hasFile = projectFiles.some(f => 
                    !/_v\d+\.(json|md)$/i.test(f.name) && // Exclui arquivos de loop
                    searchTerms.some(term => f.name.toUpperCase().includes(term.toUpperCase()))
                );
                if(!hasFile && !n.douglas && !n.human && n.id !== 'n0') el.classList.add('disabled');

                // Extrair score/status se for DECISION (Ideias)
                let scoreHTML = '';
                if (n.id === 'i5' && currentMode === 'ideias') {
                    const viabilityFile = projectFiles.find(f => {
                        const patterns = fileMapping['VIABILITY'] || [];
                        return patterns.some(p => f.name.includes(p));
                    });
                    if (viabilityFile) {
                        try {
                            const json = JSON.parse(viabilityFile.content);
                            const score = json.viability_assessment?.score_final || 'N/A';
                            const status = json.viability_assessment?.status || 'PENDING';
                            let scoreColor = '#666';
                            if (typeof score === 'number') {
                                if (score >= 70) scoreColor = '#22c55e';
                                else if (score >= 40) scoreColor = '#f59e0b';
                                else scoreColor = '#ef4444';
                            }
                            scoreHTML = `
                                <div style="margin-top: 12px; padding: 12px; background: #0a0a0a; border-left: 3px solid ${scoreColor};">
                                    <div style="font-family: 'Inter', sans-serif; font-weight: 900; font-size: 32px; color: ${scoreColor}; line-height: 1;">${score}</div>
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: #888; margin-top: 4px; text-transform: uppercase; letter-spacing: 1px;">${status}</div>
                                </div>
                            `;
                        } catch(e) {}
                    }
                }
                
                el.innerHTML = `
                    <div class="node-led"></div>
                    <div class="node-id">${n.id.toUpperCase()} // ${n.label}</div>
                    <div class="node-title">${n.title}</div>
                    <div class="node-subtext">${n.model || 'PROCESSING'}</div>
                    ${scoreHTML}
                    ${n.human ? `
                        <div class="flex gap-2 mt-4 pt-4 border-t border-[#111]">
                            <button onclick="aprovarCampanha(event)" class="flex-1 bg-white text-black font-brick text-[9px] py-2 hover:bg-[#DC2626] hover:text-white transition-colors">APROVAR</button>
                            <button onclick="openFeedbackModal(event)" class="flex-1 border border-[#222] text-[#444] font-brick text-[9px] py-2 hover:border-white hover:text-white transition-colors">REVISAR</button>
                        </div>
                    ` : ''}
                `;
                // DECISION (i5) usa fun√ß√£o especial com score no topo
                if (n.id === 'i5' && currentMode === 'ideias') {
                    el.ondblclick = () => viewFullViability(n.id, projectFiles);
                } else {
                    el.ondblclick = () => openPanel(n, projectFiles);
                }
                container.appendChild(el);
                makeDraggable(el);
            });

            // DYNAMIC LOOP NODES - Marketing (DESABILITADO - Gabriel pediu pra esconder)
            // const loopWallFiles = projectFiles.filter(f => /_v(\d+)\.json$/i.test(f.name) && f.name.includes('WALL'));
            // const loopCopyFiles = projectFiles.filter(f => /_v(\d+)\.json$/i.test(f.name) && f.name.includes('COPY_SENIOR'));

            // DYNAMIC LOOP NODES - Projetos (Execution ‚Üî Director)
            if (currentMode === 'projetos') {
                const loopExecFiles = projectFiles.filter(f => /_v(\d+)\.(json|md)$/i.test(f.name) && f.name.includes('EXECUTION_DESIGN'));
                const loopPropFiles = projectFiles.filter(f => /_v(\d+)\.(json|md)$/i.test(f.name) && f.name.includes('PROPOSAL'));
                const loopDirFiles = projectFiles.filter(f => /_v(\d+)\.(json|md)$/i.test(f.name) && f.name.includes('DIRECTOR'));
                
                // Agrupar por vers√£o (v2, v3...)
                const loopVersions = new Set();
                [...loopExecFiles, ...loopPropFiles, ...loopDirFiles].forEach(f => {
                    const match = f.name.match(/_v(\d+)\./);
                    if (match) loopVersions.add(parseInt(match[1]));
                });
                
                const sortedVersions = [...loopVersions].sort((a,b) => a - b);
                
                sortedVersions.forEach((ver, idx) => {
                    // Node EXECUTION v2/v3
                    const execNode = document.getElementById('p4'); // EXECUTION_DESIGN original
                    const dirNode = document.getElementById('p6'); // DIRECTOR original
                    
                    if (execNode) {
                        const execTop = parseInt(execNode.style.top) || 1150;
                        const execLeft = parseInt(execNode.style.left) || 0;
                        const offset = (idx + 1) * 380; // Cada rodada de loop fica √† direita
                        
                        // EXECUTION vN
                        const execEl = document.createElement('div');
                        execEl.className = 'node';
                        execEl.setAttribute('data-provider', 'loop-exec');
                        execEl.id = `loop-exec-${ver}`;
                        execEl.style.position = 'absolute';
                        execEl.style.left = savedPositions[`loop-exec-${ver}`]?.left || `${execLeft + offset}px`;
                        execEl.style.top = savedPositions[`loop-exec-${ver}`]?.top || `${execTop}px`;
                        execEl.style.transform = 'none';
                        execEl.innerHTML = `
                            <div class="node-led"></div>
                            <div class="node-id">LOOP v${ver} // Revision</div>
                            <div class="node-title">EXECUTION v${ver}</div>
                            <div class="node-subtext">GEMINI PRO (LOOP ${ver})</div>
                        `;
                        execEl.ondblclick = () => {
                            const file = projectFiles.find(f => f.name.includes(`EXECUTION_DESIGN_v${ver}`));
                            if (file) openPanel({ id: `loop-exec-${ver}`, title: `EXECUTION DESIGN v${ver}` }, projectFiles);
                        };
                        container.appendChild(execEl);
                        makeDraggable(execEl);
                        
                        // PROPOSAL vN
                        const propEl = document.createElement('div');
                        propEl.className = 'node';
                        propEl.setAttribute('data-provider', 'loop-prop');
                        propEl.id = `loop-prop-${ver}`;
                        propEl.style.position = 'absolute';
                        propEl.style.left = savedPositions[`loop-prop-${ver}`]?.left || `${execLeft + offset}px`;
                        propEl.style.top = savedPositions[`loop-prop-${ver}`]?.top || `${execTop + 200}px`;
                        propEl.style.transform = 'none';
                        propEl.innerHTML = `
                            <div class="node-led"></div>
                            <div class="node-id">LOOP v${ver} // Revision</div>
                            <div class="node-title">PROPOSAL v${ver}</div>
                            <div class="node-subtext">GPT-5.1 (LOOP ${ver})</div>
                        `;
                        propEl.ondblclick = () => {
                            const file = projectFiles.find(f => f.name.includes(`PROPOSAL_v${ver}`));
                            if (file) openPanel({ id: `loop-prop-${ver}`, title: `PROPOSAL v${ver}` }, projectFiles);
                        };
                        container.appendChild(propEl);
                        makeDraggable(propEl);
                        
                        // DIRECTOR vN
                        const dirEl = document.createElement('div');
                        dirEl.className = 'node';
                        dirEl.setAttribute('data-provider', 'loop-dir');
                        dirEl.id = `loop-dir-${ver}`;
                        dirEl.style.position = 'absolute';
                        dirEl.style.left = savedPositions[`loop-dir-${ver}`]?.left || `${execLeft + offset}px`;
                        dirEl.style.top = savedPositions[`loop-dir-${ver}`]?.top || `${execTop + 400}px`;
                        dirEl.style.transform = 'none';
                        dirEl.innerHTML = `
                            <div class="node-led"></div>
                            <div class="node-id">LOOP v${ver} // Revision</div>
                            <div class="node-title">DIRECTOR v${ver}</div>
                            <div class="node-subtext">GEMINI PRO (LOOP ${ver})</div>
                        `;
                        dirEl.ondblclick = () => {
                            const file = projectFiles.find(f => f.name.includes(`DIRECTOR_v${ver}`));
                            if (file) openPanel({ id: `loop-dir-${ver}`, title: `DIRECTOR v${ver}` }, projectFiles);
                        };
                        container.appendChild(dirEl);
                        makeDraggable(dirEl);
                    }
                });
            }

            // DYNAMIC REVISION NODES - Detecta arquivos REVISAO_1, REVISAO_2... e cria n√≥s ao lado do HUMAN
            const revisionFiles = projectFiles.filter(f => /REVISAO_\d+/.test(f.name));
            activeRevisionLinks = [];
            
            // ID do HUMAN node depende do modo atual
            const humanNodeId = currentMode === 'projetos' ? 'p9' : currentMode === 'ideias' ? 'i5' : 'n9';
            
            revisionFiles.forEach((revFile, idx) => {
                const revNum = revFile.name.match(/REVISAO_(\d+)/)[1];
                const revId = `rev${revNum}`;
                const revNode = {
                    id: revId,
                    title: `REVIS√ÉO ${revNum}`,
                    label: `Revision_${revNum}`,
                    model: 'CLAUDE SONNET'
                };
                
                const el = document.createElement('div');
                el.className = 'node';
                el.setAttribute('data-provider', 'revision');
                el.id = revId;
                el.style.position = 'absolute';
                
                // Posi√ß√£o: ao lado direito do HUMAN node, perfeitamente alinhado
                const humanNode = document.getElementById(humanNodeId);
                if (humanNode && !savedPositions[revId]) {
                    // Usar as coordenadas de estilo do HUMAN diretamente para garantir alinhamento perfeito
                    const humanLeft = parseInt(humanNode.style.left) || humanNode.offsetLeft;
                    const humanTop = parseInt(humanNode.style.top) || humanNode.offsetTop;
                    const humanWidth = 320; // Largura fixa de todos os n√≥s
                    const gap = 50; // Gap entre n√≥s
                    const baseX = humanLeft + humanWidth + gap;
                    const offsetX = (idx * (humanWidth + gap)); // Cada revis√£o adicional se afasta mais 370px
                    el.style.left = `${baseX + offsetX}px`;
                    el.style.top = `${humanTop}px`; // Mesma altura exata do HUMAN
                } else if (savedPositions[revId]) {
                    el.style.left = savedPositions[revId].left;
                    el.style.top = savedPositions[revId].top;
                } else {
                    el.style.left = `${centerX + 400 + (idx * 370)}px`;
                    el.style.top = `2050px`;
                }
                
                el.style.transform = 'none';
                
                el.innerHTML = `
                    <div class="node-led"></div>
                    <div class="node-id">${revId.toUpperCase()} // Revision_${revNum}</div>
                    <div class="node-title">REVIS√ÉO ${revNum}</div>
                    <div class="node-subtext">CLAUDE SONNET</div>
                    <div class="flex gap-2 mt-4 pt-4 border-t border-[#222]">
                        <button onclick="approveRevision('${selectedJobId}', ${revNum}, event)" class="flex-1 bg-[#22c55e] text-white font-brick text-[9px] py-2 hover:bg-white hover:text-black transition-colors">‚úì APROVAR</button>
                        <button onclick="rejectRevision('${selectedJobId}', ${revNum}, event)" class="flex-1 border border-[#444] text-[#666] font-brick text-[9px] py-2 hover:border-white hover:text-white transition-colors">‚úó REJEITAR</button>
                    </div>
                `;
                
                el.ondblclick = () => openPanel(revNode, projectFiles);
                container.appendChild(el);
                makeDraggable(el);
                
                // Adicionar link √† lista global de revis√µes
                activeRevisionLinks.push([humanNodeId, revId]);
            });

            // Esperar o navegador renderizar os novos n√≥s antes de desenhar as linhas
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    updateConnections(activeRevisionLinks);
                });
            });
            updateTelemetry(projectFiles);
        }

        function updateConnections(revisionLinks = []) {
            const svg = document.getElementById('conn-svg');
            svg.innerHTML = '';
            
            let currentLinks = [...linksMarketing];
            if (currentMode === 'projetos') currentLinks = [...linksProjetos];
            if (currentMode === 'ideias') currentLinks = [...linksIdeias];

            // CONDICIONAL: Se Wall rejeitou e existe loop aprovado, redirecionar fluxo
            if (currentMode === 'marketing') {
                const lastApprovedWall = document.getElementById('loop-wall-3') || document.getElementById('loop-wall-2');
                if (lastApprovedWall) {
                    currentLinks = currentLinks.filter(([f,t]) => !(f === 'n8' && t === 'n9'));
                    currentLinks.push([lastApprovedWall.id, 'n9']);
                }
            }
            
            // CONDICIONAL: Se Director rejeitou e existe loop, redirecionar fluxo em Projetos
            if (currentMode === 'projetos') {
                // Detectar vers√µes de loop existentes
                const loopVersions = [];
                for (let v = 2; v <= 4; v++) {
                    if (document.getElementById(`loop-exec-${v}`)) loopVersions.push(v);
                }
                
                if (loopVersions.length > 0) {
                    // Director original ‚Üí Execution v2 (seta de retorno/loop)
                    currentLinks.push(['p6', `loop-exec-${loopVersions[0]}`]);
                    
                    // Dentro de cada vers√£o: Exec ‚Üí Prop ‚Üí Dir
                    loopVersions.forEach(v => {
                        currentLinks.push([`loop-exec-${v}`, `loop-prop-${v}`]);
                        currentLinks.push([`loop-prop-${v}`, `loop-dir-${v}`]);
                    });
                    
                    // Entre vers√µes: Dir v2 ‚Üí Exec v3
                    for (let i = 0; i < loopVersions.length - 1; i++) {
                        currentLinks.push([`loop-dir-${loopVersions[i]}`, `loop-exec-${loopVersions[i+1]}`]);
                    }
                    
                    // √öltimo Director do loop ‚Üí HUMAN (substituindo Director original)
                    const lastVer = loopVersions[loopVersions.length - 1];
                    currentLinks = currentLinks.filter(([f,t]) => !(f === 'p6' && t === 'p9'));
                    currentLinks.push([`loop-dir-${lastVer}`, 'p9']);
                }
            }

            // Desenhar links normais do pipeline
            currentLinks.forEach(([fId, tId]) => {
                const f = document.getElementById(fId), t = document.getElementById(tId);
                if(!f || !t) return;
                
                const fR = f.getBoundingClientRect(), tR = t.getBoundingClientRect(), cR = document.getElementById('node-container').getBoundingClientRect();
                const x1 = fR.left + fR.width/2 - cR.left, y1 = fR.top + fR.height/2 - cR.top;
                const x2 = tR.left + tR.width/2 - cR.left, y2 = tR.top + tR.height/2 - cR.top;
                
                if (isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2) || !isFinite(x1) || !isFinite(y1) || !isFinite(x2) || !isFinite(y2)) return;

                const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
                line.setAttribute("d", `M ${x1} ${y1} L ${x1} ${y1 + (y2-y1)/2} L ${x2} ${y1 + (y2-y1)/2} L ${x2} ${y2}`);
                
                const isActive = !f.classList.contains('disabled') && !t.classList.contains('disabled');
                line.setAttribute("class", `conn-line ${isActive ? 'active' : ''}`);
                svg.appendChild(line);

                if(!f.classList.contains('disabled') && !t.classList.contains('disabled')) {
                    const pulse = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    pulse.setAttribute("r", "2"); pulse.setAttribute("class", "pulse-dot");
                    const anim = document.createElementNS("http://www.w3.org/2000/svg", "animateMotion");
                    anim.setAttribute("path", `M ${x1} ${y1} L ${x1} ${y1 + (y2-y1)/2} L ${x2} ${y1 + (y2-y1)/2} L ${x2} ${y2}`);
                    anim.setAttribute("dur", "3s"); anim.setAttribute("repeatCount", "indefinite");
                    pulse.appendChild(anim); svg.appendChild(pulse);
                }
            });
            
            // Desenhar links de revis√£o (estilo diferente)
            revisionLinks.forEach(([fId, tId]) => {
                const f = document.getElementById(fId), t = document.getElementById(tId);
                if(!f || !t) return;
                
                const fR = f.getBoundingClientRect(), tR = t.getBoundingClientRect(), cR = document.getElementById('node-container').getBoundingClientRect();
                
                // Linha reta horizontal da direita do HUMAN para a esquerda da REVIS√ÉO
                const x1 = fR.right - cR.left;
                const y1 = fR.top - cR.top + fR.height / 2;
                const x2 = tR.left - cR.left;
                const y2 = tR.top - cR.top + tR.height / 2;
                
                if (isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2)) return;

                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", x1);
                line.setAttribute("y1", y1);
                line.setAttribute("x2", x2);
                line.setAttribute("y2", y2);
                line.setAttribute("stroke", "#f97316");
                line.setAttribute("stroke-width", "2");
                line.setAttribute("stroke-dasharray", "5,5");
                line.setAttribute("opacity", "0.7");
                svg.appendChild(line);
            });
            
            // Desenhar linhas do loop autom√°tico - DESABILITADO (Gabriel pediu pra esconder)
            // const loopLinks = [];
            // if (document.getElementById('loop-copy-2')) loopLinks.push(['n8', 'loop-copy-2']);
            // if (document.getElementById('loop-copy-2') && document.getElementById('loop-wall-2')) loopLinks.push(['loop-copy-2', 'loop-wall-2']);
            // if (document.getElementById('loop-copy-3')) loopLinks.push(['loop-wall-2', 'loop-copy-3']);
            // if (document.getElementById('loop-copy-3') && document.getElementById('loop-wall-3')) loopLinks.push(['loop-copy-3', 'loop-wall-3']);
        }

        function makeDraggable(el) {
            let p1=0,p2=0,p3=0,p4=0; 
            el.onmousedown = (e) => {
                if (e.target.tagName === 'BUTTON') return;
                e.preventDefault(); p3=e.clientX; p4=e.clientY;
                el.style.zIndex = '100';
                document.onmouseup = () => { 
                    el.style.zIndex = '10';
                    const nodePositions = JSON.parse(localStorage.getItem(`node_positions_${currentMode}`) || '{}');
                    nodePositions[el.id] = { left: `${el.offsetLeft}px`, top: `${el.offsetTop}px` };
                    localStorage.setItem(`node_positions_${currentMode}`, JSON.stringify(nodePositions));
                    updateLayoutIndicator();
                    document.onmouseup = null; document.onmousemove = null; 
                };
                document.onmousemove = (e) => {
                    p1=p3-e.clientX; p2=p4-e.clientY; p3=e.clientX; p4=e.clientY;
                    el.style.top = (el.offsetTop-p2)+"px"; el.style.left = (el.offsetLeft-p1)+"px";
                    updateConnections(activeRevisionLinks);
                };
            };
        }

        function formatJSON(json) {
            function formatValue(val, key) {
                if (typeof val === 'boolean') return val ? '<span class="text-green-500">‚úì</span>' : '<span class="text-red-500">‚úó</span>';
                if (typeof val === 'number') {
                    const isScore = key && (key.includes('score') || key.includes('nota') || key.includes('pontos'));
                    if (isScore) {
                        const color = val >= 80 ? 'text-green-500' : val >= 60 ? 'text-yellow-500' : 'text-red-500';
                        return `<span class="${color} font-bold">${val}</span>`;
                    }
                    return `<span class="text-white">${val}</span>`;
                }
                if (typeof val === 'string') {
                    const statusColors = { 
                        'PASS': 'bg-green-900 text-green-400', 
                        'APPROVED': 'bg-green-900 text-green-400', 
                        'APROVAR': 'bg-green-900 text-green-400',
                        'FAIL': 'bg-red-900 text-red-400', 
                        'REJECTED': 'bg-red-900 text-red-400',
                        'REFINAR': 'bg-yellow-900 text-yellow-400',
                        'REPENSAR': 'bg-red-900 text-red-400'
                    };
                    if (statusColors[val]) return `<span class="px-3 py-1 text-xs font-mono font-bold uppercase tracking-wider ${statusColors[val]}">${val}</span>`;
                    if (val.length > 200) return `<div class="text-[#ddd] leading-relaxed mt-3 mb-3 p-4 bg-[#0a0a0a] border-l-2 border-[#DC2626] prose-sm max-w-none">${safeMarkdown(val)}</div>`;
                    return `<span class="text-[#ccc]">${val}</span>`;
                }
                return val;
            }
            function renderAny(val, key, depth) {
                if (val === null || val === undefined) return '<span class="text-[#666] italic">--</span>';
                if (Array.isArray(val)) return '<div class="space-y-2 mt-2">' + val.map(item => typeof item === 'object' ? renderAny(item, key, depth+1) : `<div class="text-sm text-[#aaa]">‚Ä¢ ${item}</div>`).join('') + '</div>';
                if (typeof val === 'object') return `<div class="${depth > 0 ? 'pl-4 mt-2' : ''} space-y-3">${Object.entries(val).map(([k,v]) => `<div class="text-sm leading-relaxed"><span class="text-[#888] font-mono font-semibold">${k.replace(/_/g,' ')}:</span> ${renderAny(v, k, depth+1)}</div>`).join('')}</div>`;
                return formatValue(val, key);
            }
            let html = '<div class="space-y-6">';
            for (const [key, value] of Object.entries(json)) {
                html += `<div class="border-b border-[#222] pb-5"><div class="text-sm font-mono text-[#DC2626] uppercase tracking-wider mb-3 font-semibold">${key.replace(/_/g, ' ')}</div>${renderAny(value, key, 0)}</div>`;
            }
            return html + '</div>';
        }

        function openPanel(n, files) {
            const searchTerms = fileMapping[n.title] || [n.title];
            // Se o titulo contiver "v2" ou "v3", permitir arquivos versionados; senao filtrar
            const isLoopNode = /v\d+/.test(n.title);
            const file = files.find(f => {
                if (!isLoopNode && /_v\d+\.(json|md)$/i.test(f.name)) return false;
                return searchTerms.some(term => f.name.toUpperCase().includes(term.toUpperCase()));
            });
            
            const body = document.getElementById('panel-body');
            
            // RAW_IDEA em Ideias: mostra briefing original (da pasta briefing), n√£o o RAW_IDEA do WIP
            if (n.title === 'RAW_IDEA') {
                const briefingFile = files.find(f => f.path && f.path.startsWith('briefing/'));
                if (briefingFile && briefingFile.content) {
                    let c = briefingFile.content;
                    const match = c.match(/^#\s*(?:BRIEFING:|RAW IDEA:).*\n([\s\S]*)$/m);
                    body.innerHTML = `<div class="bg-[#0a0a0a] border border-[#222] p-8 font-mono text-sm leading-relaxed text-[#ccc] whitespace-pre-wrap">${match ? match[1].trim() : c}</div>`;
                    document.getElementById('panel-title').textContent = 'RAW IDEA // INPUT ORIGINAL';
                    document.getElementById('agent-panel').classList.add('open');
                    return;
                }
            }
            
            // DOUGLAS em Ideias: mostra PROCESSED.md, fallback para RAW_IDEA.md
            if (n.title === 'DOUGLAS' && currentMode === 'ideias') {
                const processedFile = files.find(f => f.name.toUpperCase().includes('PROCESSED'));
                const rawFile = files.find(f => f.name.toUpperCase().includes('RAW_IDEA'));
                const douglasFile = processedFile || rawFile;
                if (douglasFile && douglasFile.content) {
                    body.innerHTML = `<div class="bg-[#0a0a0a] border border-[#222] p-8 font-mono text-sm leading-relaxed text-[#ccc] whitespace-pre-wrap">${douglasFile.content}</div>`;
                    document.getElementById('panel-title').textContent = processedFile ? 'DOUGLAS // BRIEFING PROCESSADO' : 'DOUGLAS // RAW IDEA (sem processamento)';
                    document.getElementById('agent-panel').classList.add('open');
                    return;
                }
            }

            if (n.title === 'BRIEFING_INPUT') {
                const rawContent = getBriefingContent(files);
                if (rawContent) {
                    body.innerHTML = `<div class="bg-[#0a0a0a] border border-[#222] p-8 font-mono text-sm leading-relaxed text-[#ccc] whitespace-pre-wrap">${rawContent}</div>`;

            if (n.title === 'DECISION' && file) {
                try {
                    const viability = JSON.parse(file.content);
                    const score = viability.viability_assessment?.score_final || 0;
                    const decision = viability.recommendation?.decision || 'N/A';
                    const reasoning = viability.recommendation?.reasoning || '';
                    const nota = viability.nota_final || '';
                    let statusColor = '#666';
                    let statusLabel = decision;
                    if (decision === 'GO') { statusColor = '#10b981'; statusLabel = '‚úì GO'; }
                    else if (decision === 'NO-GO') { statusColor = '#ef4444'; statusLabel = '‚úó NO-GO'; }
                    else if (decision === 'REVISIT') { statusColor = '#f59e0b'; statusLabel = '‚ö† REVISIT'; }
                    else if (decision === 'CONDITIONAL GO') { statusColor = '#3b82f6'; statusLabel = '‚ö° CONDITIONAL GO'; }
                    body.innerHTML = `<div class="p-8 bg-[#0a0a0a] border border-[#222]">
                        <div class="text-center mb-8">
                            <div class="text-6xl font-bold mb-4" style="color: ${statusColor}">${score}/100</div>
                            <div class="text-2xl font-bold mb-2" style="color: ${statusColor}">${statusLabel}</div>
                        </div>
                        <div class="border-t border-[#222] pt-6">
                            <h3 class="text-xl font-bold mb-4 text-[#fff]">REASONING</h3>
                            <p class="text-[#ccc] leading-relaxed whitespace-pre-wrap">${reasoning}</p>
                        </div>
                        ${nota ? `<div class="border-t border-[#222] pt-6 mt-6"><h3 class="text-xl font-bold mb-4 text-[#fff]">NOTA FINAL</h3><p class="text-[#ccc] leading-relaxed whitespace-pre-wrap">${nota}</p></div>` : ''}
                        <div class="border-t border-[#222] pt-6 mt-6 text-center">
                            <button onclick="viewFullViability('${n.id}')" class="bg-[#DC2626] hover:bg-white hover:text-black text-white font-bold py-3 px-6 text-xs uppercase tracking-wider transition-all">
                                VER AN√ÅLISE COMPLETA
                            </button>
                        </div>
                    </div>`;
                    document.getElementById('panel-title').textContent = 'VEREDITO FINAL';
                    document.getElementById('agent-panel').classList.add('open');
                    return;
                } catch(e) { console.error('Erro ao parsear VIABILITY:', e); }
            }
                    document.getElementById('panel-title').textContent = 'BRIEFING ORIGINAL';
                    document.getElementById('agent-panel').classList.add('open');
                    return;
                }
            }

            if (file) {
                let content = file.content;
                try { const json = JSON.parse(content); content = formatJSON(json); } catch(e) { content = safeMarkdown(content); }
                body.innerHTML = content;
            } else {
                body.innerHTML = '<div class="p-8 text-center text-[#444] italic">Aguardando execu√ß√£o do agente...</div>';
            }
            document.getElementById('panel-title').textContent = n.title;
            document.getElementById('agent-panel').classList.add('open');
        }

        function closePanel() { document.getElementById('agent-panel').classList.remove('open'); }
        
        function viewFullViability(nodeId, projectFiles) {
            // Abre o painel com o JSON completo da VIABILITY (node i4)
            const nodeDef = currentMode === 'ideias' ? nodeDefIdeias.find(n => n.title === 'VIABILITY') : null;
            if (!nodeDef) return;
            const files = projectFiles.filter(f => {
                const patterns = fileMapping['VIABILITY'] || [];
                return patterns.some(p => f.name.includes(p));
            });
            const file = files.length ? files[0] : null;
            if (!file) return;
            const body = document.getElementById('panel-body');
            try {
                const json = JSON.parse(file.content);
                const score = json.viability_assessment?.score_final || 'N/A';
                const status = json.viability_assessment?.status || 'UNKNOWN';
                
                // Determinar cor baseada no score
                let scoreColor = '#666';
                if (typeof score === 'number') {
                    if (score >= 70) scoreColor = '#22c55e'; // Verde
                    else if (score >= 40) scoreColor = '#f59e0b'; // Laranja
                    else scoreColor = '#ef4444'; // Vermelho
                }
                
                body.innerHTML = `
                    <div style="background: #0a0a0a; border: 2px solid ${scoreColor}; padding: 20px; margin-bottom: 24px; text-align: center;">
                        <div style="font-family: 'Inter', sans-serif; font-weight: 900; font-size: 48px; color: ${scoreColor}; line-height: 1;">${score}</div>
                        <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #888; margin-top: 8px; text-transform: uppercase; letter-spacing: 2px;">${status}</div>
                    </div>
                    ${formatJSON(json)}
                `;
                document.getElementById('panel-title').textContent = 'VIABILITY (AN√ÅLISE COMPLETA)';
            } catch(e) {
                body.innerHTML = `<pre class="whitespace-pre-wrap text-sm font-mono text-[#ccc]">${file.content}</pre>`;
                document.getElementById('panel-title').textContent = 'VIABILITY (AN√ÅLISE COMPLETA)';
            }
            // Abrir o painel
            document.getElementById('agent-panel').classList.add('open');
        }
        
        function openNewBriefing() {
            document.getElementById('briefing-modal').classList.remove('hidden');
            const draft = JSON.parse(localStorage.getItem('briefing_draft') || '{}');
            if (draft.title || draft.content) {
                document.getElementById('briefing-title').value = draft.title || '';
                document.getElementById('briefing-content').value = draft.content || '';
                document.getElementById('briefing-mode').value = draft.mode || currentMode || 'marketing';
                showNotification('üìù Rascunho recuperado do LocalStorage');
            } else {
                document.getElementById('briefing-title').value = '';
                document.getElementById('briefing-content').value = '';
                document.getElementById('briefing-mode').value = currentMode || 'marketing';
            }
            updateCostEstimate();
        }

        function saveBriefingDraft() {
            const draft = {
                title: document.getElementById('briefing-title').value,
                content: document.getElementById('briefing-content').value,
                mode: document.getElementById('briefing-mode').value
            };
            localStorage.setItem('briefing_draft', JSON.stringify(draft));
        }

        function clearBriefingDraft() {
            localStorage.removeItem('briefing_draft');
        }
        
        async function updateCostEstimate() {
            const mode = document.getElementById('briefing-mode').value;
            try {
                const res = await fetch(`${API_URL}/estimate?mode=${mode}`);
                const data = await res.json();
                document.getElementById('cost-value').textContent = `$${data.totalCost}`;
                document.getElementById('steps-value').textContent = data.steps;
            } catch(e) {}
        }
        
        function closeBriefingModal() { document.getElementById('briefing-modal').classList.add('hidden'); }
        
        async function submitBriefing() {
            const title = document.getElementById('briefing-title').value.trim();
            const content = document.getElementById('briefing-content').value.trim();
            const mode = document.getElementById('briefing-mode').value;
            if (!title || !content) { showNotification('‚ö†Ô∏è Preencha todos os campos.', 'error'); return; }
            try {
                const res = await fetch(`${API_URL}/briefing`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': 'brick-squad-2026' },
                    body: JSON.stringify({ title, content, mode })
                });
                if (res.ok) { 
                    clearBriefingDraft();
                    closeBriefingModal(); 
                    showNotification(`‚úÖ Briefing "${title}" criado!`); 
                    setTimeout(fetchState, 1000); 
                }
            } catch(e) {}
        }

        function openFeedbackModal(e) { e.stopPropagation(); document.getElementById('feedback-modal').classList.remove('hidden'); document.getElementById('feedback-text').value = ''; }
        function closeFeedbackModal() { document.getElementById('feedback-modal').classList.add('hidden'); }
        async function submitFeedback() {
            const feedback = document.getElementById('feedback-text').value.trim();
            if (!feedback) return;
            try {
                const res = await fetch(`${API_URL}/feedback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': 'brick-squad-2026' },
                    body: JSON.stringify({ jobId: selectedJobId, mode: currentMode, feedback: feedback })
                });
                if (res.ok) { closeFeedbackModal(); showNotification('‚úÖ FEEDBACK ENVIADO!'); }
            } catch(e) {}
        }

        function aprovarCampanha(e) {
            e.stopPropagation();
            document.getElementById('approval-project').textContent = document.getElementById('ng-title').textContent;
            document.getElementById('approval-modal').classList.remove('hidden');
        }
        function closeApprovalModal() { document.getElementById('approval-modal').classList.add('hidden'); }
        async function confirmApproval() {
            try {
                const res = await fetch(`${API_URL}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': 'brick-squad-2026' },
                    body: JSON.stringify({ jobId: selectedJobId, mode: currentMode })
                });
                if (res.ok) { closeApprovalModal(); closeNodeGraphic(); showNotification('üéâ CAMPANHA APROVADA!'); setTimeout(fetchState, 1000); }
            } catch(e) {}
        }

        async function rerunJob() {
            if (!confirm('‚ö†Ô∏è Reiniciar pipeline do zero?')) return;
            try {
                const res = await fetch(`${API_URL}/rerun`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': 'brick-squad-2026' },
                    body: JSON.stringify({ jobId: selectedJobId, mode: currentMode })
                });
                if (res.ok) showNotification('üîÑ Job reiniciado!');
            } catch(e) {}
        }

        function showNotification(msg, type = 'success') {
            const n = document.createElement('div');
            n.className = `fixed top-8 right-8 z-[400] bg-${type === 'error' ? 'red' : 'green'}-600 text-white px-6 py-4 font-mono text-sm border border-${type === 'error' ? 'red' : 'green'}-500 shadow-2xl`;
            n.textContent = msg; document.body.appendChild(n); setTimeout(() => n.remove(), 4000);
        }

        async function approveRevision(jobId, revNum, e) {
            e.stopPropagation();
            if (!confirm(`Aprovar REVIS√ÉO ${revNum}? Isso substituir√° o conte√∫do original.`)) return;
            try {
                const res = await fetch(`${API_URL}/revisions/${jobId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': 'brick-squad-2026' },
                    body: JSON.stringify({ mode: currentMode, revisionNumber: revNum })
                });
                if (res.ok) { showNotification(`‚úÖ REVIS√ÉO ${revNum} APROVADA!`); setTimeout(fetchState, 1000); }
            } catch(err) { showNotification('‚ùå Erro ao aprovar revis√£o', 'error'); }
        }

        async function rejectRevision(jobId, revNum, e) {
            e.stopPropagation();
            if (!confirm(`Rejeitar REVIS√ÉO ${revNum}? O arquivo ser√° movido para hist√≥rico.`)) return;
            try {
                const res = await fetch(`${API_URL}/revisions/${jobId}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': 'brick-squad-2026' },
                    body: JSON.stringify({ mode: currentMode, revisionNumber: revNum })
                });
                if (res.ok) { showNotification(`üóëÔ∏è REVIS√ÉO ${revNum} REJEITADA`); setTimeout(fetchState, 1000); }
            } catch(err) { showNotification('‚ùå Erro ao rejeitar revis√£o', 'error'); }
        }

        function getJobRevisionInfo(jobId) {
            if (!currentState) return { status: null };
            const rev = currentState.revisions?.find(r => r.job_id === jobId || (r.filename && r.filename.includes(jobId)));
            const feedback = currentState.pendingFeedbacks?.find(f => f.jobId === jobId);
            if (rev && rev.status === 'pending') return { status: 'pending' };
            if (feedback) return { status: 'feedback_pending' };
            return { status: null };
        }

        async function loadRevisionData(jobId) {
            try { const res = await fetch(`${API_URL}/revisions/${jobId}?mode=${currentMode}`); return await res.json(); } catch(e) { return null; }
        }

        function openRevisionModal(jobId, title) {
            document.getElementById('revision-job-title').textContent = title || jobId;
            document.getElementById('revision-modal').classList.remove('hidden');
            loadRevisionData(jobId).then(data => {
                const content = document.getElementById('revision-tab-content');
                if (!data || !data.hasRevision) { content.innerHTML = '<div class="text-center py-12 font-mono">Nenhuma revis√£o dispon√≠vel.</div>'; return; }
                currentRevisionData = data;
                renderRevisionTab('sidebyside');
            });
        }

        function closeRevisionModal() { document.getElementById('revision-modal').classList.add('hidden'); }
        function switchRevisionTab(tab, btn) { document.querySelectorAll('.rev-tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderRevisionTab(tab); }
        function renderRevisionTab(tab) {
            const c = document.getElementById('revision-tab-content');
            const { original, revision } = currentRevisionData;
            if (tab === 'sidebyside') {
                c.innerHTML = `<div class="flex gap-4 h-full"><div class="comparison-col bg-[#0a0a0a] border border-[#222]"><h4>Original</h4><div class="text-sm text-[#aaa]">${safeMarkdown(original?.content || '')}</div></div><div class="comparison-col bg-[#0a0a0a] border border-green-900"><h4>Revis√£o</h4><div class="text-sm text-[#ccc]">${safeMarkdown(revision?.content || '')}</div></div></div>`;
            }
        }

        async function revisionAction(action) {
            const jobId = currentRevisionData.jobId;
            try {
                const res = await fetch(`${API_URL}/revisions/${jobId}/${action === 'approve' ? 'approve' : 'reject'}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: currentMode })
                });
                if (res.ok) { closeRevisionModal(); fetchState(); }
            } catch(e) {}
        }

        let socket = null;
        function initWebSocket() {
            try {
                // SECURITY: Pass API key for WebSocket authentication
                socket = io({
                    auth: {
                        apiKey: 'brick-squad-2026'
                    }
                });
                socket.on('connect', () => { 
                    document.getElementById('connection-status').textContent = 'WebSocket_Active';
                    if (currentMode) socket.emit('subscribe', currentMode);
                });
                socket.on('stateUpdate', (state) => { if (state.mode === currentMode) fetchState(); });
            } catch(e) {}
        }
        
        // enterMode j√° definido acima (linha ~558)
        
        function confirmDeleteProject() {
            if (!currentJobId || !currentMode) {
                showNotification('‚ö†Ô∏è Nenhum projeto selecionado', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[300]';
            modal.innerHTML = `
                <div class="bg-[#050505] border border-[#DC2626] p-8 max-w-md">
                    <h3 class="font-brick text-xl text-white uppercase mb-4">‚ö†Ô∏è DELETAR PROJETO</h3>
                    <p class="text-[#ccc] text-sm mb-6 font-mono">Essa a√ß√£o √© IRREVERS√çVEL. Todos os arquivos deste projeto ser√£o deletados permanentemente.</p>
                    <p class="text-white text-sm mb-6 font-bold">Projeto: ${currentJobId}</p>
                    <div class="flex gap-4">
                        <button onclick="this.closest('div.fixed').remove()" class="flex-1 bg-[#222] hover:bg-[#333] text-white font-mono text-xs uppercase py-3 px-6 transition-all">
                            Cancelar
                        </button>
                        <button onclick="deleteProject(); this.closest('div.fixed').remove()" class="flex-1 bg-[#DC2626] hover:bg-white hover:text-black text-white font-mono text-xs uppercase py-3 px-6 transition-all">
                            ‚úï Deletar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function deleteProject() {
            if (!currentJobId || !currentMode) return;
            
            try {
                const res = await fetch(`${API_URL}/project/${currentJobId}?mode=${currentMode}`, {
                    method: 'DELETE',
                    headers: { 'X-API-Key': 'brick-squad-2026' }
                });
                const data = await res.json();
                
                if (data.success) {
                    showNotification(`‚úì Projeto deletado (${data.deletedCount} arquivos)`, 'success');
                    closeNodeGraphic();
                    fetchState();
                } else {
                    showNotification('‚úó Erro ao deletar projeto', 'error');
                }
            } catch(e) {
                console.error('Erro ao deletar:', e);
                showNotification('‚úó Falha na comunica√ß√£o com o servidor', 'error');
            }
        }

        window.onload = async () => {
            // Load file mapping config first
            await loadFileMapping();
            
            // Then initialize the app
            initWebSocket();
            const savedMode = (window.location.hash || '').replace('#','') || localStorage.getItem('last_mode');
            if (savedMode) enterMode(savedMode);
        };
    </script>
</body>
</html>
