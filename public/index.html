<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRICK AI // WAR ROOM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --brick-black: #050505;
            --brick-red: #DC2626;
            --brick-gray: #9CA3AF;
            --brick-white: #E5E5E5;
        }
        body { 
            background-color: var(--brick-black); 
            color: var(--brick-white); 
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        .font-brick { font-family: 'Inter', sans-serif; font-weight: 900; letter-spacing: -0.04em; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        .column { min-height: 80vh; background: #0a0a0a; border: 1px solid #1a1a1a; }
        .card { 
            background: #0a0a0a; 
            border: 1px solid #333; 
            transition: all 0.2s; 
            position: relative;
            overflow: hidden;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 2px; height: 100%;
            background: #333;
            transition: background 0.2s;
        }
        .card:hover { border-color: var(--brick-red); }
        .card:hover::before { background: var(--brick-red); }
        
        .modal-bg { background: rgba(5,5,5,0.95); backdrop-filter: blur(10px); }
        
        /* Noise Texture */
        .noise-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0; opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; }
        ::-webkit-scrollbar-thumb:hover { background: var(--brick-red); }

        .animate-blink { animation: blink 1s step-end infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>
</head>
<body class="p-6">
    <div class="noise-overlay"></div>
    <div class="relative z-10">

    <!-- Header -->
    <header class="flex justify-between items-end mb-12 border-b border-white/10 pb-6">
        <div>
            <h1 class="text-4xl font-brick tracking-tighter text-white flex items-baseline gap-2">
                BRICK AI <span class="text-[#DC2626] text-lg font-mono tracking-widest opacity-80">WAR ROOM</span>
            </h1>
            <div class="flex items-center gap-3 mt-2 font-mono text-[10px] tracking-[0.2em] text-[#9CA3AF]">
                <span id="connection-status" class="text-[#DC2626]">CONNECTING...</span>
                <span class="text-[#333]">|</span>
                <span>SYS.VER 3.2+</span>
            </div>
        </div>
        <div class="flex items-center gap-6">
            <button onclick="openModal('architectureDiagram')" class="text-[10px] font-mono text-[#9CA3AF] hover:text-white border-b border-transparent hover:border-[#DC2626] transition-colors uppercase tracking-widest pb-1">
                View Protocols
            </button>
            <button onclick="openModal('newBriefing')" class="bg-[#DC2626] text-white px-6 py-2 font-brick text-sm tracking-wide hover:bg-red-700 transition-colors">
                + NEW BRIEFING
            </button>
        </div>
    </header>

    <!-- Modal: Architecture Diagram -->
    <div id="modal-architectureDiagram" class="fixed inset-0 modal-bg hidden flex items-center justify-center z-[60] p-4">
        <div class="bg-[#0a0a0a] border border-[#DC2626]/30 p-8 w-full max-w-5xl max-h-[90vh] shadow-[0_0_50px_rgba(220,38,38,0.1)] overflow-auto relative">
            <div class="flex justify-between items-center mb-8 border-b border-white/10 pb-4">
                <h2 class="text-xl font-brick text-white uppercase tracking-tighter">System Architecture <span class="text-[#DC2626]">//</span> Flow</h2>
                <button onclick="closeModal('architectureDiagram')" class="text-[#9CA3AF] hover:text-[#DC2626] text-2xl">&times;</button>
            </div>
            <pre class="text-[#9CA3AF] font-mono text-[11px] md:text-xs leading-tight whitespace-pre select-all">
BRIEFING
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│  01. BRIEF VALIDATOR                          Gemini Flash  │
│  ├─ Gerador de lacunas (não binário)                        │
│  ├─ questions_to_human (perguntas acionáveis)               │
│  └─ assumptions_if_silent (assume e segue)                  │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────┐     ┌─────────────────────┐
│  02. AUDIENCE       │     │  03. TOPIC          │
│  ANALYST            │ ══► │  RESEARCHER         │
│  Gemini Flash       │     │  Gemini Flash       │
└─────────────────────┘     └─────────────────────┘
    │                             │
    └──────────────┬──────────────┘
                   ▼
┌─────────────────────────────────────────────────────────────┐
│  04. CLAIMS CHECKER                           Gemini Flash  │
│  ├─ Valida dados (mantém se tiver fonte)                    │
│  ├─ Marca [NEEDS SOURCE] ou reescreve                       │
│  └─ Higieniza para Autoridade Segura                        │
└─────────────────────────────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────────────┐
│  05. COPYWRITER                          Claude Sonnet 4    │
│  ├─ Criatividade pura                                       │
│  └─ Fallback: Gemini 3 Pro (após 2 falhas)                  │
└─────────────────────────────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────────────┐
│  06. BRAND GUARDIANS (Split)                  Gemini Flash  │
│  ├─ STYLE GUARDIAN (Tom, Voz, Proibições)                   │
│  └─ POSITIONING GUARDIAN (Oferta Clara, Lógica Comercial)   │
└─────────────────────────────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────┐     ┌─────────────────────┐
│  07. CRITIC LITE    │ ──► │  08. CRITIC OPUS    │
│  Gemini Flash (65%) │     │  Claude Opus        │
└─────────────────────┘     └─────────────────────┘
                   │
                   ▼
        ┌──────────────────┐
        │  APROVADO ≥80%   │──────────────► OUTPUT
        └──────────────────┘
            </pre>
        </div>
    </div>

    <!-- Tabs -->
    <div class="flex gap-8 mb-8 border-b border-white/10 pb-0">
        <button id="tab-board" onclick="showTab('board')" class="text-white font-brick text-sm tracking-widest border-b-2 border-[#DC2626] pb-4 px-2 transition-colors">SQUAD BOARD</button>
        <button id="tab-gameboard" onclick="showTab('gameboard')" class="text-[#9CA3AF] hover:text-white font-mono text-xs tracking-widest pb-4 px-2 border-b-2 border-transparent transition-colors">GAME BOARD</button>
        <button id="tab-history" onclick="showTab('history')" class="text-[#9CA3AF] hover:text-white font-mono text-xs tracking-widest pb-4 px-2 border-b-2 border-transparent transition-colors">HISTORY</button>
        <button id="tab-architecture" onclick="showTab('architecture')" class="text-[#9CA3AF] hover:text-white font-mono text-xs tracking-widest pb-4 px-2 border-b-2 border-transparent transition-colors">ARCH</button>
    </div>

    <!-- Board -->
    <div id="view-board" class="grid grid-cols-1 md:grid-cols-3 gap-8">
        
        <!-- Column 1: Briefing -->
        <div class="column p-6">
            <h2 class="text-xs font-mono text-[#9CA3AF] border-b border-white/10 pb-4 mb-6 tracking-[0.2em]">01 // INPUT</h2>
            <div id="col-briefing" class="space-y-4">Loading...</div>
        </div>

        <!-- Column 2: WIP -->
        <div class="column p-6 relative">
            <h2 class="text-xs font-mono text-[#DC2626] border-b border-white/10 pb-4 mb-6 tracking-[0.2em] flex items-center gap-2">
                <span class="w-1.5 h-1.5 bg-[#DC2626] rounded-full animate-blink"></span> 02 // PROCESSING
            </h2>
            <div id="col-wip" class="space-y-4">Loading...</div>
        </div>

        <!-- Column 3: Done -->
        <div class="column p-6">
            <h2 class="text-xs font-mono text-white border-b border-white/10 pb-4 mb-6 tracking-[0.2em]">03 // OUTPUT</h2>
            <div id="col-done" class="space-y-4">Loading...</div>
        </div>

    </div>

    <!-- History View -->
    <div id="view-history" class="hidden">
        <div class="column p-8 border-white/10">
            <div class="flex justify-between items-center mb-8 border-b border-white/10 pb-4">
                <h2 class="text-2xl font-brick text-white tracking-tight">CAMPAIGN LOGS</h2>
                <div class="flex gap-2">
                    <button id="history-mode-list" onclick="setHistoryMode('list')" class="text-[10px] font-mono px-3 py-1 border border-[#DC2626] text-[#DC2626]">LIST</button>
                    <button id="history-mode-board" onclick="setHistoryMode('board')" class="text-[10px] font-mono px-3 py-1 border border-[#333] text-[#555]">BOARD</button>
                </div>
            </div>
            <div id="history-list" class="space-y-4">Loading...</div>
        </div>
    </div>

    <!-- Game Board View -->
    <div id="view-gameboard" class="hidden border border-white/10 bg-[#0a0a0a]">
        <div class="min-h-[90vh] relative overflow-hidden">
            <!-- Grid overlay -->
            <div class="absolute inset-0 pointer-events-none opacity-10" style="background-image: linear-gradient(rgba(220,38,38,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(220,38,38,0.1) 1px, transparent 1px); background-size: 40px 40px;"></div>
            
            <!-- Header -->
            <div class="relative z-10 p-6 border-b border-white/10 flex justify-between items-center bg-[#050505]/80 backdrop-blur">
                <div>
                    <h1 class="text-lg font-mono text-white tracking-widest">SYSTEM ARCHITECTURE MAP</h1>
                    <p class="text-[9px] text-[#9CA3AF] font-mono tracking-[0.3em] mt-1">MASON PROTOCOL v3.2</p>
                </div>
                <div class="text-right font-mono text-[9px] text-[#555]">
                    <div id="gameboard-time">--:--:--</div>
                </div>
            </div>
            
            <!-- Main SVG Board -->
            <div id="gameboard-svg" class="relative z-10 flex justify-center items-center py-12">
                <div class="text-[#DC2626] animate-blink font-mono text-xs tracking-widest">[ SYSTEM INITIALIZING ]</div>
            </div>
            
            <div id="gameboard-missions" class="hidden"></div>
        </div>
    </div>

    <!-- Architecture View -->
    <div id="view-architecture" class="hidden">
        <div class="column p-12 border-white/10 bg-[#050505]">
            <div class="max-w-4xl mx-auto">
                <div class="flex items-center gap-6 mb-16 border-b border-white/10 pb-8">
                    <div class="h-12 w-1 bg-[#DC2626]"></div>
                    <div>
                        <h2 class="text-4xl font-brick text-white tracking-tighter">SQUAD PROTOCOLS</h2>
                        <p class="text-[10px] font-mono text-[#555] uppercase tracking-[0.4em] mt-2">Classified // Internal Use Only</p>
                    </div>
                </div>
                <div id="architecture-content" class="space-y-12"></div>
            </div>
        </div>
    </div>

    <!-- Modal: New Briefing -->
    <div id="modal-newBriefing" class="fixed inset-0 modal-bg hidden flex items-center justify-center z-50">
        <div class="bg-[#0a0a0a] border border-white/10 p-8 w-full max-w-2xl shadow-2xl relative">
            <h2 class="text-2xl font-brick text-white mb-6 tracking-tight">NEW MISSION BRIEF</h2>
            <input id="briefing-title" type="text" placeholder="Mission Codename" class="w-full bg-[#111] border border-[#333] p-4 text-white mb-4 focus:outline-none focus:border-[#DC2626] font-mono text-sm placeholder-[#555]">
            <textarea id="briefing-content" rows="8" placeholder="Objectives, Targets, Constraints..." class="w-full bg-[#111] border border-[#333] p-4 text-white mb-6 focus:outline-none focus:border-[#DC2626] font-mono text-sm placeholder-[#555]"></textarea>
            <div class="flex justify-end gap-6">
                <button onclick="closeModal('newBriefing')" class="text-[#9CA3AF] hover:text-white font-mono text-xs tracking-widest">ABORT</button>
                <button onclick="submitBriefing()" class="bg-white text-black px-8 py-3 font-brick text-sm hover:bg-[#DC2626] hover:text-white transition-colors tracking-wide">INITIATE SEQUENCE</button>
            </div>
        </div>
    </div>

    <!-- Modal: File Viewer -->
    <div id="modal-viewer" class="fixed inset-0 modal-bg hidden flex items-center justify-center z-50">
        <div class="bg-[#0a0a0a] border border-white/10 w-full max-w-5xl h-[85vh] flex flex-col shadow-2xl relative">
            <div class="flex justify-between items-center p-6 border-b border-white/10 bg-[#050505]">
                <h2 id="viewer-title" class="text-lg font-mono text-white tracking-widest uppercase">FILENAME</h2>
                <button onclick="closeModal('viewer')" class="text-[#555] hover:text-[#DC2626] text-2xl">&times;</button>
            </div>
            <div id="viewer-content" class="p-8 overflow-y-auto prose prose-invert max-w-none flex-1 bg-[#0a0a0a] font-mono text-sm leading-relaxed text-[#ccc]"></div>
            <div id="viewer-actions" class="p-6 border-t border-white/10 bg-[#050505] flex justify-end gap-4"></div>
        </div>
    </div>
    </div>

    <script>
        const API_URL = '/api';

        // --- GAME BOARD RENDERER (UPDATED COLORS) ---
        function renderGameBoard(data) {
            // Priority: 1. Active WIP -> 2. Recent Done -> 3. Empty
            let activeJob = data?.wip?.find(j => j.steps);
            
            if (!activeJob && data?.done?.length > 0) {
                // Get most recent done job
                const sortedDone = [...data.done].sort((a,b) => b.name.localeCompare(a.name)); // assumindo timestamp no nome
                const lastDone = sortedDone[0];
                
                // Tenta reconstruir o estado "full success" se o arquivo tiver logs estruturados, 
                // ou cria um estado sintético de sucesso
                activeJob = {
                    title: lastDone.name.split('_').slice(1).join(' ').replace('.md', ''),
                    steps: {
                        mission: { status: 'done', output: 'Complete' },
                        douglas: { status: 'done', output: 'Complete' },
                        validator: { status: 'done', output: 'Complete' },
                        audience: { status: 'done', output: 'Complete' },
                        research: { status: 'done', output: 'Complete' },
                        claims: { status: 'done', output: 'Complete' },
                        copy: { status: 'done', output: lastDone.content }, // Põe o conteúdo final aqui pra visualização
                        brand: { status: 'done', output: 'Complete' },
                        critic: { status: 'done', output: 'Complete' },
                        opus: { status: 'done', output: 'Complete' }
                    }
                };
                
                // Se o conteúdo do arquivo tiver os logs das etapas (o que acontece se concatenarmos), 
                // poderíamos parsear. Por enquanto, assumimos "Tudo Verde" para o último job.
            }

            activeJob = activeJob || { steps: {} }; // Fallback
            const missionTitle = activeJob.title || 'SYSTEM IDLE';
            
            document.getElementById('gameboard-time').textContent = new Date().toLocaleString('pt-BR');

            // BRICK COLOR PALETTE
            const colors = {
                text: '#E5E5E5',
                textDim: '#555',
                border: '#333',
                line: '#222',
                highlight: '#DC2626', // Brick Red
                nodeBg: '#0a0a0a',
                success: '#fff',      // White for done
                active: '#DC2626'     // Red for active
            };

            const getStepColor = (stepKey) => {
                const step = activeJob.steps ? activeJob.steps[stepKey] : null;
                if (!step) return colors.border;
                if (step.status === 'done') return colors.success;
                if (step.status === 'active' || step.status === 'running') return colors.active;
                return colors.border;
            };

            const W = 1400; 
            const cx = W / 2;
            const colLeft = cx - 350;
            const colRight = cx + 350;
            const boxW = 240;
            const lgBoxW = 400;

            const yMission = 100;
            const yDouglas = 240;
            const yValidator = 380;
            const yResearch = 520;
            const yClaims = 660;
            const yCopy = 800;
            const yReview = 940;
            const yOpus = 1100;

            let html = `
            <style>
                @keyframes flowPulse { 0% { stroke-dashoffset: 24; opacity: 0.3; } 100% { stroke-dashoffset: 0; opacity: 0.8; } }
                .flow-line { stroke-dasharray: 4 4; animation: flowPulse 1s linear infinite; }
                .node-rect { transition: all 0.3s; }
                .node-group:hover .node-rect { stroke: #DC2626; stroke-width: 2; fill: #111; }
                .tech-font { font-family: 'JetBrains Mono', monospace; }
                .label-font { font-family: 'Inter', sans-serif; text-transform: uppercase; letter-spacing: 0.05em; }
            </style>
            
            <svg viewBox="0 0 ${W} 1350" preserveAspectRatio="xMidYMin meet" style="width: 100%; height: 100%;">
                <defs>
                    <linearGradient id="gradNode" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#1a1a1a;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#0a0a0a;stop-opacity:1" />
                    </linearGradient>
                </defs>

                <!-- HEADER -->
                <g transform="translate(${cx}, 50)">
                    <text y="0" text-anchor="middle" fill="#333" font-size="20" letter-spacing="0.5em" font-weight="900" class="label-font">SQUAD ARCHITECTURE</text>
                </g>
                
                <!-- 1. MISSION -->
                <g class="node-group" onclick="showNodeDetails('mission')" transform="translate(${cx}, ${yMission})">
                    <line x1="0" y1="30" x2="0" y2="${yDouglas - yMission - 60}" stroke="${colors.line}" stroke-width="1"/>
                    <rect x="${-lgBoxW/2}" y="-30" width="${lgBoxW}" height="60" fill="${colors.nodeBg}" stroke="${colors.border}" stroke-width="1" class="node-rect"/>
                    <text x="-180" y="-8" text-anchor="start" fill="${colors.textDim}" font-size="10" class="tech-font">MISSION OBJECTIVE</text>
                    <text x="-180" y="12" text-anchor="start" fill="${colors.text}" font-size="14" class="tech-font font-bold">${missionTitle.substring(0,45)}</text>
                </g>
                
                <!-- 2. DOUGLAS CORE -->
                <g class="node-group" onclick="showNodeDetails('douglas')" transform="translate(${cx}, ${yDouglas})">
                    <line x1="0" y1="50" x2="0" y2="${yValidator - yDouglas - 50}" stroke="${colors.line}" stroke-width="1" class="flow-line"/>
                    <rect x="${-lgBoxW/2}" y="-50" width="${lgBoxW}" height="100" fill="#080808" stroke="${colors.highlight}" stroke-width="1" rx="2" class="node-rect"/>
                    <text x="0" y="-10" text-anchor="middle" fill="${colors.highlight}" font-size="24" font-weight="900" letter-spacing="0.1em" class="label-font">DOUGLAS CORE</text>
                    <text x="0" y="15" text-anchor="middle" fill="#555" font-size="10" class="tech-font tracking-widest">CENTRAL COGNITIVE AUTHORITY</text>
                </g>

                <!-- 3. VALIDATOR -->
                <g class="node-group" onclick="showNodeDetails('validator')" transform="translate(${cx}, ${yValidator})">
                    <path d="M0 50 L0 70 L${colLeft - cx} 70 L${colLeft - cx} ${yResearch - yValidator - 50}" fill="none" stroke="${colors.line}" stroke-width="1" class="flow-line"/>
                    <path d="M0 50 L0 70 L${colRight - cx} 70 L${colRight - cx} ${yResearch - yValidator - 50}" fill="none" stroke="${colors.line}" stroke-width="1" class="flow-line"/>
                    <rect x="${-boxW/2}" y="-50" width="${boxW}" height="100" fill="url(#gradNode)" stroke="${getStepColor('validator')}" stroke-width="1" class="node-rect"/>
                    <text x="0" y="-10" text-anchor="middle" fill="${colors.text}" font-size="14" font-weight="bold" class="label-font">BRIEF VALIDATOR</text>
                    <text x="0" y="20" text-anchor="middle" fill="${colors.textDim}" font-size="10" class="tech-font">GATEKEEPER</text>
                </g>

                <!-- 4. RESEARCH -->
                <g class="node-group" onclick="showNodeDetails('audience')" transform="translate(${colLeft}, ${yResearch})">
                    <path d="M0 50 L0 70 L${cx - colLeft} 70 L${cx - colLeft} ${yClaims - yResearch - 50}" fill="none" stroke="${colors.line}" stroke-width="1" class="flow-line"/>
                    <rect x="${-boxW/2}" y="-50" width="${boxW}" height="100" fill="url(#gradNode)" stroke="${getStepColor('audience')}" stroke-width="1" class="node-rect"/>
                    <text x="0" y="-10" text-anchor="middle" fill="${colors.text}" font-size="14" font-weight="bold" class="label-font">AUDIENCE ANALYST</text>
                    <text x="0" y="20" text-anchor="middle" fill="${colors.textDim}" font-size="10" class="tech-font">PSYCHOGRAPHICS</text>
                </g>
                <g class="node-group" onclick="showNodeDetails('research')" transform="translate(${colRight}, ${yResearch})">
                    <path d="M0 50 L0 70 L${cx - colRight} 70 L${cx - colRight} ${yClaims - yResearch - 50}" fill="none" stroke="${colors.line}" stroke-width="1" class="flow-line"/>
                    <rect x="${-boxW/2}" y="-50" width="${boxW}" height="100" fill="url(#gradNode)" stroke="${getStepColor('research')}" stroke-width="1" class="node-rect"/>
                    <text x="0" y="-10" text-anchor="middle" fill="${colors.text}" font-size="14" font-weight="bold" class="label-font">TOPIC RESEARCHER</text>
                    <text x="0" y="20" text-anchor="middle" fill="${colors.textDim}" font-size="10" class="tech-font">CONTEXT & FACTS</text>
                </g>

                <!-- 5. CLAIMS -->
                <g class="node-group" onclick="showNodeDetails('claims')" transform="translate(${cx}, ${yClaims})">
                    <line x1="0" y1="50" x2="0" y2="${yCopy - yClaims - 50}" stroke="${colors.line}" stroke-width="1" class="flow-line"/>
                    <rect x="${-lgBoxW/2}" y="-50" width="${lgBoxW}" height="100" fill="url(#gradNode)" stroke="${getStepColor('claims')}" stroke-width="1" class="node-rect"/>
                    <text x="0" y="-10" text-anchor="middle" fill="${colors.text}" font-size="18" font-weight="bold" class="label-font">CLAIMS CHECKER</text>
                    <text x="0" y="20" text-anchor="middle" fill="${colors.textDim}" font-size="10" class="tech-font">TRUTH FILTER</text>
                </g>

                <!-- 6. COPY -->
                <g class="node-group" onclick="showNodeDetails('copy')" transform="translate(${cx}, ${yCopy})">
                    <path d="M0 50 L0 70 L${colLeft - cx} 70 L${colLeft - cx} ${yReview - yCopy - 50}" fill="none" stroke="${colors.line}" stroke-width="1" class="flow-line"/>
                    <path d="M0 50 L0 70 L${colRight - cx} 70 L${colRight - cx} ${yReview - yCopy - 50}" fill="none" stroke="${colors.line}" stroke-width="1" class="flow-line"/>
                    <rect x="${-boxW/2}" y="-50" width="${boxW}" height="100" fill="url(#gradNode)" stroke="${getStepColor('copy')}" stroke-width="1" class="node-rect"/>
                    <text x="0" y="-10" text-anchor="middle" fill="${colors.text}" font-size="16" font-weight="bold" class="label-font">COPYWRITER</text>
                    <text x="0" y="20" text-anchor="middle" fill="${colors.textDim}" font-size="10" class="tech-font">CREATION ENGINE</text>
                </g>

                <!-- 7. REVIEW -->
                <g class="node-group" onclick="showNodeDetails('brand')" transform="translate(${colLeft}, ${yReview})">
                    <path d="M0 50 L0 70 L${cx - colLeft} 70 L${cx - colLeft} ${yOpus - yReview - 70}" fill="none" stroke="${colors.line}" stroke-width="1" class="flow-line"/>
                    <rect x="${-boxW/2}" y="-50" width="${boxW}" height="100" fill="url(#gradNode)" stroke="${getStepColor('brand')}" stroke-width="1" class="node-rect"/>
                    <text x="0" y="-10" text-anchor="middle" fill="${colors.text}" font-size="14" font-weight="bold" class="label-font">BRAND GUARDIAN</text>
                    <text x="0" y="20" text-anchor="middle" fill="${colors.textDim}" font-size="10" class="tech-font">TONE & POSITION</text>
                </g>
                <g class="node-group" onclick="showNodeDetails('critic')" transform="translate(${colRight}, ${yReview})">
                    <path d="M0 50 L0 70 L${cx - colRight} 70 L${cx - colRight} ${yOpus - yReview - 70}" fill="none" stroke="${colors.line}" stroke-width="1" class="flow-line"/>
                    <rect x="${-boxW/2}" y="-50" width="${boxW}" height="100" fill="url(#gradNode)" stroke="${getStepColor('critic')}" stroke-width="1" class="node-rect"/>
                    <text x="0" y="-10" text-anchor="middle" fill="${colors.text}" font-size="14" font-weight="bold" class="label-font">CRITIC LITE</text>
                    <text x="0" y="20" text-anchor="middle" fill="${colors.textDim}" font-size="10" class="tech-font">PRE-CHECK (65%)</text>
                </g>

                <!-- 8. OPUS -->
                <g class="node-group" onclick="showNodeDetails('opus')" transform="translate(${cx}, ${yOpus})">
                    <line x1="0" y1="70" x2="0" y2="100" stroke="${colors.line}" stroke-width="1" class="flow-line"/>
                    <rect x="${-lgBoxW/2}" y="-70" width="${lgBoxW}" height="140" fill="#050505" stroke="${getStepColor('opus')}" stroke-width="2" rx="4" class="node-rect"/>
                    <text x="0" y="-15" text-anchor="middle" fill="${colors.text}" font-size="28" font-weight="900" letter-spacing="0.1em" class="label-font">CRITIC OPUS</text>
                    <text x="0" y="25" text-anchor="middle" fill="${colors.textDim}" font-size="10" class="tech-font">FINAL VERDICT</text>
                </g>

                <!-- 9. FINAL -->
                <g class="node-group" onclick="showNodeDetails('output')" transform="translate(${cx}, ${yOpus + 160})">
                     <rect x="${-boxW}" y="-30" width="${boxW * 2}" height="60" fill="${activeJob.steps?.opus?.status === 'done' ? '#DC2626' : '#0a0a0a'}" stroke="${activeJob.steps?.opus?.status === 'done' ? '#fff' : '#333'}" stroke-width="1" rx="0" class="node-rect"/>
                     <text x="0" y="5" text-anchor="middle" fill="${activeJob.steps?.opus?.status === 'done' ? '#fff' : '#555'}" font-size="12" letter-spacing="0.2em" font-bold class="label-font">
                        ⚡ FINAL DELIVERY
                    </text>
                </g>
            </svg>
            
            <div id="node-details-panel" class="fixed top-24 right-0 w-full md:w-[600px] h-[calc(100vh-6rem)] bg-[#050505]/95 border-l border-white/10 p-10 overflow-y-auto shadow-2xl z-[100] transform translate-x-full transition-transform duration-300">
                <div class="flex justify-between items-center mb-12 border-b border-white/10 pb-6">
                    <div>
                        <h3 id="detail-title" class="text-3xl font-brick text-white uppercase tracking-tighter">NODE DETAILS</h3>
                        <div class="h-1 w-20 bg-[#DC2626] mt-4"></div>
                    </div>
                    <button onclick="closeNodeDetails()" class="text-[#555] hover:text-white transition-colors text-2xl">&times;</button>
                </div>
                <div id="detail-content" class="prose prose-invert prose-p:text-[#ccc] prose-headings:font-brick prose-headings:text-white prose-pre:bg-[#111] prose-pre:border prose-pre:border-white/10 max-w-none font-mono text-sm leading-relaxed">
                    <p class="text-[#555] italic">Select a system node to view logs.</p>
                </div>
            </div>
            `;
            
            document.getElementById('gameboard-svg').innerHTML = html;
            window.currentJob = activeJob;
        }

        // --- GENERAL LOGIC ---
        function showTab(tab) {
            ['board', 'gameboard', 'history', 'architecture'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                const btn = document.getElementById(`tab-${t}`);
                btn.classList.remove('border-[#DC2626]', 'text-white');
                btn.classList.add('border-transparent', 'text-[#9CA3AF]');
            });
            
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`tab-${tab}`);
            activeBtn.classList.remove('border-transparent', 'text-[#9CA3AF]');
            activeBtn.classList.add('border-[#DC2626]', 'text-white');

            if (tab === 'history') fetchHistory();
            if (tab === 'architecture') fetchArchitecture();
            if (tab === 'gameboard') fetchGameBoard();
        }

        async function fetchArchitecture() {
            try {
                const res = await fetch(`${API_URL}/architecture`);
                const data = await res.json();
                const content = data.content || 'Arquivo não encontrado.';
                
                const html = `
                    <style>
                        .arch-content { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: #ccc; line-height: 1.8; }
                        .arch-content h1 { color: #fff; font-family: 'Inter', sans-serif; font-weight: 900; font-size: 1.5rem; margin-bottom: 1rem; border-bottom: 1px solid #333; padding-bottom: 0.5rem; }
                        .arch-content h2 { color: #DC2626; font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.1rem; margin-top: 2rem; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em; }
                        .arch-content pre { background: #0a0a0a; padding: 1.5rem; border: 1px solid #222; color: #DC2626; font-size: 0.7rem; overflow-x: auto; margin: 1rem 0; white-space: pre; line-height: 1.3; }
                        .arch-content code { background: #111; color: #fff; padding: 0.15rem 0.3rem; font-size: 0.9em; border-radius: 2px; }
                        .arch-content pre code { background: none; padding: 0; color: inherit; }
                        .arch-content table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.8rem; }
                        .arch-content th { text-align: left; padding: 0.75rem; border-bottom: 1px solid #333; color: #fff; font-weight: 700; text-transform: uppercase; }
                        .arch-content td { padding: 0.75rem; border-bottom: 1px solid #111; }
                        .arch-content strong { color: #fff; }
                        .arch-content hr { border: none; border-top: 1px solid #333; margin: 2rem 0; }
                    </style>
                    <div class="arch-content">${marked.parse(content)}</div>
                `;
                document.getElementById('architecture-content').innerHTML = html;
            } catch (e) {
                document.getElementById('architecture-content').innerHTML = '<div class="text-red-500 font-mono">ERROR LOADING PROTOCOLS</div>';
            }
        }

        async function fetchGameBoard() {
            try {
                const res = await fetch(`${API_URL}/state`);
                const data = await res.json();
                renderGameBoard(data);
            } catch (e) {}
        }

        // Viewers & Modals
        window.showNodeDetails = (stepKey) => {
            const panel = document.getElementById('node-details-panel');
            const title = document.getElementById('detail-title');
            const content = document.getElementById('detail-content');
            
            // Output handling
            if (stepKey === 'output') {
                title.textContent = 'FINAL DELIVERY';
                const opusStep = window.currentJob?.steps?.opus;
                const copyStep = window.currentJob?.steps?.copy;
                
                if (opusStep && opusStep.status === 'done') {
                    let finalContent = "### MISSION ACCOMPLISHED\n\n";
                    if (copyStep && copyStep.output) {
                        try {
                            const jsonMatch = copyStep.output.match(/```json\n([\s\S]*?)\n```/) || copyStep.output.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                const copyData = JSON.parse(jsonMatch[1] || jsonMatch[0]);
                                finalContent += "```json\n" + JSON.stringify(copyData, null, 2) + "\n```";
                            } else {
                                finalContent += copyStep.output;
                            }
                        } catch(e) { finalContent += copyStep.output; }
                    }
                    content.innerHTML = marked.parse(finalContent);
                } else {
                    content.innerHTML = `<div class="py-20 text-center opacity-50 font-mono text-[#555]">AWAITING COMPLETION...</div>`;
                }
                panel.style.transform = 'translateX(0)';
                return;
            }

            // Normal Steps
            const stepData = window.currentJob?.steps?.[stepKey];
            title.textContent = stepKey.toUpperCase().replace('_', ' ');
            
            if (stepData && stepData.output) {
                let rawOutput = stepData.output;
                try {
                    if (typeof rawOutput === 'object' || rawOutput.trim().startsWith('{')) {
                        const parsed = typeof rawOutput === 'string' ? JSON.parse(rawOutput) : rawOutput;
                        content.innerHTML = `<pre class="bg-[#0a0a0a] p-6 border border-[#222] text-[#ccc] text-xs overflow-auto font-mono custom-scrollbar">${JSON.stringify(parsed, null, 2)}</pre>`;
                        panel.style.transform = 'translateX(0)';
                        return;
                    }
                } catch(e) {}
                
                content.innerHTML = marked.parse(rawOutput);
            } else {
                content.innerHTML = `<div class="py-20 text-center opacity-50 font-mono text-[#555]">NO DATA AVAILABLE</div>`;
            }
            panel.style.transform = 'translateX(0)';
        };

        window.closeNodeDetails = () => {
            document.getElementById('node-details-panel').style.transform = 'translateX(100%)';
        };

        // Standard Fetch Logic
        async function fetchState() {
            try {
                const res = await fetch(`${API_URL}/state`);
                const data = await res.json();
                renderColumn('briefing', data.briefing);
                renderColumn('wip', data.wip);
                renderColumn('done', data.done);
                if (!document.getElementById('view-gameboard').classList.contains('hidden')) {
                    renderGameBoard(data);
                }
                document.getElementById('connection-status').textContent = 'ONLINE';
                document.getElementById('connection-status').className = 'text-white';
            } catch (e) {
                document.getElementById('connection-status').textContent = 'OFFLINE';
                document.getElementById('connection-status').className = 'text-[#DC2626] animate-pulse';
            }
        }

        function renderColumn(id, files) {
            const container = document.getElementById(`col-${id}`);
            if (files.length === 0) {
                container.innerHTML = `<div class="text-[#333] text-center font-mono text-xs mt-10 tracking-widest">NO ACTIVE SIGNALS</div>`;
                return;
            }
            
            if (id === 'wip') {
                const groups = {};
                files.forEach(file => {
                    const parts = file.name.split('__');
                    const briefingId = parts.length > 1 ? parts[0] : 'outros';
                    if (!groups[briefingId]) groups[briefingId] = [];
                    groups[briefingId].push(file);
                });
                
                let html = '';
                Object.keys(groups).sort().reverse().forEach(briefingId => {
                    const groupFiles = groups[briefingId];
                    const briefingName = briefingId === 'outros' ? 'Outros' : briefingId.replace(/_/g, ' ');
                    
                    html += `
                        <div class="mb-4 border border-[#333] bg-[#0a0a0a]">
                            <div class="p-4 cursor-pointer flex justify-between items-center group hover:bg-[#111]" onclick="toggleGroup('${briefingId}')">
                                <div>
                                    <span class="text-[#DC2626] text-xs animate-pulse">●</span>
                                    <span class="font-bold text-sm text-[#ccc] ml-2 group-hover:text-white uppercase tracking-tight">${briefingName}</span>
                                </div>
                                <span class="text-[10px] font-mono text-[#555]">${groupFiles.length} NODES</span>
                            </div>
                            <div id="group-${briefingId}" class="hidden border-t border-[#222]">
                                ${groups[briefingId].sort((a,b) => a.name.localeCompare(b.name)).map(file => `
                                    <div class="p-3 pl-8 border-b border-[#1a1a1a] cursor-pointer hover:bg-[#111] hover:text-[#DC2626] transition-colors" onclick="viewFile('wip', '${file.name}')">
                                        <span class="text-[10px] font-mono text-[#777]">└ ${file.name.split('__').pop()}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
                restoreExpandedGroups();
                return;
            }
            
            container.innerHTML = files.map(file => `
                <div class="card p-5 mb-3 cursor-pointer group" onclick="viewFile('${id}', '${file.name}')">
                    <h3 class="font-bold text-sm text-[#ccc] group-hover:text-white truncate font-mono">${file.name}</h3>
                    <p class="text-[10px] text-[#555] mt-2 font-mono uppercase tracking-wide">RAW DATA // ${file.content.length} BYTES</p>
                </div>
            `).join('');
        }

        // Helpers
        const expandedGroups = new Set();
        function toggleGroup(id) {
            const el = document.getElementById('group-' + id);
            if (expandedGroups.has(id)) { expandedGroups.delete(id); el.classList.add('hidden'); }
            else { expandedGroups.add(id); el.classList.remove('hidden'); }
        }
        function restoreExpandedGroups() { expandedGroups.forEach(id => document.getElementById('group-' + id)?.classList.remove('hidden')); }
        
        async function viewFile(cat, fname) {
            const res = await fetch(`${API_URL}/state`);
            const data = await res.json();
            const file = data[cat].find(f => f.name === fname);
            if (!file) return;
            document.getElementById('viewer-title').innerText = fname;
            document.getElementById('viewer-content').innerHTML = marked.parse(file.content);
            openModal('viewer');
        }

        async function submitBriefing() {
            const title = document.getElementById('briefing-title').value;
            const content = document.getElementById('briefing-content').value;
            if (!title || !content) return;
            await fetch(`${API_URL}/briefing`, {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'x-api-key': 'brick-squad-2026' },
                body: JSON.stringify({ title, content })
            });
            closeModal('newBriefing');
            fetchState();
        }

        function openModal(id) { document.getElementById(`modal-${id}`).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(`modal-${id}`).classList.add('hidden'); }

        // History
        async function fetchHistory() {
            try {
                const res = await fetch(`${API_URL}/history`);
                const data = await res.json();
                renderHistory(data.history);
            } catch (e) {}
        }
        function setHistoryMode(mode) {
            historyMode = mode;
            document.getElementById('history-mode-list').className = mode === 'list' ? 'text-[10px] font-mono px-3 py-1 border border-[#DC2626] text-[#DC2626] bg-[#DC2626]/10' : 'text-[10px] font-mono px-3 py-1 border border-[#333] text-[#555] hover:text-white';
            document.getElementById('history-mode-board').className = mode === 'board' ? 'text-[10px] font-mono px-3 py-1 border border-[#DC2626] text-[#DC2626] bg-[#DC2626]/10' : 'text-[10px] font-mono px-3 py-1 border border-[#333] text-[#555] hover:text-white';
            renderHistory(historyData);
        }
        function renderHistory(files) {
            historyData = files;
            const container = document.getElementById('history-list');
            if (!files.length) { container.innerHTML = `<div class="text-[#333] text-center font-mono text-xs mt-10">ARCHIVE EMPTY</div>`; return; }
            
            const groups = {};
            files.forEach(file => {
                const nameParts = file.name.replace(/^\d{4}-\d{2}-\d{2}_/, '').split('__');
                const briefingId = nameParts.length > 1 ? nameParts[0] : file.name.split('_').slice(0, -1).join('_') || 'outros';
                if (!groups[briefingId]) groups[briefingId] = [];
                groups[briefingId].push(file);
            });

            let html = '<div class="space-y-4">';
            Object.keys(groups).forEach(bid => {
                const gFiles = groups[bid];
                html += `<div class="border border-[#333] bg-[#0a0a0a] p-4 cursor-pointer hover:border-[#DC2626] transition-colors group" onclick="viewBriefingFull('${bid}')">`;
                html += `<div class="flex justify-between items-center mb-2"><span class="font-bold text-[#ccc] group-hover:text-white uppercase tracking-tight">${bid.replace(/_/g, ' ')}</span><span class="text-[10px] font-mono text-[#555]">${gFiles.length} LOGS</span></div>`;
                if (historyMode === 'board') {
                    const agents = ['01', '02', '03', '04', '05', '06', '07', '08'];
                    html += '<div class="font-mono text-[10px]"><span class="text-[#333] mr-2">STATUS:</span>';
                    agents.forEach(num => {
                        html += gFiles.some(f => f.name.includes(num)) ? '<span class="text-[#DC2626]">█</span>' : '<span class="text-[#222]">░</span>';
                    });
                    html += '</div>';
                }
                html += '</div>';
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        async function viewBriefingFull(briefingId) {
            const res = await fetch(`${API_URL}/history`);
            const data = await res.json();
            const files = data.history.filter(f => f.name.includes(briefingId));
            if (!files.length) return;
            files.sort((a,b) => a.name.localeCompare(b.name));
            let full = `# MISSION LOG: ${briefingId.toUpperCase()}\n\n---\n\n`;
            files.forEach(f => full += f.content + '\n\n---\n\n');
            document.getElementById('viewer-title').innerText = briefingId;
            document.getElementById('viewer-content').innerHTML = marked.parse(full);
            openModal('viewer');
        }

        // Init
        setInterval(fetchState, 5000);
        fetchState();
        showTab('board');
    </script>
</body>
</html>