<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRICK AI // WAR ROOM</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23000'/><text x='50' y='75' font-size='70' text-anchor='middle' fill='%23DC2626' font-family='monospace' font-weight='bold'>B</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --brick-red: #DC2626; --brick-black: #000; --brick-white: #FFF; --brick-gray: #111; }
        body { background-color: var(--brick-black); color: var(--brick-white); font-family: 'Inter', sans-serif; overflow: hidden; margin: 0; height: 100vh; }
        .font-brick { font-family: 'Inter', sans-serif; font-weight: 900; letter-spacing: -0.05em; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* THE FAVORITE BACKGROUND */
        .grid-bg {
            position: fixed; inset: 0;
            background-image:
                radial-gradient(circle at 50% 50%, rgba(220, 38, 38, 0.12) 0%, transparent 60%),
                linear-gradient(rgba(255, 255, 255, 0.015) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.015) 1px, transparent 1px);
            background-size: 100% 100%, 50px 50px, 50px 50px;
            pointer-events: none; z-index: -1;
        }
        .vignette {
            position: fixed; inset: 0;
            background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.85) 100%);
            pointer-events: none; z-index: -1;
        }

        /* NODE STYLING (MATCHING IMAGE) */
        .node {
            position: absolute !important; width: 320px;
            background: rgba(5, 5, 5, 0.9); border: 1px solid #222;
            padding: 24px; cursor: move; z-index: 10;
            transition: border-color 0.3s;
        }
        .node:hover { border-color: #444; }
        .node.node-douglas { border: 1px solid var(--brick-red); box-shadow: 0 0 20px rgba(220, 38, 38, 0.2); }
        .node.disabled { opacity: 0.3; filter: grayscale(1); }

        .node-led { position: absolute; top: 10px; right: 10px; width: 4px; height: 4px; background: var(--brick-red); border-radius: 50%; box-shadow: 0 0 8px var(--brick-red); }
        .disabled .node-led { background: #333; box-shadow: none; }
        .node[data-provider="openai"] { border-left: 2px solid #10a37f; }
        .node[data-provider="openai"] .node-led { background: #10a37f; box-shadow: 0 0 8px #10a37f; }
        .node[data-provider="openai"] .node-subtext { color: #10a37f; }
        .node[data-provider="gemini-flash"] { border-left: 2px solid #4285f4; }
        .node[data-provider="gemini-flash"] .node-led { background: #4285f4; box-shadow: 0 0 8px #4285f4; }
        .node[data-provider="gemini-flash"] .node-subtext { color: #4285f4; }
        .node[data-provider="gemini-pro"] { border-left: 2px solid #00bcd4; }
        .node[data-provider="gemini-pro"] .node-led { background: #00bcd4; box-shadow: 0 0 8px #00bcd4; }
        .node[data-provider="gemini-pro"] .node-subtext { color: #00bcd4; }
        .node[data-provider="sonnet"] { border-left: 2px solid #d97706; }
        .node[data-provider="sonnet"] .node-led { background: #d97706; box-shadow: 0 0 8px #d97706; }
        .node[data-provider="sonnet"] .node-subtext { color: #d97706; }
        .node[data-provider="opus"] { border-left: 2px solid #9333ea; }
        .node[data-provider="opus"] .node-led { background: #9333ea; box-shadow: 0 0 8px #9333ea; }
        .node[data-provider="opus"] .node-subtext { color: #9333ea; }
        .node[data-provider="human"] { border-left: 2px solid #fff; }
        .node[data-provider="human"] .node-led { background: #fff; box-shadow: 0 0 8px #fff; }
        .node[data-provider="human"] .node-subtext { color: #fff; }
        .disabled[data-provider] { border-left-color: #222 !important; }
        .disabled[data-provider] .node-subtext { color: #333 !important; }

        .node-id { font-family: 'JetBrains Mono'; font-size: 8px; color: #444; margin-bottom: 8px; letter-spacing: 0.1em; }
        .node-title { font-family: 'Inter'; font-weight: 900; font-size: 18px; color: #fff; text-transform: uppercase; letter-spacing: -0.02em; line-height: 1.2; }
        .node-subtext { font-family: 'JetBrains Mono'; font-size: 8px; color: #444; margin-top: 12px; text-transform: uppercase; letter-spacing: 0.1em; border-top: 1px solid #111; padding-top: 12px; }

        /* ANGULAR CONNECTIONS */
        .conn-line { fill: none; stroke: var(--brick-red); stroke-width: 1; opacity: 0.2; }
        .conn-line.active { opacity: 0.6; stroke-width: 1.5; }

        .pulse-dot { fill: var(--brick-red); filter: drop-shadow(0 0 3px var(--brick-red)); }

        /* SIDE PANEL */
        .side-panel { position: fixed; top: 0; right: -500px; width: 450px; height: 100vh; background: #050505; border-left: 1px solid #222; z-index: 250; transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .side-panel.open { right: 0; }

        /* INTERFACE ELEMENTS */
        .btn-brick { background: var(--brick-red); color: #fff; font-family: 'Inter'; font-weight: 900; font-size: 11px; padding: 8px 16px; text-transform: uppercase; letter-spacing: 0.1em; transition: all 0.2s; }
        .btn-brick:hover { background: #fff; color: #000; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #222; }

        #view-nodegraphic { display: none; }
        #view-nodegraphic.active { display: block; }

        /* MARKDOWN STYLING IN PANEL */
        #panel-body h1 { font-size: 20px; font-weight: 900; color: #fff; margin: 24px 0 12px; text-transform: uppercase; line-height: 1.3; }
        #panel-body h2 { font-size: 16px; font-weight: 700; color: #DC2626; margin: 20px 0 12px; text-transform: uppercase; line-height: 1.3; }
        #panel-body h3 { font-size: 14px; font-weight: 600; color: #888; margin: 16px 0 10px; line-height: 1.4; }
        #panel-body p { margin: 12px 0; line-height: 1.7; color: #aaa; font-size: 14px; }
        #panel-body ul, #panel-body ol { margin: 12px 0; padding-left: 24px; color: #aaa; }
        #panel-body li { margin: 8px 0; font-size: 14px; line-height: 1.6; }
        #panel-body code { background: #0a0a0a; padding: 2px 6px; border-radius: 3px; color: #DC2626; font-size: 12px; }
        #panel-body pre { background: #0a0a0a; border: 1px solid #222; padding: 12px; border-radius: 4px; overflow-x: auto; margin: 12px 0; font-size: 13px; line-height: 1.5; }
        #panel-body pre code { background: transparent; padding: 0; }
        #panel-body strong { color: #fff; font-weight: 700; }
        #panel-body em { color: #DC2626; font-style: italic; }
        #panel-body blockquote { border-left: 2px solid #DC2626; padding-left: 16px; margin: 12px 0; color: #666; font-style: italic; font-size: 14px; line-height: 1.6; }
    </style>
</head>
<body>
    <div class="grid-bg"></div>
    <div class="vignette"></div>

    <!-- MAIN INTERFACE -->
    <div id="main-ui" class="h-screen flex flex-col p-8">
        <header class="flex justify-between items-start mb-12 border-b border-white/5 pb-8 relative z-50">
            <div>
                <h1 class="text-3xl font-brick text-white uppercase tracking-tighter">
                    BRICK AI <span id="header-sector" class="text-[#DC2626] text-sm font-mono tracking-[0.5em] ml-4">COMMAND_CENTER</span>
                </h1>
                <div id="connection-status" class="text-[9px] font-mono text-green-500 mt-2 uppercase tracking-widest">System_Active</div>
            </div>
            <div class="flex gap-4 items-center">
                <button id="btn-back-lobby" onclick="goHome()" class="hidden text-[#444] hover:text-white font-mono text-[10px] uppercase tracking-widest border border-[#222] px-4 py-2">‚Üê Sectors</button>
                <button id="btn-scheme" onclick="openScheme()" class="hidden text-[#666] hover:text-white font-mono text-[10px] uppercase tracking-widest border border-[#222] px-4 py-2 hover:border-[#444]">‚óà Scheme</button>
                <div id="layout-indicator" class="hidden text-[10px] font-mono text-green-500/60 tracking-widest">
                    <span id="saved-positions-count">0</span> POSI√á√ïES SALVAS
                </div>
                <button id="btn-clear-layout" onclick="clearLayoutQuick()" class="hidden text-[#666] hover:text-[#DC2626] font-mono text-[9px] uppercase tracking-widest px-3 py-2 hover:underline" title="Limpar TODAS as posi√ß√µes salvas e resetar layout">‚úï Limpar</button>
                <button id="btn-reset-layout" onclick="resetLayout()" class="hidden text-[#444] hover:text-[#DC2626] font-mono text-[10px] uppercase tracking-widest border border-[#222] px-4 py-2 hover:border-[#DC2626]">‚ü≤ Reset</button>
                <button onclick="openNewBriefing()" class="btn-brick">+ New_Briefing</button>
            </div>
        </header>

        <!-- WELCOME -->
        <div id="welcome-screen" class="flex-1 flex items-center justify-center">
            <div class="w-full max-w-6xl">
                <div class="text-center mb-10 -mt-6">
                    <h1 class="text-6xl font-brick text-white uppercase tracking-tighter">Brick <span class="text-[#DC2626]">War</span> Room</h1>
                    <p class="text-sm font-mono text-[#666] uppercase tracking-[0.3em] mt-3">Creation Center</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full">
                <div onclick="enterMode('marketing')" class="group cursor-pointer border border-[#111] bg-[#050505] p-12 hover:border-[#DC2626] transition-all">
                    <div class="text-[9px] font-mono text-[#444] mb-8">SEC // 01</div>
                    <h3 class="text-3xl font-brick text-white mb-4 uppercase group-hover:text-[#DC2626]">Marketing</h3>
                    <p class="text-[#444] font-mono text-xs uppercase">Content & Flow</p>
                </div>
                <div onclick="enterMode('projetos')" class="group cursor-pointer border border-[#111] bg-[#050505] p-12 hover:border-[#DC2626] transition-all">
                    <div class="text-[9px] font-mono text-[#444] mb-8">SEC // 02</div>
                    <h3 class="text-3xl font-brick text-white mb-4 uppercase group-hover:text-[#DC2626]">Projetos</h3>
                    <p class="text-[#444] font-mono text-xs uppercase">Strategy & Craft</p>
                </div>
                <div onclick="enterMode('ideias')" class="group cursor-pointer border border-[#111] bg-[#050505] p-12 hover:border-[#DC2626] transition-all">
                    <div class="text-[9px] font-mono text-[#444] mb-8">SEC // 03</div>
                    <h3 class="text-3xl font-brick text-white mb-4 uppercase group-hover:text-[#DC2626]">Ideias</h3>
                    <p class="text-[#444] font-mono text-xs uppercase">Validation</p>
                </div>
            </div>
            </div>
        </div>

        <!-- LOBBY -->
        <div id="project-lobby" class="hidden flex-1 overflow-y-auto pr-4">
            <div id="lobby-approved" class="mb-16">
                <h2 class="text-lg font-brick text-green-500 uppercase mb-6 tracking-wider flex items-center gap-3">
                    <span class="text-2xl">‚úì</span> APROVADOS
                </h2>
                <div id="lobby-approved-list" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
            </div>
            <div id="lobby-active">
                <h2 class="text-lg font-brick text-[#DC2626] uppercase mb-6 tracking-wider flex items-center gap-3">
                    <span class="text-2xl">‚óè</span> EM ANDAMENTO
                </h2>
                <div id="lobby-active-list" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
            </div>
        </div>
    </div>

    <!-- THE FAVORITE WAR ROOM (NODE GRAPHIC) -->
    <div id="view-nodegraphic" class="fixed inset-0 z-[100]">
        <header class="fixed top-0 left-0 w-full flex justify-between items-start p-8 border-b border-white/5 bg-black/80 backdrop-blur-md z-[110]">
            <div>
                <h1 class="text-3xl font-brick text-white uppercase tracking-tighter">
                    BRICK AI <span id="ng-sector-title" class="text-[#DC2626] text-sm font-mono tracking-[0.5em] ml-4">MARKETING</span>
                </h1>
                <div class="text-[9px] font-mono text-[#DC2626] mt-2 tracking-widest uppercase">
                    Mason Protocol v5.0 // <span id="ng-title" class="text-white">PROJECT_TITLE</span>
                </div>
            </div>
            <div class="flex gap-4">
                <button onclick="closeNodeGraphic()" class="text-[#444] hover:text-white font-mono text-[10px] border border-[#222] px-4 py-2 uppercase tracking-widest">‚Üê Back_To_Lobby</button>
                <button onclick="rerunJob()" class="text-[#666] hover:text-[#DC2626] font-mono text-[10px] uppercase tracking-widest border border-[#222] px-4 py-2 hover:border-[#DC2626]">‚Üª Re-run</button>
                <button onclick="openScheme()" class="text-[#666] hover:text-white font-mono text-[10px] uppercase tracking-widest border border-[#222] px-4 py-2 hover:border-[#444]">‚óà Scheme</button>
                <button onclick="openNewBriefing()" class="btn-brick">+ New_Briefing</button>
            </div>
        </header>

        <div id="canvas-container" class="relative w-full h-full overflow-auto cursor-grab active:cursor-grabbing">
            <svg id="conn-svg" class="absolute inset-0 w-full h-[3000px] pointer-events-none"></svg>
            <div id="node-container" class="relative w-full h-[3000px]"></div>
        </div>

        <!-- TELEMETRY -->
        <div class="fixed bottom-10 left-10 w-80 bg-black/90 border border-[#111] p-4 z-[120] font-mono text-[9px]">
            <div class="flex justify-between text-[#444] mb-3 border-b border-[#111] pb-2">
                <span class="uppercase tracking-wider">TELEMETRY</span>
                <span id="telemetry-status" class="text-green-500">ACTIVE</span>
            </div>
            <div id="telemetry-data" class="space-y-2 text-[10px]">
                <div class="flex justify-between">
                    <span class="text-[#666]">AGENTS:</span>
                    <span id="tel-agents" class="text-[#DC2626]">--</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-[#666]">DURATION:</span>
                    <span id="tel-duration" class="text-[#DC2626]">--</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-[#666]">FILES:</span>
                    <span id="tel-files" class="text-[#DC2626]">--</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-[#666]">STATUS:</span>
                    <span id="tel-stage" class="text-[#DC2626]">--</span>
                </div>
            </div>
        </div>
    </div>

    <!-- AGENT PANEL -->
    <div id="agent-panel" class="side-panel">
        <div class="p-10 border-b border-[#111] flex justify-between items-center">
            <h2 id="panel-title" class="text-2xl font-brick text-white uppercase">AGENTE</h2>
            <button onclick="closePanel()" class="text-[#444] hover:text-white font-mono text-[10px]">CLOSE_</button>
        </div>
        <div id="panel-body" class="p-10 overflow-y-auto h-[calc(100vh-150px)] font-mono text-[11px] text-[#888]"></div>
    </div>

    <!-- SCHEME MODAL -->
    <div id="scheme-modal" class="fixed inset-0 z-[300] bg-black/90 hidden backdrop-blur-sm flex items-center justify-center p-4" onclick="if(event.target.id === 'scheme-modal') closeScheme()">
        <div class="bg-[#050505] border border-[#222] w-full max-w-3xl max-h-[90vh] flex flex-col relative shadow-2xl shadow-red-900/10" onclick="event.stopPropagation()">
            <div class="p-8 border-b border-[#222] flex-shrink-0">
                <button onclick="closeScheme()" class="absolute top-4 right-4 text-[#444] hover:text-white font-mono text-xl z-10">√ó</button>
                <h2 class="text-2xl font-brick text-white uppercase">PIPELINE_SCHEME // <span id="scheme-mode-title" class="text-[#DC2626]">MARKETING</span></h2>
            </div>

            <div class="flex-1 overflow-y-auto p-8">
                <div class="bg-[#0a0a0a] border border-[#222] p-6 font-mono text-xs text-[#888] overflow-x-auto mb-6">
                    <pre id="scheme-diagram" class="leading-relaxed"></pre>
                </div>

                <div class="text-[10px] font-mono text-[#444] border-t border-[#222] pt-4 mt-4">
                    <div class="mb-2 text-[#666]">PROTOCOL_INFO:</div>
                    <div id="scheme-info"></div>
                </div>
            </div>

            <div class="p-4 border-t border-[#222] flex justify-end flex-shrink-0">
                <button onclick="closeScheme()" class="text-[#666] hover:text-white font-mono text-xs uppercase tracking-widest px-4 py-2 border border-[#222] hover:border-[#444]">CLOSE</button>
            </div>
        </div>
    </div>

    <!-- FEEDBACK MODAL -->
    <div id="feedback-modal" class="fixed inset-0 z-[300] bg-black/90 hidden backdrop-blur-sm flex items-center justify-center p-4" onclick="if(event.target.id === 'feedback-modal') closeFeedbackModal()">
        <div class="bg-[#050505] border border-[#222] w-full max-w-2xl flex flex-col relative shadow-2xl shadow-red-900/10" onclick="event.stopPropagation()">
            <div class="p-8 border-b border-[#222]">
                <button onclick="closeFeedbackModal()" class="absolute top-4 right-4 text-[#444] hover:text-white font-mono text-xl z-10">√ó</button>
                <h2 class="text-2xl font-brick text-white uppercase">FEEDBACK DE REVIS√ÉO</h2>
                <div class="text-[10px] font-mono text-[#666] mt-2 uppercase tracking-wider">Explique o que precisa ser ajustado</div>
            </div>

            <div class="p-8">
                <textarea
                    id="feedback-text"
                    class="w-full bg-[#0a0a0a] border border-[#222] text-white p-4 font-mono text-sm h-48 focus:border-[#DC2626] outline-none resize-none"
                    placeholder="Exemplo: O tom est√° muito t√©cnico. Precisa ser mais acess√≠vel para o p√∫blico-alvo..."
                ></textarea>
            </div>

            <div class="p-6 border-t border-[#222] flex justify-end gap-4">
                <button onclick="closeFeedbackModal()" class="text-[#666] hover:text-white font-mono text-xs uppercase tracking-widest px-6 py-3 border border-[#222] hover:border-[#444]">CANCELAR</button>
                <button onclick="submitFeedback()" class="btn-brick px-6 py-3">ENVIAR FEEDBACK</button>
            </div>
        </div>
    </div>

    <!-- BRIEFING MODAL -->
    <div id="briefing-modal" class="fixed inset-0 z-[300] bg-black/90 hidden backdrop-blur-sm flex items-center justify-center p-4" onclick="if(event.target.id === 'briefing-modal') closeBriefingModal()">
        <div class="bg-[#050505] border border-[#DC2626] w-full max-w-2xl flex flex-col relative shadow-2xl shadow-red-900/30" onclick="event.stopPropagation()">
            <div class="p-8 border-b border-[#222]">
                <button onclick="closeBriefingModal()" class="absolute top-4 right-4 text-[#444] hover:text-white font-mono text-xl z-10">√ó</button>
                <h2 class="text-2xl font-brick text-white uppercase">NOVO BRIEFING</h2>
                <div class="text-[10px] font-mono text-[#DC2626] mt-2 uppercase tracking-wider">Crie um novo projeto para o pipeline</div>
            </div>

            <div class="p-8 space-y-6">
                <div>
                    <label class="block text-[10px] font-mono text-[#666] uppercase tracking-wider mb-2">MODO</label>
                    <select id="briefing-mode" onchange="updateCostEstimate()" class="w-full bg-[#0a0a0a] border border-[#222] text-white p-3 font-mono text-sm focus:border-[#DC2626] outline-none">
                        <option value="marketing">Marketing (Conte√∫do & Flow)</option>
                        <option value="projetos">Projetos (Strategy & Craft)</option>
                        <option value="ideias">Ideias (Validation)</option>
                    </select>
                    <div id="cost-estimate" class="mt-2 text-[10px] font-mono text-[#666] flex items-center gap-2">
                        <span class="text-[#DC2626]">üí∞</span>
                        <span>Custo estimado: <span id="cost-value" class="text-green-500">$--</span></span>
                        <span class="text-[#444]">|</span>
                        <span>Etapas: <span id="steps-value" class="text-white">--</span></span>
                    </div>
                </div>
                
                <div>
                    <label class="block text-[10px] font-mono text-[#666] uppercase tracking-wider mb-2">T√çTULO *</label>
                    <input 
                        type="text"
                        id="briefing-title"
                        class="w-full bg-[#0a0a0a] border border-[#222] text-white p-3 font-mono text-sm focus:border-[#DC2626] outline-none"
                        placeholder="Ex: Lan√ßamento Brick AI 2026"
                    >
                </div>
                
                <div>
                    <label class="block text-[10px] font-mono text-[#666] uppercase tracking-wider mb-2">DESCRI√á√ÉO *</label>
                    <textarea
                        id="briefing-content"
                        class="w-full bg-[#0a0a0a] border border-[#222] text-white p-4 font-mono text-sm h-40 focus:border-[#DC2626] outline-none resize-none"
                        placeholder="Descreva o projeto, objetivo, p√∫blico-alvo, restri√ß√µes..."></textarea>
                </div>
            </div>

            <div class="p-6 border-t border-[#222] flex justify-end gap-4">
                <button onclick="closeBriefingModal()" class="text-[#666] hover:text-white font-mono text-xs uppercase tracking-widest px-6 py-3 border border-[#222] hover:border-[#444]">CANCELAR</button>
                <button onclick="submitBriefing()" class="btn-brick px-6 py-3">CRIAR BRIEFING</button>
            </div>
        </div>
    </div>

    <!-- APPROVAL MODAL -->
    <div id="approval-modal" class="fixed inset-0 z-[300] bg-black/90 hidden backdrop-blur-sm flex items-center justify-center p-4" onclick="if(event.target.id === 'approval-modal') closeApprovalModal()">
        <div class="bg-[#050505] border border-[#DC2626] w-full max-w-xl flex flex-col relative shadow-2xl shadow-red-900/30" onclick="event.stopPropagation()">
            <div class="p-8 border-b border-[#222]">
                <button onclick="closeApprovalModal()" class="absolute top-4 right-4 text-[#444] hover:text-white font-mono text-xl z-10">√ó</button>
                <h2 class="text-2xl font-brick text-white uppercase">APROVAR CAMPANHA</h2>
                <div class="text-[10px] font-mono text-[#DC2626] mt-2 uppercase tracking-wider">Confirme para liberar para execu√ß√£o</div>
            </div>

            <div class="p-8">
                <div class="bg-[#0a0a0a] border border-[#222] p-6 space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-[#666] font-mono">PROJETO:</span>
                        <span id="approval-project" class="text-white font-semibold">--</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-[#666] font-mono">SCORE FINAL:</span>
                        <span id="approval-score" class="text-green-500 font-mono font-bold">--/100</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-[#666] font-mono">APROVADO POR:</span>
                        <span id="approval-model" class="text-[#DC2626] font-mono">--</span>
                    </div>
                </div>

                <div class="mt-6 text-xs text-[#666] font-mono leading-relaxed">
                    Ao aprovar, voc√™ confirma que revisou o conte√∫do e autoriza a execu√ß√£o da campanha conforme planejado.
                </div>
            </div>

            <div class="p-6 border-t border-[#222] flex justify-end gap-4">
                <button onclick="closeApprovalModal()" class="text-[#666] hover:text-white font-mono text-xs uppercase tracking-widest px-6 py-3 border border-[#222] hover:border-[#444]">CANCELAR</button>
                <button onclick="confirmApproval()" class="bg-green-600 hover:bg-green-500 text-white font-mono text-xs uppercase tracking-widest px-6 py-3 font-bold">‚úì APROVAR</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let currentState = null;
        let currentMode = null;
        let selectedJobId = null;
        let refreshInterval = null;

        const nodeDefMarketing = [
            { id: 'n0', x: 0, y: 150, title: 'BRIEFING_INPUT', label: 'Ingestion', model: 'RAW INPUT' },
            { id: 'nd', x: 0, y: 350, title: 'DOUGLAS', label: 'Orchestrator', model: 'CORE', douglas: true },
            { id: 'n1', x: 0, y: 550, title: 'VALIDATOR', label: 'Brief_Validator', model: 'GEMINI FLASH' },
            { id: 'n2', x: -260, y: 750, title: 'AUDIENCE', label: 'Audience_Analyst', model: 'GEMINI FLASH' },
            { id: 'n3', x: 260, y: 750, title: 'RESEARCH', label: 'Topic_Researcher', model: 'GEMINI FLASH' },
            { id: 'n4', x: 0, y: 950, title: 'FACT_CHECK', label: 'Claims_Checker', model: 'GEMINI FLASH' },
            { id: 'n5a', x: -350, y: 1150, title: 'COPY_A', label: 'Creative_Alpha', model: 'GPT-5.2' },
            { id: 'n5b', x: 0, y: 1150, title: 'COPY_B', label: 'Creative_Beta', model: 'GEMINI FLASH' },
            { id: 'n5c', x: 350, y: 1150, title: 'COPY_C', label: 'Creative_Gamma', model: 'CLAUDE SONNET' },
            { id: 'n6', x: 0, y: 1350, title: 'BRAND', label: 'Brand_Guardian', model: 'GEMINI FLASH' },
            { id: 'n7', x: 0, y: 1550, title: 'CRITICS', label: 'Judge_Squad', model: 'GPT-5.2' },
            { id: 'n8', x: 0, y: 1800, title: 'WALL', label: 'Final_Filter', model: 'CLAUDE OPUS' },
            { id: 'n9', x: 0, y: 2050, title: 'HUMAN', label: 'User_Control', model: 'APPROVAL', human: true },
            { id: 'n10', x: 0, y: 2300, title: 'OUTPUT', label: 'Final_Ready', model: 'READY' }
        ];
        const linksMarketing = [['n0','nd'],['nd','n1'],['n1','n2'],['n1','n3'],['n2','n4'],['n3','n4'],['n4','n5a'],['n4','n5b'],['n4','n5c'],['n5a','n6'],['n5b','n6'],['n5c','n6'],['n6','n7'],['n7','n8'],['n8','n9'],['n9','n10']];

        const nodeDefProjetos = [
            { id: 'p0', x: 0, y: 150, title: 'BRIEFING_INPUT', label: 'Ingestion', model: 'RAW INPUT' },
            { id: 'pd', x: 0, y: 350, title: 'DOUGLAS', label: 'Orchestrator', model: 'CORE', douglas: true },
            { id: 'p1', x: 0, y: 550, title: 'BRAND_DIGEST', label: 'Brand_Extractor', model: 'GEMINI FLASH' },
            { id: 'p2a', x: -180, y: 750, title: 'IDEATION_GPT', label: 'Concept_A', model: 'GPT' },
            { id: 'p2b', x: 0, y: 750, title: 'IDEATION_FLASH', label: 'Concept_B', model: 'GEMINI FLASH' },
            { id: 'p2c', x: 180, y: 750, title: 'IDEATION_SONNET', label: 'Concept_C', model: 'CLAUDE SONNET' },
            { id: 'p3', x: 0, y: 950, title: 'CONCEPT_CRITIC', label: 'Concept_Judge', model: 'GEMINI PRO' },
            { id: 'p4', x: 0, y: 1150, title: 'EXECUTION_DESIGN', label: 'Visual_Director', model: 'GEMINI PRO' },
            { id: 'p5', x: 0, y: 1350, title: 'COPYWRITER', label: 'Script_Writer', model: 'GPT 5.2' },
            { id: 'p6', x: 0, y: 1550, title: 'DIRECTOR', label: 'Execution_Judge', model: 'GEMINI PRO' },
            { id: 'p9', x: 0, y: 1750, title: 'HUMAN', label: 'User_Control', model: 'APPROVAL', human: true },
            { id: 'p10', x: 0, y: 1950, title: 'OUTPUT', label: 'Final_Ready', model: 'READY' }
        ];
        const linksProjetos = [['p0','pd'],['pd','p1'],['p1','p2a'],['p1','p2b'],['p1','p2c'],['p2a','p3'],['p2b','p3'],['p2c','p3'],['p3','p4'],['p4','p5'],['p5','p6'],['p6','p9'],['p9','p10']];

        const nodeDefIdeias = [
            { id: 'i0', x: 0, y: 150, title: 'RAW_IDEA', label: 'Ingestion', model: 'INPUT' },
            { id: 'id', x: 0, y: 350, title: 'DOUGLAS', label: 'Orchestrator', model: 'CORE', douglas: true },
            { id: 'i1', x: 0, y: 550, title: 'PAIN_CHECK', label: 'Validation', model: 'GEMINI FLASH' },
            { id: 'i2', x: 0, y: 750, title: 'MARKET_SCAN', label: 'Research', model: 'GEMINI FLASH' },
            { id: 'i3a', x: -140, y: 950, title: 'ANGLE_GEN', label: 'Angel', model: 'CLAUDE SONNET' },
            { id: 'i3b', x: 140, y: 950, title: 'DEVIL_GEN', label: 'Devil', model: 'CLAUDE SONNET' },
            { id: 'i4', x: 0, y: 1150, title: 'VIABILITY', label: 'Supreme_Judge', model: 'CLAUDE OPUS' },
            { id: 'i5', x: 0, y: 1350, title: 'DECISION', label: 'User_Control', model: 'APPROVAL', human: true }
        ];
        const linksIdeias = [['i0','id'],['id','i1'],['i1','i2'],['i2','i3a'],['i2','i3b'],['i3a','i4'],['i3b','i4'],['i4','i5']];

        const fileMapping = {
            'BRIEFING_INPUT': ['BRIEFING_INPUT', 'lan_amento'],
            'DOUGLAS': ['PROCESSED'],
            'VALIDATOR': ['01_', 'VALIDATOR'],
            'AUDIENCE': ['02_', 'AUDIENCE'],
            'RESEARCH': ['03_', 'RESEARCH'],
            'FACT_CHECK': ['04_', 'CLAIMS', 'FACT_CHECK'],
            'COPY_A': ['05A_', 'COPY_GPT', 'COPY_A'],
            'COPY_B': ['05B_', 'COPY_FLASH', 'COPY_B'],
            'COPY_C': ['05C_', 'COPY_SONNET', 'COPY_C'],
            'BRAND': ['06_', 'BRAND'],
            'CRITICS': ['07_', 'CRITIC'],
            'DIRECTOR': ['DIRECTOR'],
            'WALL': ['08_', 'FILTRO', 'WALL'],
            'HUMAN': ['FINAL', 'READY'],
            'OUTPUT': ['FINAL', 'READY'],
            'BRAND_DIGEST': ['BRAND_DIGEST'],
            'IDEATION_GPT': ['IDEATION_GPT', 'CREATIVE_IDEATION_GPT'],
            'IDEATION_FLASH': ['IDEATION_FLASH', 'CREATIVE_IDEATION_FLASH'],
            'IDEATION_SONNET': ['IDEATION_SONNET', 'CREATIVE_IDEATION_SONNET', 'CREATIVE_IDEATION'],
            'CONCEPT_CRITIC': ['CONCEPT_CRITIC'],
            'EXECUTION_DESIGN': ['EXECUTION_DESIGN'],
            'COPYWRITER': ['COPYWRITER'],
            'RAW_IDEA': ['RAW_IDEA', 'IDEA_INPUT', 'IDEIA'],
            'PAIN_CHECK': ['PAIN_CHECK', 'VALIDATION'],
            'MARKET_SCAN': ['MARKET_SCAN', 'MARKET'],
            'ANGLE_GEN': ['ANGLE_GEN', 'ANGLE'],
            'DEVIL_GEN': ['DEVIL_GEN', 'DEVIL'],
            'VIABILITY': ['VIABILITY', 'SCORE'],
            'DECISION': ['DECISION', 'HUMAN']
        };

        async function fetchState() {
            try {
                const res = await fetch(`${API_URL}/state${currentMode ? '?mode='+currentMode : ''}`);
                currentState = await res.json();
                renderLobby();
                if(selectedJobId) renderNodeGraphic();
            } catch(e) {}
        }

        function enterMode(mode) {
            currentMode = mode;
            localStorage.setItem('last_mode', mode);
            if (mode) window.location.hash = mode;
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('project-lobby').classList.remove('hidden');
            document.getElementById('btn-back-lobby').classList.remove('hidden');
            document.getElementById('btn-scheme').classList.remove('hidden');
            document.getElementById('header-sector').textContent = mode.toUpperCase();
            fetchState();
            // Auto-refresh a cada 10 segundos
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(fetchState, 10000);
        }

        function goHome() {
            currentMode = null;
            localStorage.removeItem('last_mode');
            history.replaceState(null, '', window.location.pathname);
            if (refreshInterval) { clearInterval(refreshInterval); refreshInterval = null; }
            document.getElementById('welcome-screen').classList.remove('hidden');
            document.getElementById('project-lobby').classList.add('hidden');
            document.getElementById('btn-back-lobby').classList.add('hidden');
            document.getElementById('btn-scheme').classList.add('hidden');
            document.getElementById('header-sector').textContent = 'COMMAND_CENTER';
        }

        function openScheme() {
            const modal = document.getElementById('scheme-modal');
            const title = document.getElementById('scheme-mode-title');
            const diagram = document.getElementById('scheme-diagram');
            const info = document.getElementById('scheme-info');

            title.textContent = (currentMode || 'MARKETING').toUpperCase();

            if (currentMode === 'ideias') {
                diagram.textContent = `RAW IDEA
‚îÇ
‚ñº
00. DOUGLAS (Orchestrator)
‚îÇ
‚ñº
01. PAIN CHECK (Flash) - Valida√ß√£o da dor
‚îÇ
‚ñº
02. MARKET SCAN (Flash) - Refer√™ncias/Mercado
‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚ñº              ‚ñº
03a. ANGLE GEN    03b. DEVIL GEN
(Sonnet/Angel)    (Sonnet/Devil)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚ñº
04. VIABILITY (Opus) - Juiz de Viabilidade
‚îÇ
‚ñº
05. DECISION (Human) - Go / No-Go`;

                info.innerHTML = `
                    <div>‚Ä¢ Valida√ß√£o ultra-r√°pida de conceitos</div>
                    <div>‚Ä¢ Problem Scoping para evitar ideias sem demanda</div>
                    <div>‚Ä¢ An√°lise de concorr√™ncia autom√°tica</div>
                    <div>‚Ä¢ Angel vs Devil: √¢ngulos criativos em paralelo</div>
                    <div>‚Ä¢ Score final de viabilidade pelo Opus (juiz imparcial)</div>
                `;
            } else if (currentMode === 'projetos') {
                diagram.textContent = `BRIEFING
‚îÇ
‚ñº
00. DOUGLAS (Pr√©-processador) - l√™ PDFs/imagens/anexos
‚îÇ
‚ñº
01. BRAND DIGEST (Flash) - extrai DNA/tom/assets
‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚ñº                ‚ñº                ‚ñº
02a. IDEATION    02b. IDEATION    02c. IDEATION
(GPT)            (Flash)          (Sonnet)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚ñº
03. CONCEPT CRITIC (Gemini Pro) - escolhe melhor
‚îÇ
‚ñº
04. EXECUTION DESIGN (Gemini Pro) - dire√ß√£o visual
‚îÇ
‚ñº
05. COPYWRITER (GPT 5.2) - roteiro com constraints
‚îÇ
‚ñº
06. DIRECTOR (Gemini Pro) - avalia execu√ß√£o (loop at√© ‚â•85)
‚îÇ
‚ñº
07. HUMAN - aprova√ß√£o final
‚îÇ
‚ñº
OUTPUT (Proposta Completa)`;

                info.innerHTML = `
                    <div>‚Ä¢ Douglas pr√©-processa anexos (PDFs, imagens)</div>
                    <div>‚Ä¢ Brand Digest extrai DNA da marca</div>
                    <div>‚Ä¢ 3 conceitos criativos paralelos</div>
                    <div>‚Ä¢ Critic escolhe o melhor conceito</div>
                    <div>‚Ä¢ Director loop at√© score ‚â•85</div>
                    <div>‚Ä¢ Aprova√ß√£o humana obrigat√≥ria</div>
                `;
            } else {
                diagram.textContent = `BRIEFING
‚îÇ
‚ñº
00. DOUGLAS (Pr√©-processador) - l√™ PDFs/imagens/anexos
‚îÇ
‚ñº
01. BRIEF VALIDATOR (Flash)
‚îÇ
‚ñº
02. AUDIENCE ‚ïê‚ïê‚ñ∫ 03. RESEARCHER (Flash)
‚îÇ
‚ñº
04. CLAIMS CHECKER (Flash)
‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚ñº          ‚ñº          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇCOPY A  ‚îÇ ‚îÇCOPY B  ‚îÇ ‚îÇCOPY C  ‚îÇ
‚îÇGPT-5.2 ‚îÇ ‚îÇ FLASH  ‚îÇ ‚îÇSONNET  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ          ‚îÇ          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚ñº
06. BRAND GUARDIANS (Flash) - valida as 3
‚îÇ
‚ñº
07. CRITICS (Opus) - escolhem a melhor
‚îÇ
‚ñº
08. WALL (Opus) - score final
‚îÇ
‚îú‚îÄ‚ñ∫ (SE score < 80) ‚Üí volta COPYWRITER (05)
‚îÇ
‚ñº (score ‚â• 80)
09. HUMAN - aprova√ß√£o final
‚îÇ
‚ñº
OUTPUT (Copy Final)`;

                info.innerHTML = `
                    <div>‚Ä¢ Douglas pr√©-processa anexos (PDFs, imagens)</div>
                    <div>‚Ä¢ Valida√ß√£o autom√°tica em cada n√≥</div>
                    <div>‚Ä¢ Tr√™s vers√µes criativas paralelas (A/B/C)</div>
                    <div>‚Ä¢ Brand Guardians valida todas as vers√µes</div>
                    <div>‚Ä¢ Critics escolhem a melhor</div>
                    <div>‚Ä¢ <strong class="text-green-400">Director √© CONDICIONAL</strong> - s√≥ executa se Critics sugerirem ajustes</div>
                    <div>‚Ä¢ Wall (Opus) score final: ‚â•80 passa, &lt;80 volta p/ Copywriter ou Director</div>
                    <div>‚Ä¢ Loop inteligente: m√°ximo 3 tentativas antes de escalar pra humano</div>
                    <div>‚Ä¢ Aprova√ß√£o humana obrigat√≥ria</div>
                `;
            }

            modal.classList.remove('hidden');
        }

        function closeScheme() {
            document.getElementById('scheme-modal').classList.add('hidden');
        }

        function extractTitle(files) {
            // Procura por BRIEFING_INPUT, PROCESSED ou RAW_IDEA (Ideias)
            const briefingFile = files.find(f => 
                f.name.includes('BRIEFING_INPUT') || 
                f.name.includes('PROCESSED') || 
                f.name.includes('RAW_IDEA')
            );
            
            // Fallback: qualquer arquivo com conte√∫do que comece com # BRIEFING:
            const fallbackFile = !briefingFile ? files.find(f => 
                f.content && /^#\s*BRIEFING:/m.test(f.content)
            ) : null;
            
            const targetFile = briefingFile || fallbackFile;
            if (!targetFile || !targetFile.content) return null;

            // Extrai t√≠tulo da primeira linha markdown
            // Suporta: # BRIEFING: X, # BRIEFING PROCESSADO: X, # RAW IDEA: X
            const match = targetFile.content.match(/^#\s*(?:BRIEFING:|BRIEFING PROCESSADO:|RAW IDEA:)?\s*(.+)$/m);
            return match ? match[1].trim() : null;
        }

        function renderLobby() {
            const activeList = document.getElementById('lobby-active-list');
            const approvedList = document.getElementById('lobby-approved-list');
            activeList.innerHTML = '';
            approvedList.innerHTML = '';
            
            // Separar projetos em andamento (briefing + wip) vs aprovados (done)
            const wipFiles = [...currentState.briefing, ...currentState.wip];
            const doneFiles = [...currentState.done];
            
            const wipGroups = {};
            const doneGroups = {};
            
            function getProjectId(name) {
                // Marketing: ids num√©ricos
                const m = name.match(/^(\d{13,})/);
                if (m) return m[1];

                // Projetos/Ideias: usar prefixo antes do √∫ltimo "_ROLE"
                // Ex: 180_seguros_2026_BRAND_DIGEST.md -> 180_seguros_2026
                // Ex: roteirizacao_set_PAIN_CHECK.json -> roteirizacao_set
                const roleSuffixes = [
                    // Projetos
                    'BRAND_DIGEST','CREATIVE_IDEATION','IDEATION_GPT','IDEATION_FLASH','IDEATION_SONNET','CONCEPT_CRITIC','EXECUTION_DESIGN',
                    'COPYWRITER','DIRECTOR','FINAL','PROCESSED','BRIEFING_INPUT',
                    // Ideias
                    'PAIN_CHECK','MARKET_SCAN','ANGLE_GEN','DEVIL_GEN','VIABILITY','DECISION','RAW_IDEA'
                ];
                for (const role of roleSuffixes) {
                    const idx = name.indexOf(`_${role}`);
                    if (idx > 0) return name.slice(0, idx);
                }

                // Fallback: antes de __ ou antes da extens√£o
                if (name.includes('__')) return name.split('__')[0];
                return name.replace(/\.[^.]+$/, '');
            }

            wipFiles.forEach(f => {
                const id = getProjectId(f.name);
                if(!wipGroups[id]) wipGroups[id] = []; wipGroups[id].push(f);
            });
            
            doneFiles.forEach(f => {
                const id = getProjectId(f.name);
                if(!doneGroups[id]) doneGroups[id] = []; doneGroups[id].push(f);
            });

            // Renderizar projetos aprovados (verde)
            Object.keys(doneGroups).sort().reverse().forEach(id => {
                const files = doneGroups[id];
                const extractedTitle = extractTitle(files);
                const title = extractedTitle || id.replace(/_/g, ' ');

                const card = document.createElement('div');
                card.className = 'border border-green-600 bg-[#050505] p-8 cursor-pointer hover:border-green-400 transition-all';
                card.onclick = () => openNodeGraphic(id, title);
                card.innerHTML = `
                    <div class="text-[9px] font-mono text-[#444] mb-6">PROJ // ${id.substring(0,8)}</div>
                    <h3 class="text-2xl font-brick text-white uppercase mb-4">${title}</h3>
                    <div class="text-[9px] font-mono text-green-500 tracking-widest flex items-center gap-2">
                        <span>‚úì</span> APROVADO
                    </div>
                `;
                approvedList.appendChild(card);
            });
            
            // Renderizar projetos em andamento (vermelho) - excluir os que j√° est√£o em done/aprovados
            Object.keys(wipGroups).filter(id => !doneGroups[id]).sort().reverse().forEach(id => {
                const files = wipGroups[id];
                const extractedTitle = extractTitle(files);
                const title = extractedTitle || id.replace(/_/g, ' ');

                const card = document.createElement('div');
                card.className = 'border border-[#111] bg-[#050505] p-8 cursor-pointer hover:border-[#DC2626] transition-all';
                card.onclick = () => openNodeGraphic(id, title);
                card.innerHTML = `
                    <div class="text-[9px] font-mono text-[#444] mb-6">PROJ // ${id.substring(0,8)}</div>
                    <h3 class="text-2xl font-brick text-white uppercase mb-4">${title}</h3>
                    <div class="text-[9px] font-mono text-[#DC2626] tracking-widest">ACTIVE_NETWORK</div>
                `;
                activeList.appendChild(card);
            });
            
            // Esconder se√ß√µes vazias
            document.getElementById('lobby-approved').style.display = Object.keys(doneGroups).length > 0 ? 'block' : 'none';
            document.getElementById('lobby-active').style.display = Object.keys(wipGroups).length > 0 ? 'block' : 'none';
        }

        function updateTelemetry(projectFiles) {
            const agentsCount = projectFiles.filter(f => !f.name.includes('BRIEFING') && !f.name.includes('PROCESSED') && !f.name.includes('FINAL')).length;
            const filesCount = projectFiles.length;

            // Calcular dura√ß√£o baseado nos timestamps dos arquivos
            const timestamps = projectFiles.map(f => new Date(f.mtime).getTime()).filter(t => !isNaN(t));
            let duration = '--';
            if (timestamps.length > 1) {
                const start = Math.min(...timestamps);
                const end = Math.max(...timestamps);
                const diffMs = end - start;
                const diffSec = Math.floor(diffMs / 1000);
                const diffMin = Math.floor(diffSec / 60);
                duration = diffMin > 0 ? `${diffMin}m ${diffSec % 60}s` : `${diffSec}s`;
            }

            // Detectar est√°gio atual
            const hasFinal = projectFiles.some(f => f.name.includes('FINAL'));
            const stage = hasFinal ? 'READY FOR APPROVAL' : 'PROCESSING';

            document.getElementById('tel-agents').textContent = agentsCount;
            document.getElementById('tel-duration').textContent = duration;
            document.getElementById('tel-files').textContent = filesCount;
            document.getElementById('tel-stage').textContent = stage;
            document.getElementById('telemetry-status').textContent = hasFinal ? 'COMPLETE' : 'ACTIVE';
            document.getElementById('telemetry-status').className = hasFinal ? 'text-green-500' : 'text-yellow-500 animate-pulse';
        }

        function openNodeGraphic(id, title) {
            selectedJobId = id;
            document.getElementById('ng-title').textContent = title;
            document.getElementById('ng-sector-title').textContent = currentMode.toUpperCase();
            document.getElementById('view-nodegraphic').classList.add('active');
            document.getElementById('main-ui').style.display = 'none';
            document.getElementById('btn-reset-layout').classList.remove('hidden');
            document.getElementById('btn-clear-layout').classList.remove('hidden');
            document.getElementById('layout-indicator').classList.remove('hidden');
            updateLayoutIndicator();
            renderNodeGraphic();
        }

        function updateLayoutIndicator() {
            const savedPositions = JSON.parse(localStorage.getItem(`node_positions_${currentMode}`) || '{}');
            const count = Object.keys(savedPositions).length;
            document.getElementById('saved-positions-count').textContent = count;
            
            // Mostrar/esconder bot√£o de limpeza baseado se tem posi√ß√µes salvas
            const clearBtn = document.getElementById('btn-clear-layout');
            if (clearBtn) {
                if (count > 0) {
                    clearBtn.classList.remove('hidden');
                } else {
                    clearBtn.classList.add('hidden');
                }
            }
        }

        function closeNodeGraphic() {
            document.getElementById('view-nodegraphic').classList.remove('active');
            document.getElementById('main-ui').style.display = 'flex';
            document.getElementById('btn-reset-layout').classList.add('hidden');
            document.getElementById('btn-clear-layout').classList.add('hidden');
            document.getElementById('layout-indicator').classList.add('hidden');
            selectedJobId = null;
        }

        function resetLayout() {
            // Custom modal ao inv√©s de browser confirm
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[300]';
            modal.innerHTML = `
                <div class="bg-[#050505] border border-[#DC2626] p-8 max-w-md">
                    <h3 class="font-brick text-xl text-white uppercase mb-4">‚ö†Ô∏è RESETAR LAYOUT</h3>
                    <p class="text-sm text-[#aaa] mb-6 leading-relaxed">
                        Isso vai <strong class="text-[#DC2626]">apagar todas as posi√ß√µes salvas</strong> dos n√≥s do modo <strong class="text-white">${currentMode.toUpperCase()}</strong> e restaurar o layout padr√£o.
                    </p>
                    <p class="text-sm text-[#666] mb-6 italic">
                        Essa a√ß√£o n√£o pode ser desfeita.
                    </p>
                    <div class="flex gap-3">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 border border-[#333] text-[#aaa] font-mono text-xs py-2 px-4 hover:border-white hover:text-white transition-colors">
                            CANCELAR
                        </button>
                        <button onclick="confirmResetLayout(); this.closest('.fixed').remove();" class="flex-1 bg-[#DC2626] text-white font-mono text-xs py-2 px-4 hover:bg-white hover:text-black transition-colors">
                            CONFIRMAR RESET
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function confirmResetLayout() {
            localStorage.removeItem(`node_positions_${currentMode}`);
            updateLayoutIndicator();
            renderNodeGraphic();
        }

        function clearLayoutQuick() {
            // Limpar SEM confirma√ß√£o (r√°pido)
            localStorage.removeItem(`node_positions_${currentMode}`);
            updateLayoutIndicator();
            renderNodeGraphic();
            
            // Feedback visual: toast r√°pido
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-8 right-8 bg-[#DC2626] text-white px-6 py-3 font-mono text-xs uppercase tracking-wider z-[300]';
            toast.textContent = `‚úì Layout ${currentMode} resetado`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        function renderNodeGraphic() {
            const container = document.getElementById('node-container');
            const svg = document.getElementById('conn-svg');
            const allFiles = [...currentState.briefing, ...currentState.wip, ...currentState.done];
            const projectFiles = allFiles.filter(f => f.name.toLowerCase().includes(selectedJobId.toLowerCase()));

            container.innerHTML = '';
            svg.innerHTML = '';

            let nodes = nodeDefMarketing;
            if (currentMode === 'projetos') nodes = nodeDefProjetos;
            if (currentMode === 'ideias') nodes = nodeDefIdeias;

            // Carregar posi√ß√µes salvas do localStorage
            let savedPositions = JSON.parse(localStorage.getItem(`node_positions_${currentMode}`) || '{}');
            
            // VALIDA√á√ÉO DE EMERG√äNCIA: Detectar e limpar posi√ß√µes malucas
            let hasInvalidPositions = false;
            for (const [nodeId, pos] of Object.entries(savedPositions)) {
                // Extrair valores num√©ricos (remover "px")
                const leftVal = parseInt(pos.left);
                const topVal = parseInt(pos.top);
                
                // Se valores s√£o absurdos ou inv√°lidos, marcar pra limpeza
                if (isNaN(leftVal) || isNaN(topVal) || 
                    leftVal < -1000 || leftVal > 10000 || 
                    topVal < -1000 || topVal > 10000 ||
                    pos.left.includes('calc')) {
                    console.warn(`Posi√ß√£o inv√°lida detectada para ${nodeId}:`, pos);
                    hasInvalidPositions = true;
                }
            }
            
            // Se detectou posi√ß√µes inv√°lidas, LIMPAR TUDO
            if (hasInvalidPositions) {
                console.warn('‚ö†Ô∏è Posi√ß√µes malucas detectadas! Limpando localStorage automaticamente...');
                localStorage.removeItem(`node_positions_${currentMode}`);
                savedPositions = {}; // Resetar pra objeto vazio
                
                // Toast de emerg√™ncia
                const toast = document.createElement('div');
                toast.className = 'fixed top-8 left-1/2 transform -translate-x-1/2 bg-yellow-600 text-black px-6 py-3 font-mono text-xs uppercase tracking-wider z-[300] border-2 border-yellow-400';
                toast.innerHTML = '‚ö†Ô∏è Posi√ß√µes inv√°lidas detectadas e removidas automaticamente';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);
            }
            
            // Calcular centro da tela UMA VEZ (antes do loop)
            const centerX = container.offsetWidth / 2;
            
            nodes.forEach(n => {
                const el = document.createElement('div');
                const providerMap = {
                    'GPT': 'openai', 'GPT 5.2': 'openai', 'GPT-5.2': 'openai', 'GPT-4O': 'openai',
                    'GEMINI FLASH': 'gemini-flash', 'FLASH': 'gemini-flash',
                    'GEMINI PRO': 'gemini-pro', 'GEMINI 3 PRO': 'gemini-pro',
                    'CLAUDE SONNET': 'sonnet', 'SONNET': 'sonnet',
                    'CLAUDE OPUS': 'opus', 'OPUS': 'opus',
                    'APPROVAL': 'human'
                };
                const provider = providerMap[n.model] || '';
                el.className = `node ${n.douglas?'node-douglas':''}`;
                if (provider) el.setAttribute('data-provider', provider);
                el.id = n.id;
                el.style.position = 'absolute';
                
                // Se tem posi√ß√£o salva E √© v√°lida, usar ela
                if (savedPositions[n.id] && savedPositions[n.id].left && savedPositions[n.id].top) {
                    // Garantir que sejam strings com "px"
                    el.style.left = savedPositions[n.id].left;
                    el.style.top = savedPositions[n.id].top;
                } else {
                    // Usar posi√ß√£o padr√£o (SEMPRE em pixels puros, nunca calc)
                    const defaultLeft = centerX + n.x - 160; // 160 = metade da largura do n√≥ (320/2)
                    el.style.left = `${defaultLeft}px`;
                    el.style.top = `${n.y}px`;
                }
                el.style.transform = 'none';

                const searchTerms = fileMapping[n.title] || [n.title];
                const hasFile = projectFiles.some(f => searchTerms.some(term => f.name.toUpperCase().includes(term.toUpperCase())));
                // N√£o desabilitar: BRIEFING_INPUT (n0), Douglas, e nodes humanos (DECISION etc)
                // Nodes humanos ficam ativos quando o pipeline chegou neles (node anterior tem arquivo)
                if(!hasFile && !n.douglas && !n.human && n.id !== 'n0') el.classList.add('disabled');

                el.innerHTML = `
                    <div class="node-led"></div>
                    <div class="node-id">${n.id.toUpperCase()} // ${n.label}</div>
                    <div class="node-title">${n.title}</div>
                    <div class="node-subtext">${n.model || 'PROCESSING'}</div>
                    ${n.human ? `
                        <div class="flex gap-2 mt-4 pt-4 border-t border-[#111]">
                            <button onclick="aprovarCampanha(event)" class="flex-1 bg-white text-black font-brick text-[9px] py-2 hover:bg-[#DC2626] hover:text-white transition-colors">APROVAR</button>
                            <button onclick="openFeedbackModal(event)" class="flex-1 border border-[#222] text-[#444] font-brick text-[9px] py-2 hover:border-white hover:text-white transition-colors">REVISAR</button>
                        </div>
                    ` : ''}
                `;
                el.ondblclick = () => openPanel(n, projectFiles);
                container.appendChild(el);
                makeDraggable(el);
            });

            updateConnections();
            updateTelemetry(projectFiles);
        }

        function updateConnections() {
            const svg = document.getElementById('conn-svg');
            svg.innerHTML = '';
            
            let currentLinks = linksMarketing;
            if (currentMode === 'projetos') currentLinks = linksProjetos;
            if (currentMode === 'ideias') currentLinks = linksIdeias;

            currentLinks.forEach(([fId, tId]) => {
                const f = document.getElementById(fId), t = document.getElementById(tId);
                if(!f || !t) return;
                
                const fR = f.getBoundingClientRect(), tR = t.getBoundingClientRect(), cR = document.getElementById('node-container').getBoundingClientRect();
                const x1 = fR.left + fR.width/2 - cR.left, y1 = fR.top + fR.height/2 - cR.top;
                const x2 = tR.left + tR.width/2 - cR.left, y2 = tR.top + tR.height/2 - cR.top;
                
                // Validar que as coordenadas n√£o s√£o absurdas (NaN, Infinity, ou fora da viewport razo√°vel)
                if (isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2) || 
                    !isFinite(x1) || !isFinite(y1) || !isFinite(x2) || !isFinite(y2) ||
                    Math.abs(x1) > 10000 || Math.abs(y1) > 10000 || Math.abs(x2) > 10000 || Math.abs(y2) > 10000) {
                    console.warn(`Coordenadas inv√°lidas detectadas para link ${fId} ‚Üí ${tId}:`, {x1, y1, x2, y2});
                    return;
                }

                const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
                line.setAttribute("d", `M ${x1} ${y1} L ${x1} ${y1 + (y2-y1)/2} L ${x2} ${y1 + (y2-y1)/2} L ${x2} ${y2}`);
                
                const isActive = !f.classList.contains('disabled') && !t.classList.contains('disabled');
                const lineClass = `conn-line ${isActive ? 'active' : ''}`;
                line.setAttribute("class", lineClass);
                svg.appendChild(line);

                if(!f.classList.contains('disabled') && !t.classList.contains('disabled')) {
                    const pulse = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    pulse.setAttribute("r", "2"); pulse.setAttribute("class", "pulse-dot");
                    const anim = document.createElementNS("http://www.w3.org/2000/svg", "animateMotion");
                    anim.setAttribute("path", `M ${x1} ${y1} L ${x1} ${y1 + (y2-y1)/2} L ${x2} ${y1 + (y2-y1)/2} L ${x2} ${y2}`);
                    anim.setAttribute("dur", "3s"); anim.setAttribute("repeatCount", "indefinite");
                    pulse.appendChild(anim); svg.appendChild(pulse);
                }
            });
        }

        function makeDraggable(el) {
            let p1=0,p2=0,p3=0,p4=0; 
            el.onmousedown = (e) => {
                // N√£o arrastar se clicou num bot√£o
                if (e.target.tagName === 'BUTTON') return;
                
                e.preventDefault(); 
                p3=e.clientX; 
                p4=e.clientY;
                el.style.zIndex = '100'; // Trazer pra frente enquanto arrasta
                
                document.onmouseup = () => { 
                    el.style.zIndex = '10'; // Voltar z-index normal
                    
                    // Salvar posi√ß√£o final no localStorage (SEMPRE em pixels puros)
                    const nodePositions = JSON.parse(localStorage.getItem(`node_positions_${currentMode}`) || '{}');
                    
                    // Garantir que sejam valores num√©ricos puros com "px"
                    const finalLeft = el.offsetLeft;
                    const finalTop = el.offsetTop;
                    
                    // Validar que n√£o s√£o valores absurdos (fora da viewport)
                    if (finalLeft < -500 || finalLeft > 5000 || finalTop < -500 || finalTop > 5000) {
                        console.warn(`Posi√ß√£o inv√°lida detectada para ${el.id}: left=${finalLeft}, top=${finalTop}. N√£o salvando.`);
                        el.style.borderColor = '#DC2626'; // Flash vermelho = erro
                        setTimeout(() => { el.style.borderColor = ''; }, 400);
                    } else {
                        nodePositions[el.id] = {
                            left: `${finalLeft}px`,
                            top: `${finalTop}px`
                        };
                        localStorage.setItem(`node_positions_${currentMode}`, JSON.stringify(nodePositions));
                        
                        // Atualizar contador de posi√ß√µes salvas
                        updateLayoutIndicator();
                        
                        // Feedback visual: flash verde = salvou com sucesso
                        el.style.borderColor = '#4ade80';
                        setTimeout(() => { el.style.borderColor = ''; }, 200);
                    }
                    
                    document.onmouseup = null; 
                    document.onmousemove = null; 
                };
                
                document.onmousemove = (e) => {
                    p1=p3-e.clientX; 
                    p2=p4-e.clientY; 
                    p3=e.clientX; 
                    p4=e.clientY;
                    el.style.top = (el.offsetTop-p2)+"px"; 
                    el.style.left = (el.offsetLeft-p1)+"px";
                    updateConnections();
                };
            };
        }

        function formatJSON(json) {
            function formatValue(val, key) {
                if (typeof val === 'boolean') return val ? '<span class="text-green-500">‚úì</span>' : '<span class="text-red-500">‚úó</span>';
                if (typeof val === 'number') {
                    const isScore = key && (key.includes('score') || key.includes('nota') || key.includes('pontos') || key.includes('max'));
                    if (isScore || (val >= 0 && val <= 100)) {
                        const color = val >= 80 ? 'text-green-500' : val >= 60 ? 'text-yellow-500' : 'text-red-500';
                        return `<span class="${color} font-bold">${val}</span>`;
                    }
                    return `<span class="text-white">${val}</span>`;
                }
                if (typeof val === 'string') {
                    // Status badges
                    const statusColors = {
                        'PASS': 'bg-green-900 text-green-400', 'APPROVED': 'bg-green-900 text-green-400',
                        'BRAND_OK': 'bg-green-900 text-green-400', 'GO': 'bg-green-900 text-green-400',
                        'FAIL': 'bg-red-900 text-red-400', 'REJECTED': 'bg-red-900 text-red-400',
                        'BRAND_FAIL': 'bg-red-900 text-red-400', 'NO_GO': 'bg-red-900 text-red-400',
                        'BLOCKED': 'bg-red-900 text-red-400',
                        'APPROVED_WITH_NOTES': 'bg-yellow-900 text-yellow-400',
                        'CONDITIONAL_GO': 'bg-yellow-900 text-yellow-400', 'REVISIT': 'bg-yellow-900 text-yellow-400'
                    };
                    if (statusColors[val]) return `<span class="px-3 py-1 text-xs font-mono font-bold uppercase tracking-wider ${statusColors[val]}">${val.replace(/_/g, ' ')}</span>`;
                    // Long strings ‚Üí render as markdown
                    if (val.length > 200) return `<div class="text-[#ccc] leading-relaxed mt-2 prose-sm">${marked.parse(val)}</div>`;
                    return `<span class="text-[#ccc]">${val}</span>`;
                }
                return val;
            }

            function renderAny(val, key, depth) {
                if (val === null || val === undefined) return '<span class="text-[#666] italic">--</span>';
                if (Array.isArray(val)) {
                    if (val.length === 0) return '<span class="text-[#666] italic">Nenhum</span>';
                    return '<div class="space-y-2 mt-2">' + val.map(item => {
                        if (typeof item === 'object' && item !== null) {
                            return `<div class="border-l-2 border-[#333] pl-4 py-2 space-y-1">${Object.entries(item).map(([k,v]) => 
                                `<div class="text-sm"><span class="text-[#666] font-mono">${k.replace(/_/g,' ')}:</span> ${renderAny(v, k, depth+1)}</div>`
                            ).join('')}</div>`;
                        }
                        return `<div class="text-sm text-[#aaa]">‚Ä¢ ${item}</div>`;
                    }).join('') + '</div>';
                }
                if (typeof val === 'object') {
                    return `<div class="${depth > 0 ? 'pl-4 mt-2' : ''} space-y-3">${Object.entries(val).map(([k,v]) => {
                        const label = k.replace(/_/g, ' ');
                        const rendered = renderAny(v, k, depth+1);
                        return `<div class="text-sm leading-relaxed"><span class="text-[#888] font-mono font-semibold">${label}:</span> ${rendered}</div>`;
                    }).join('')}</div>`;
                }
                return formatValue(val, key);
            }

            let html = '<div class="space-y-6">';
            for (const [key, value] of Object.entries(json)) {
                html += `<div class="border-b border-[#222] pb-5">`;
                html += `<div class="text-sm font-mono text-[#DC2626] uppercase tracking-wider mb-3 font-semibold">${key.replace(/_/g, ' ')}</div>`;
                html += renderAny(value, key, 0);
                html += '</div>';
            }
            html += '</div>';
            return html;
        }

        function openPanel(n, files) {
            const searchTerms = fileMapping[n.title] || [n.title];
            const file = files.find(f => searchTerms.some(term => f.name.toUpperCase().includes(term.toUpperCase())));
            const body = document.getElementById('panel-body');
            
            if (file) {
                let content = file.content;
                const isApproved = localStorage.getItem(`approved_${selectedJobId}`) === 'true';
                
                try {
                    const json = JSON.parse(content);
                    content = formatJSON(json);
                } catch(e) {
                    content = marked.parse(content);
                    // Remover linha "Aguardando aprova√ß√£o" se foi aprovado
                    if (isApproved && (n.title === 'OUTPUT' || n.title === 'HUMAN')) {
                        content = content.replace(/\*\*Aguardando sua aprova√ß√£o para prosseguir\.\*\*/gi, '');
                    }
                }
                
                // Adicionar banner de aprova√ß√£o se foi aprovado
                if (isApproved && (n.title === 'OUTPUT' || n.title === 'HUMAN')) {
                    const approvalBanner = `<div class="bg-green-900/30 border border-green-600 p-4 mb-6 font-mono text-sm text-green-400">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">‚úÖ</span>
                            <div>
                                <div class="font-bold uppercase tracking-wide">CAMPANHA APROVADA</div>
                                <div class="text-xs text-green-500 mt-1">Aprovado em ${new Date(parseInt(localStorage.getItem(`approved_${selectedJobId}_timestamp`))).toLocaleString('pt-BR')}</div>
                            </div>
                        </div>
                    </div>`;
                    content = approvalBanner + content;
                }
                
                body.innerHTML = content;
            } else {
                body.innerHTML = '<div class="p-8 text-center text-[#444] italic">Aguardando execu√ß√£o do agente...</div>';
            }
            
            document.getElementById('panel-title').textContent = n.title;
            document.getElementById('agent-panel').classList.add('open');
        }

        function closePanel() { document.getElementById('agent-panel').classList.remove('open'); }
        
        function openNewBriefing() {
            document.getElementById('briefing-modal').classList.remove('hidden');
            document.getElementById('briefing-title').value = '';
            document.getElementById('briefing-content').value = '';
            document.getElementById('briefing-mode').value = currentMode || 'marketing';
            document.getElementById('briefing-title').focus();
            updateCostEstimate();
        }
        
        async function updateCostEstimate() {
            const mode = document.getElementById('briefing-mode').value;
            try {
                const res = await fetch(`${API_URL}/estimate?mode=${mode}`);
                const data = await res.json();
                document.getElementById('cost-value').textContent = `$${data.totalCost}`;
                document.getElementById('steps-value').textContent = data.steps;
            } catch(e) {
                document.getElementById('cost-value').textContent = '$--';
                document.getElementById('steps-value').textContent = '--';
            }
        }
        
        function closeBriefingModal() {
            document.getElementById('briefing-modal').classList.add('hidden');
        }
        
        async function submitBriefing() {
            const title = document.getElementById('briefing-title').value.trim();
            const content = document.getElementById('briefing-content').value.trim();
            const mode = document.getElementById('briefing-mode').value;
            
            if (!title) {
                showNotification('‚ö†Ô∏è T√≠tulo √© obrigat√≥rio.', 'error');
                return;
            }
            
            if (!content) {
                showNotification('‚ö†Ô∏è Descri√ß√£o √© obrigat√≥ria.', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_URL}/briefing`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-API-Key': 'brick-squad-2026'
                    },
                    body: JSON.stringify({ title, content, mode })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    closeBriefingModal();
                    showNotification(`‚úÖ Briefing "${title}" criado! Douglas ser√° notificado.`);
                    
                    // Atualizar estado
                    setTimeout(() => {
                        if (!currentMode) enterMode(mode);
                        fetchState();
                    }, 500);
                } else {
                    const err = await res.json();
                    showNotification(`‚ùå Erro: ${err.error || 'Falha ao criar briefing'}`, 'error');
                }
            } catch(e) {
                console.error('Erro ao criar briefing:', e);
                showNotification('‚ùå Erro ao criar briefing. Tente novamente.', 'error');
            }
        }

        function openFeedbackModal(e) {
            e.stopPropagation();
            document.getElementById('feedback-modal').classList.remove('hidden');
            document.getElementById('feedback-text').value = '';
            document.getElementById('feedback-text').focus();
        }

        function closeFeedbackModal() {
            document.getElementById('feedback-modal').classList.add('hidden');
        }

        async function submitFeedback() {
            const feedback = document.getElementById('feedback-text').value.trim();
            if (!feedback) {
                showNotification('‚ö†Ô∏è Escreva o feedback antes de enviar.', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/feedback`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-API-Key': 'brick-squad-2026'
                    },
                    body: JSON.stringify({
                        jobId: selectedJobId,
                        mode: currentMode,
                        feedback: feedback,
                        timestamp: new Date().toISOString()
                    })
                });

                if (res.ok) {
                    closeFeedbackModal();
                    showNotification('‚úÖ FEEDBACK ENVIADO! Pipeline ser√° reiniciado.');
                } else {
                    showNotification('‚ùå Erro ao enviar feedback. Tente novamente.', 'error');
                }
            } catch(e) {
                console.error('Erro ao enviar feedback:', e);
                showNotification('‚ùå Erro ao enviar feedback. Tente novamente.', 'error');
            }
        }

        function aprovarCampanha(e) {
            e.stopPropagation();
            const projectTitle = document.getElementById('ng-title').textContent;
            document.getElementById('approval-project').textContent = projectTitle;
            
            // Buscar score real do WALL
            const allFiles = [...currentState.briefing, ...currentState.wip, ...currentState.done];
            const projectFiles = allFiles.filter(f => f.name.toLowerCase().includes(selectedJobId.toLowerCase()));
            const wallFile = projectFiles.find(f => f.name.includes('WALL') || f.name.includes('FILTRO') || f.name.includes('08_'));
            
            let score = '--';
            let model = 'WALL';
            
            if (wallFile) {
                try {
                    const data = JSON.parse(wallFile.content);
                    score = data.score_final || data.score || '--';
                    model = 'CLAUDE OPUS';
                } catch(e) {
                    // Se n√£o conseguir parsear, manter valores default
                }
            }
            
            document.getElementById('approval-score').textContent = `${score}/100`;
            document.getElementById('approval-score').className = score >= 80 
                ? 'text-green-500 font-mono font-bold' 
                : 'text-yellow-500 font-mono font-bold';
            document.getElementById('approval-model').textContent = model;
            
            document.getElementById('approval-modal').classList.remove('hidden');
        }

        function closeApprovalModal() {
            document.getElementById('approval-modal').classList.add('hidden');
        }

        async function confirmApproval() {
            try {
                const res = await fetch(`${API_URL}/approve`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-API-Key': 'brick-squad-2026'
                    },
                    body: JSON.stringify({
                        jobId: selectedJobId,
                        mode: currentMode,
                        timestamp: new Date().toISOString()
                    })
                });

                if (res.ok) {
                    // Salvar aprova√ß√£o no localStorage
                    localStorage.setItem(`approved_${selectedJobId}`, 'true');
                    localStorage.setItem(`approved_${selectedJobId}_timestamp`, Date.now().toString());
                    
                    closeApprovalModal();
                    showNotification('üéâ CAMPANHA APROVADA! Movida para APROVADOS.');
                    
                    // Fechar node graphic e voltar pro lobby
                    closeNodeGraphic();
                    
                    // Atualizar estado (os arquivos foram movidos para done/)
                    setTimeout(() => {
                        fetchState();
                    }, 1000);
                } else {
                    showNotification('‚ùå Erro ao aprovar. Tente novamente.', 'error');
                }
            } catch(e) {
                console.error('Erro ao aprovar:', e);
                showNotification('‚ùå Erro ao aprovar. Tente novamente.', 'error');
            }
        }

        async function rerunJob() {
            if (!confirm('‚ö†Ô∏è Tem certeza? Isso apagar√° todo o progresso atual e reiniciar√° o pipeline do zero.')) return;
            
            try {
                const res = await fetch(`${API_URL}/rerun`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-API-Key': 'brick-squad-2026'
                    },
                    body: JSON.stringify({
                        jobId: selectedJobId,
                        mode: currentMode
                    })
                });

                if (res.ok) {
                    showNotification('üîÑ Job reiniciado! Aguarde o processamento.');
                    // Limpar cache local de posi√ß√µes pra evitar fantasmas? N√£o precisa.
                    fetchState();
                } else {
                    const err = await res.json();
                    showNotification(`‚ùå Erro: ${err.error}`, 'error');
                }
            } catch(e) {
                console.error('Erro ao reiniciar job:', e);
                showNotification('‚ùå Erro de conex√£o.', 'error');
            }
        }

        function showNotification(msg, type = 'success') {
            // Simple notification (can be enhanced later)
            const notification = document.createElement('div');
            notification.className = `fixed top-8 right-8 z-[400] bg-${type === 'error' ? 'red' : 'green'}-600 text-white px-6 py-4 font-mono text-sm border border-${type === 'error' ? 'red' : 'green'}-500 shadow-2xl`;
            notification.textContent = msg;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        // WebSocket connection (com fallback para polling)
        let socket = null;
        let useWebSocket = true;
        
        function initWebSocket() {
            try {
                socket = io();
                
                socket.on('connect', () => {
                    console.log('üîå WebSocket conectado');
                    document.getElementById('connection-status').textContent = 'WebSocket_Active';
                    document.getElementById('connection-status').className = 'text-[9px] font-mono text-green-500 mt-2 uppercase tracking-widest';
                    useWebSocket = true;
                    
                    // Subscrever ao modo atual
                    if (currentMode) {
                        socket.emit('subscribe', currentMode);
                    }
                });
                
                socket.on('stateUpdate', (state) => {
                    if (state.mode === currentMode) {
                        // Buscar conte√∫do completo via API (socket s√≥ envia metadata)
                        fetchState();
                    }
                });
                
                socket.on('disconnect', () => {
                    console.log('üîå WebSocket desconectado, usando polling');
                    document.getElementById('connection-status').textContent = 'Polling_Mode';
                    document.getElementById('connection-status').className = 'text-[9px] font-mono text-yellow-500 mt-2 uppercase tracking-widest';
                    useWebSocket = false;
                });
                
                socket.on('connect_error', () => {
                    console.log('üîå WebSocket erro, usando polling');
                    useWebSocket = false;
                });
                
            } catch(e) {
                console.log('üîå WebSocket n√£o dispon√≠vel, usando polling');
                useWebSocket = false;
            }
        }
        
        // Subscrever quando mudar de modo
        const originalEnterMode = enterMode;
        enterMode = function(mode) {
            originalEnterMode(mode);
            if (socket && socket.connected) {
                socket.emit('subscribe', mode);
            }
        };
        
        window.onload = () => {
            // Limpar posi√ß√µes salvas que podem estar corrompidas
            ['marketing', 'projetos', 'ideias'].forEach(m => localStorage.removeItem(`node_positions_${m}`));
            
            initWebSocket();
            const savedMode = (window.location.hash || '').replace('#','') || localStorage.getItem('last_mode');
            if (savedMode) {
                enterMode(savedMode);
            }
            // Fallback: polling a cada 10s (s√≥ se WebSocket falhar)
            setInterval(() => {
                if (!useWebSocket && currentMode) {
                    fetchState();
                }
            }, 10000);
        };
    </script>
</body>
</html>
